<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/blog/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/blog/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/blog/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/blog/images/logo.svg" color="#222">

<link rel="stylesheet" href="/blog/css/main.css">


<link rel="stylesheet" href="/blog/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"imperial-long.github.io","root":"/blog/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="定期会更新前端技术栈 不限于vue，react，node以及部分后端的知识">
<meta property="og:type" content="website">
<meta property="og:title" content="朱广龙的个人博客">
<meta property="og:url" content="https://imperial-long.github.io/blog/index.html">
<meta property="og:site_name" content="朱广龙的个人博客">
<meta property="og:description" content="定期会更新前端技术栈 不限于vue，react，node以及部分后端的知识">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="朱广龙">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://imperial-long.github.io/blog/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>朱广龙的个人博客</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/blog/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">朱广龙的个人博客</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/blog/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/blog/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://imperial-long.github.io/blog/2024/08/17/zustand%E7%9A%84%E6%9E%81%E7%AE%80%E4%B9%8B%E9%81%93/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="朱广龙">
      <meta itemprop="description" content="定期会更新前端技术栈 不限于vue，react，node以及部分后端的知识">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="朱广龙的个人博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2024/08/17/zustand%E7%9A%84%E6%9E%81%E7%AE%80%E4%B9%8B%E9%81%93/" class="post-title-link" itemprop="url">状态管理</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-08-17 20:39:00" itemprop="dateCreated datePublished" datetime="2024-08-17T20:39:00+08:00">2024-08-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-10-10 13:27:08" itemprop="dateModified" datetime="2024-10-10T13:27:08+08:00">2024-10-10</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h2><p>本文将从<strong>状态管理的核心设计理念出发以及对观察者模式的简单实现</strong>，带领大家一步步探索 Zustand 的核心原理，并通过实际代码展示如何实现一个类似 Zustand 的状态管理库。<br><strong>本文采用面向对象的方式，方便读者更容易理解其背后的设计思路和实现细节</strong></p>
<h2 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h2><ol>
<li>灵活应用<strong>观察者设计模式</strong>，解耦实项目中的数据流和逻辑</li>
<li>掌握 <strong>Zustand 的核心设计理念</strong>，了解其简洁高效的状态管理方法</li>
<li>通过 <strong>TypeScript 编写自定义的 Hooks</strong>，提升代码质量和类型安全性</li>
<li>熟练使用 <strong>TypeScript 的高级类型特性</strong>，优化状态管理逻辑</li>
<li>利用 useSyncExternalStore <strong>优化状态管理的订阅与更新流程</strong></li>
<li>学会使用<strong>usRef防止一些没必要的渲染</strong></li>
<li>学会中间件开发思想</li>
</ol>
<h2 id="观察者设计模式"><a href="#观察者设计模式" class="headerlink" title="观察者设计模式"></a>观察者设计模式</h2><p>在很多前端框架或库中，观察者模式随处可见。Vue、MobX、Promise、React-query 等库都通过观察者模式实现了数据的订阅与更新。观察者模式的核心思想就是 <strong>发布-订阅，即观察者订阅主题对象，当主题发生变化时，通知所有观察者进行相应的操作</strong>。</p>
<p>观察者模式的基本结构：</p>
<ul>
<li>主题（Subject）：负责维护状态并通知观察者。</li>
<li>观察者（Observer）：订阅主题的变化并做出响应</li>
</ul>
<p><img src="https://p0-xtjj-private.juejin.cn/tos-cn-i-73owjymdk6/5a645ea63bba404888871990f5e18b11~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5aW95oi35aSW55qE5YmN56uv:q75.awebp?policy=eyJ2bSI6MywidWlkIjoiMjc1MjgzMjg0ODUzODc4MiJ9&rk3s=f64ab15b&x-orig-authkey=f32326d3454f2ac7e96d3d06cdbb035152127018&x-orig-expires=1729142766&x-orig-sign=QtcqsGjv5ONuT3v0KegUNRWxhys=" alt="image.png"></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 主题对象</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Subject</span>&lt;T&gt; &#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="attr">watchers</span>: <span class="title class_">Set</span>&lt;<span class="title class_">Watcher</span>&lt;T&gt;&gt;;</span><br><span class="line">  <span class="keyword">private</span> <span class="attr">state</span>: T | <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"><span class="attr">state</span>: T</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">watchers</span> = <span class="keyword">new</span> <span class="title class_">Set</span>();</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">state</span> = state || <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 注册观察者</span></span><br><span class="line">  <span class="title function_">register</span>(<span class="params"><span class="attr">watcher</span>: <span class="title class_">Watcher</span>&lt;T&gt;</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">watchers</span>.<span class="title function_">add</span>(watcher);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 移除观察者</span></span><br><span class="line">  <span class="title function_">remove</span>(<span class="params"><span class="attr">watcher</span>: <span class="title class_">Watcher</span>&lt;T&gt;</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">watchers</span>.<span class="title function_">delete</span>(watcher);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 通知所有观察者</span></span><br><span class="line">  <span class="title function_">notify</span>(<span class="params"><span class="attr">newState</span>: T, <span class="attr">oldState</span>: T</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">watchers</span>.<span class="title function_">forEach</span>(<span class="function"><span class="params">watcher</span> =&gt;</span> &#123;</span><br><span class="line">      watcher.<span class="title function_">update</span>(newState, oldState);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 更新数据</span></span><br><span class="line">  <span class="title function_">update</span>(<span class="params"><span class="attr">newState</span>: T</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> oldState = <span class="variable language_">this</span>.<span class="property">state</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">state</span> = newState;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">notify</span>(newState, oldState);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 观察者类</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Watcher</span>&lt;T&gt; &#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="attr">subscribe</span>: <span class="function">(<span class="params"><span class="attr">newVal</span>: T, <span class="attr">oldVal</span>: T</span>) =&gt;</span> <span class="built_in">void</span>;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"><span class="attr">subscribe</span>: (newVal: T, oldVal: T) =&gt; <span class="built_in">void</span></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">subscribe</span> = subscribe;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 更新时执行回调</span></span><br><span class="line">  <span class="title function_">update</span>(<span class="params"><span class="attr">newVal</span>: T, <span class="attr">oldVal</span>: T</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (newVal !== oldVal) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">subscribe</span>(newVal, oldVal);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="从观察者模式到Zustand"><a href="#从观察者模式到Zustand" class="headerlink" title="从观察者模式到Zustand"></a>从观察者模式到Zustand</h2><p>Zustand 的状态管理可以看作是<strong>观察者模式的最佳实践</strong>。它通过 store 持有应用状态，并提供 subscribe 方法供组件订阅变化，从而<strong>将状态管理逻辑和框架层面逻辑进行分离</strong>，<br>为了更好地理解 Zustand 的实现原理，我们通过以下代码进行深度探索。</p>
<h3 id="Zustand-整体逻辑架构图"><a href="#Zustand-整体逻辑架构图" class="headerlink" title="Zustand 整体逻辑架构图"></a>Zustand 整体逻辑架构图</h3><p><img src="https://p0-xtjj-private.juejin.cn/tos-cn-i-73owjymdk6/7f29cfb6772d48fbb9312d6edccb6f57~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5aW95oi35aSW55qE5YmN56uv:q75.awebp?policy=eyJ2bSI6MywidWlkIjoiMjc1MjgzMjg0ODUzODc4MiJ9&rk3s=f64ab15b&x-orig-authkey=f32326d3454f2ac7e96d3d06cdbb035152127018&x-orig-expires=1729142766&x-orig-sign=fVU2PQS2xEcocexkxFJ+OGuu+qA=" alt="image-1.png"></p>
<ul>
<li>Store: 核心状态管理对象</li>
<li>Subject: 当状态改变时通知所有订阅者</li>
<li>Watcher: 观察并监听状态变化</li>
<li>useStore: React 组件与 Zustand 交互的桥梁</li>
</ul>
<h4 id="实现-Store"><a href="#实现-Store" class="headerlink" title="实现 Store"></a>实现 Store</h4><p>Store 是状态管理的核心，它持有应用的状态，并通过 setState 方法来更新状态。<strong>当状态发生变化时，所有注册的观察者都会收到通知</strong>，并执行相应的操作</p>
<ul>
<li>state: 当前状态</li>
<li>getState: 获取当前状态</li>
<li>setState: 修改改变状态</li>
<li>subscribe: 创建一个观察者 并监听状态变化</li>
<li></li>
</ul>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Store</span>&lt;T&gt; &#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="attr">subject</span>: <span class="title class_">Subject</span>&lt;T&gt;;</span><br><span class="line">  <span class="attr">state</span>: T;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"><span class="attr">state</span>: T</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">subject</span> = <span class="keyword">new</span> <span class="title class_">Subject</span>&lt;T&gt;(state);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">state</span> = state;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">getState</span>(): T &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">state</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">setState</span>(<span class="attr">partial</span>: <span class="title class_">Partial</span>&lt;T&gt;, <span class="attr">replace</span>: <span class="built_in">boolean</span> = <span class="literal">false</span>): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> oldState = <span class="variable language_">this</span>.<span class="property">state</span>;</span><br><span class="line">    <span class="keyword">const</span> newState = <span class="keyword">typeof</span> partial === <span class="string">&#x27;function&#x27;</span> ? (partial <span class="keyword">as</span> <span class="title class_">Function</span>)(<span class="variable language_">this</span>.<span class="property">state</span>) : partial;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title class_">Object</span>.<span class="title function_">is</span>(newState, oldState)) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (replace) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">state</span> = newState <span class="keyword">as</span> T;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">state</span> = &#123; ...oldState, ...newState &#125; <span class="keyword">as</span> T;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">subject</span>.<span class="title function_">update</span>(<span class="variable language_">this</span>.<span class="property">state</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">subscribe</span>(<span class="attr">callback</span>: <span class="function">(<span class="params"><span class="attr">newState</span>: T, <span class="attr">oldState</span>: T</span>) =&gt;</span> <span class="built_in">void</span>): <span class="function">() =&gt;</span> <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> watcher = <span class="keyword">new</span> <span class="title class_">Watcher</span>&lt;T&gt;(callback);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">subject</span>.<span class="title function_">register</span>(watcher);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">subject</span>.<span class="title function_">remove</span>(watcher);</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="实现createStore"><a href="#实现createStore" class="headerlink" title="实现createStore"></a>实现createStore</h4><p>createStore 函数负责创建 store 实例并提供给其他外界组件库使用的</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> createStore&lt;T&gt;(callback) &#123;</span><br><span class="line"> <span class="keyword">const</span> store = <span class="keyword">new</span> <span class="title class_">Store</span>&lt;T&gt;();</span><br><span class="line"> store.<span class="property">state</span> = <span class="title function_">callback</span>(store.<span class="property">setState</span>, store.<span class="property">getState</span>, store.<span class="property">subscribe</span>, store.<span class="property">removeState</span>);</span><br><span class="line"><span class="keyword">return</span> (selector?): <span class="title class_">ReturnType</span>&lt;<span class="keyword">typeof</span> selector&gt; =&gt;  &#123;</span><br><span class="line">   <span class="keyword">return</span> <span class="title function_">useStore</span>(store, selector);</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="useStore"><a href="#useStore" class="headerlink" title="useStore"></a>useStore</h4><h5 id="实现一-useSyncExternalStore"><a href="#实现一-useSyncExternalStore" class="headerlink" title="实现一  useSyncExternalStore"></a>实现一  useSyncExternalStore</h5><p><strong>useStore是react与zustand之间的桥梁</strong>。通过订阅 store 的变化，组件在状态更新时可以自动重新渲染</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> useStore&lt;T&gt;(<span class="attr">store</span>: <span class="title class_">Store</span>&lt;T&gt;): T;</span><br><span class="line"><span class="keyword">function</span> useStore&lt;T&gt;(<span class="attr">store</span>: <span class="title class_">Store</span>&lt;T&gt;, selector) : <span class="title class_">ReturnType</span>&lt;<span class="keyword">typeof</span> selector&gt;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> useStore&lt;T&gt;(<span class="attr">store</span>: <span class="title class_">Store</span>&lt;T&gt;, selector?: <span class="built_in">unknown</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">getSnapshot</span> = (<span class="params"></span>) =&gt; ( <span class="keyword">typeof</span> selector === <span class="string">&#x27;function&#x27;</span> ? <span class="title function_">selector</span>(store.<span class="title function_">getState</span>()) : store.<span class="title function_">getState</span>());</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">useSyncExternalStore</span>(</span><br><span class="line">    store.<span class="property">subscribe</span>, <span class="comment">// 订阅函数</span></span><br><span class="line">    getSnapshot,                 <span class="comment">// 返回当前状态</span></span><br><span class="line">    getSnapshot                  <span class="comment">// 在服务器渲染中使用相同的快照</span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="实现二-useState"><a href="#实现二-useState" class="headerlink" title="实现二 useState"></a>实现二 useState</h5><p>在并发渲染模式下，React 的状态订阅需要更加精确地控制。<strong>不能确保状态的一致性，解决潜在的状态读取滞后问题</strong>，特别是在** React 的并发模式和服务器端渲染（SSR**）中</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> useStore&lt;T&gt;(<span class="attr">store</span>: <span class="title class_">Store</span>&lt;T&gt;, selector?: <span class="built_in">unknown</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> state = <span class="title function_">useRef</span>();</span><br><span class="line">  <span class="keyword">const</span> selectorFnRef = <span class="title function_">useRef</span>(selector);</span><br><span class="line">  <span class="keyword">const</span> selectorFn = selectorFnRef.<span class="property">current</span>;</span><br><span class="line">  <span class="keyword">const</span> [_,forceUpdate] = <span class="title function_">useState</span>(&#123;&#125;);</span><br><span class="line"></span><br><span class="line">  store.<span class="title function_">subscribe</span>(<span class="function">(<span class="params">newState, oldState</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> selectorFn === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> newValue = <span class="title function_">selectorFn</span>(newState)</span><br><span class="line">      <span class="keyword">const</span> oldValue = <span class="title function_">selectorFn</span>(oldState);</span><br><span class="line">      <span class="keyword">if</span> (newValue !== oldValue) &#123;</span><br><span class="line">        state.<span class="property">current</span> = newValue;</span><br><span class="line">        <span class="title function_">forceUpdate</span>(&#123;&#125;)</span><br><span class="line">      &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    state.<span class="property">current</span> = newState</span><br><span class="line">     <span class="title function_">forceUpdate</span>(&#123;&#125;)</span><br><span class="line">  &#125;</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> state.<span class="property">current</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h1 id="结束语"><a href="#结束语" class="headerlink" title="结束语"></a>结束语</h1><p>通过本文的介绍，<strong>我们实现了一个基于观察者模式的状态管理系统，并且探讨了 zustand 底层设计的核心思想</strong>。zustand 之所以广受欢迎，正是因为它<strong>简洁的 API 和轻量的设计，避免了不必要的复杂度</strong>，非常适合中小型 React 项目的状态管理需求。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://imperial-long.github.io/blog/2024/04/18/beginwork%E6%A0%B8%E5%BF%83%E6%B5%81%E7%A8%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="朱广龙">
      <meta itemprop="description" content="定期会更新前端技术栈 不限于vue，react，node以及部分后端的知识">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="朱广龙的个人博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2024/04/18/beginwork%E6%A0%B8%E5%BF%83%E6%B5%81%E7%A8%8B/" class="post-title-link" itemprop="url">beginwork核心流程</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-04-18 20:39:00" itemprop="dateCreated datePublished" datetime="2024-04-18T20:39:00+08:00">2024-04-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-10-10 13:24:56" itemprop="dateModified" datetime="2024-10-10T13:24:56+08:00">2024-10-10</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h1><p>1、react更新逻辑是从roo开始的，那么是如何找到发生更新的组件呢？</p>
<p>2、fiber进行beginWork一定会render吗？beiginWork和render的关系是怎么样的呢</p>
<p>3、beginwork的更新流程为什么是从组件开始的？</p>
<p>4、childLans的作用是什么？</p>
<h2 id="state改变是组件更新的唯一条件"><a href="#state改变是组件更新的唯一条件" class="headerlink" title="state改变是组件更新的唯一条件"></a>state改变是组件更新的唯一条件</h2><p>在当前react版本，视图的更新来源于组件内部 state 的改变。如果想要更新视图，那么只有以下操作方式</p>
<ul>
<li><p>组件自身的state发生改变 </p>
<ul>
<li>函数组件：useState或者 useReducer</li>
<li>类组件：setState或者forceUpdate</li>
<li>父组件更新导致的更新</li>
<li>Provider祖先组件的state发生改变，当前组件使用了useContext或者消费了context，</li>
</ul>
</li>
</ul>
<p>无论是上述哪种方式更新，本质上都是state的改变</p>
<p>state改变是在组件对应的 fiber上的，在react中存在多种多样的fiber类型，但是在react体系中只有 函数式组件 和类组件 才能进行改变state，从而影响调和，比如hostComponet（html原生标签）是无法进行独立的更新的，只能依赖于父组件的state进行更新，但是在调和阶段，他也会作为一个任务但愿进入到workLoop</p>
<p>fiber是调和过程中的最小单元，每一个需要调和的 fiber 都会进入 workLoop 中</p>
<p>组件是最小的更新单元，React 的更新源于数据层 state 的变化</p>
<h2 id="beiginWork是fiber更新的入口"><a href="#beiginWork是fiber更新的入口" class="headerlink" title="beiginWork是fiber更新的入口"></a>beiginWork是fiber更新的入口</h2><p>我们一起深入来研究一下组件类型的fiber，类组件&#x2F;函数式组件在 render 阶段的一个重要作用就是产生新的 子fiber节点 ，也就是我们常说的 rerender。接下来才能使用深度优先遍历算法遍历fiber 从而改变视图。每一个需要调和的 fiber 都要经历一个过程叫做 beginWork ，在 beginWork 流程中将执行上述各种 fiber 的更新函数</p>
<p>组件类型 fiber 进入到 workLoop 中，那么一定会 rerender 吗,答案是否定的</p>
<p>我们一起来看看下列几种情况</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">Child1Props</span> &#123;</span><br><span class="line">  count?: <span class="built_in">number</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Child</span>: <span class="variable constant_">FC</span>&lt;<span class="title class_">Child1Props</span>&gt; = <span class="function">(<span class="params">&#123;count&#125;</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">span</span>&gt;</span>我是子组件1<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">span</span>&gt;</span>来自父组件的数量为&#123;count&#125;<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/&gt;</span></span></span><br><span class="line">    );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">Child2Props</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Child</span>: <span class="variable constant_">FC</span>&lt;<span class="title class_">Child2Props</span>&gt; = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">   <span class="keyword">const</span> [count , setCount] = useState&lt;<span class="built_in">number</span>&gt;(<span class="number">0</span>);</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">onClick</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">      <span class="title function_">setCount</span>(count++);</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;&gt;</span></span></span><br><span class="line"><span class="language-xml">     <span class="tag">&lt;<span class="name">span</span>&gt;</span>子组件2自己内部的数量为&#123;count&#125;<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">     <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;onClick&#125;</span>&gt;</span>子组件2按钮<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/&gt;</span></span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">ParentProps</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Parent</span>: <span class="variable constant_">FC</span>&lt;<span class="title class_">ParentProps</span>&gt;()&#123;</span><br><span class="line">    <span class="keyword">const</span> [count , setCount] = useState&lt;<span class="built_in">number</span>&gt;(<span class="number">0</span>);</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">onClick</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">      <span class="title function_">setCount</span>(count++);</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">return</span> （</span><br><span class="line">      &lt;&gt;</span><br><span class="line">        <span class="language-xml"><span class="tag">&lt;<span class="name">p</span>&gt;</span>父组件的数量为 &#123;count&#125; <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line">        <span class="language-xml"><span class="tag">&lt;<span class="name">Child1</span> /&gt;</span></span></span><br><span class="line">        <span class="language-xml"><span class="tag">&lt;<span class="name">Child2</span> /&gt;</span></span></span><br><span class="line">        <span class="language-xml"><span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;onClick&#125;</span> &gt;</span>父组件按钮<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line">    &lt;/&gt;）</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>场景一：如上 demo 中，当点击 Child2 的 子组件2按钮 的时候，Child2 会渲染，那么 Child2自然会进入到 beginWork 流程中，那么疑问来了</p>
<ul>
<li>问题一：父组件 Parent 没有更新，会 rerender 吗？那么有会进入 beginWork 流程吗 ？</li>
<li>问题二：Child1会进入 beginWork流程吗 ？</li>
<li>问题三：如果 Parent 会 beiginWork，那么 React 从 Root fiber 开始调和的时候，是如何找到发生更新的组件呢？</li>
</ul>
<p>场景二：在如上 demo 中，当点击 Parent 中的父组件按钮的时候：</p>
<ul>
<li>问题一：Parent因为本身的state 改变会更新，那么 Child1 和 Child2 为什么会跟着更新。</li>
</ul>
<p>接下来我们开始以一次更新开始，分析调和过程中 beginWork 流程，在开始之前简单的了解一下lane</p>
<ul>
<li>lane ： 更新优先级。（在一次更新任务中，将赋予给更新的 fiber 的一个更新优先级 lane。）</li>
<li>childLanes：子fiber 中更新优先级。（如果当前 fiber 的 child 中有高优先级任务，那么当前 fiber 的 childLanes 等于当前优先级）。</li>
</ul>
<p>住这两个概念对于下面流程分析很有帮助。接下来带着上面的四个问题，开始往下分析</p>
<p>我们思考一下调和算法是从rootfiber开始的，也就是从根root开始的，那么我们在调和过程中如何快速找到呢，如果你作为react的设计者应该如何去设计呢，当然答案很简单，如果我们在调用更新state的时候，给当钱组件一个标记，通过fiber的return指针反向去标记父节点直到组件根节点，然后在调和阶段只要找到和当前标记相同的的最后一个的节点，那么该节点即为state发生改变的组件，对应着react源码中的markUpdateLaneFromFiberToRoot ，核心代码如下</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">markUpdateLaneFromFiberToRoot</span>(<span class="params">sourceFiber,lane</span>)&#123;</span><br><span class="line">    <span class="comment">/* 更新当前 fiber 上 */</span></span><br><span class="line">    sourceFiber.<span class="property">lanes</span> = <span class="title function_">mergeLanes</span>(sourceFiber.<span class="property">lanes</span>, lane);</span><br><span class="line">    <span class="comment">/* 更新缓存树上的 lanes */</span></span><br><span class="line">    <span class="keyword">let</span> alternate = sourceFiber.<span class="property">alternate</span>;</span><br><span class="line">    <span class="keyword">if</span> (alternate !== <span class="literal">null</span>) alternate.<span class="property">lanes</span> = <span class="title function_">mergeLanes</span>(alternate.<span class="property">lanes</span>, lane);</span><br><span class="line">    <span class="comment">/* 当前更新的 fiber */</span></span><br><span class="line">    <span class="keyword">let</span> node = sourceFiber;</span><br><span class="line">    <span class="comment">/* 找到返回父级 */</span></span><br><span class="line">    <span class="keyword">let</span> parent = sourceFiber.<span class="property">return</span>;</span><br><span class="line">    <span class="keyword">while</span>(parent !== <span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="comment">/* 更新 childLanes 字段 */</span></span><br><span class="line">        parent.<span class="property">childLanes</span> = <span class="title function_">mergeLanes</span>(parent.<span class="property">childLanes</span>, lane);</span><br><span class="line">        <span class="keyword">if</span> (alternate !== <span class="literal">null</span>) &#123;  alternate.<span class="property">childLanes</span> = <span class="title function_">mergeLanes</span>(alternate.<span class="property">childLanes</span>, lane); &#125;</span><br><span class="line">        <span class="comment">/* 根据return指针向上遍历更新lane */</span></span><br><span class="line">        node = parent;</span><br><span class="line">        parent = parent.<span class="property">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>markUpdateLaneFromFiberToRoot 做的事很重要。</p>
<ul>
<li>首先会更新当前 fiber 上的更新优先级由于fiber 架构采用双缓冲树，所有还要更新当前 fiber 的缓冲树 alternate 上的优先级</li>
<li>然后会递归向上把父级连上的 childLanes 都更新，更新成当前的任务优先级</li>
<li>既然要从root开始调和，又不想调和整颗树，那么如何找到发生更新的组件呢？其实和我们想的是一样的，react采用childLanes作为标记，如果组件发生了更新，通过return向上递归标记改变父fiber的 childLanes，接下来从 Root Fiber 向下调和的时候，发现 childLanes 等于当前更新优先级，那么说明它的 child 链上有新的更新任务，会向下调和直到找到最后一个fiber的优先级等于当前更新优先级的fiebr</li>
</ul>
<p>我们简单的了解一下fiber树的数据结构具体长什么样子，大致如图所示</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a355d0aeb7d94098ad2cd692151ffb0e~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=1266&h=886&s=105328&e=png&b=17141d"></p>
<ul>
<li>return指针：指向了当前fiber父节点</li>
<li>child指针：父fiber指向的第一个子fiber</li>
<li>sibling: 子fiber指向的下一个子fiber</li>
</ul>
<p>在简单的了解fiber的简单的数据结构以后我们来探讨一下，整个调和过程是怎么样的呢</p>
<p>组件更新前如图所示</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/59d740dddd5943c2824d62bb713f8d73~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=1294&h=862&s=104998&e=png&b=17141d"></p>
<p>组件发生了更新如图所示进行标记并改变childLanes</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c6460e646f1047c7987d047860bf3187~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=1492&h=946&s=122916&e=png&b=18151e"></p>
<p>从根节点开始向下调和，直到找到优先级等于当前更新优先级的fiber</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/21dcca0f76864a5098d02d0234a9b80b~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=1572&h=1000&s=118943&e=png&b=18151e"></p>
<ul>
<li>第一阶段是组件发生更新，那么产生一个更新优先级 updateLane ,并且当前的组件lane赋值为updateLane</li>
<li>第二阶段通过return指针向上标记更新父fiber的 childLanes为updateLane</li>
<li>第三阶段是向下调和过程，如果父fiber被调和，那么父fiber的前几个兄弟节点一定会被调和阶段，并且父级的第一级子链的fiber都会进入调和流程</li>
</ul>
<h2 id="beginWork-流程"><a href="#beginWork-流程" class="headerlink" title="beginWork 流程"></a>beginWork 流程</h2><p>我们从调和阶段其实发现了一个有趣的现象，react首先先沿着child找到第一个子fiber，直到找到最后一个不存在子fiber的节点，然后沿着当前fiber的sbling进行寻找，直到当前节点不存在sbling，然后然后到父节点继续沿着父节点的sibling进行搜索，其实这个过程在recat被分为beginWork 和competeWork</p>
<p>beginwork阶段主要做的是向下调和的过程，既沿着child指针向下遍历以及沿着sbling指针向右遍历</p>
<p>但是只有发生state改变的组件才会rerender以及当前组件的后代组件会发生render，为了更好的理解这句话，我们作了如图所示</p>
<p>假设有一个组件 fiber 链：root –&gt;child–&gt; A组件 –&gt;child–&gt; B组件 –child–&gt; C组件,如图所示</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/435b31871ee84848963893757bb25d4f~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=1260&h=332&s=24659&e=png&b=18151e"></p>
<p>以B组件为例，发生更新的情况一共有4种情况</p>
<ul>
<li>更新 A 的state，只会标记A和root，然后 root和A 会被调和，在没有作任何优化的前提下，B，C组件不进入调和，一定会发生render</li>
<li>更新 B 的state， B，A和root 会被标记，然后 root和A 会被调和，但是不会 rerender；组件 B 是既会进入调和，也会 rerender；组件 C 受到父组件 B 的影响，不会进入调和，但是会进入rerender</li>
<li>更新 C的State，那么 A，B 会进入调和流程，组件 C 既会进入调和，也会 rerender</li>
<li>更新 root 的state，那么 root会被标记，并进入调和阶段，A 受到root 的影响，不会进入调和，但是会进入rerender，（这也是为什么context发生改变，会导致所有后代fiber进行rerender的原因）</li>
<li>renderLanes不等于B的childLanes，不会进行B的调和</li>
</ul>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">*</span>&#125; current         current 树 fiber </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">*</span>&#125; workInProgress  workInProgress 树 fiber </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">*</span>&#125; renderLanes     当前的 render 优先级</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns</span> </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">beginWork</span>(<span class="params">current,workInProgress,renderLanes</span>)&#123;</span><br><span class="line">    <span class="comment">/* -------------------第一部分-------------------- */</span></span><br><span class="line">    <span class="keyword">if</span>(current !== <span class="literal">null</span>)&#123; </span><br><span class="line">        <span class="comment">/* 更新流程 */</span></span><br><span class="line">        <span class="comment">/* current 树上上一次渲染后的 props */</span></span><br><span class="line">        <span class="keyword">const</span> oldProps = current.<span class="property">memoizedProps</span>;</span><br><span class="line">        <span class="comment">/* workInProgress 树上这一次更新的 props  */</span></span><br><span class="line">        <span class="keyword">const</span> newProps = workInProgress.<span class="property">pendingProps</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span>(oldProps !== newProps ||  <span class="title function_">hasLegacyContextChanged</span>())&#123;</span><br><span class="line">          didReceiveUpdate = <span class="literal">true</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">          <span class="comment">/* props 和 context 没有发生变化，检查是否更新来自自身或者 context 改变 */</span></span><br><span class="line">          <span class="keyword">const</span> hasScheduledUpdateOrContext = <span class="title function_">checkScheduledUpdateOrContext</span>(current,renderLanes)</span><br><span class="line">          <span class="keyword">if</span>(!hasScheduledUpdateOrContext)&#123;</span><br><span class="line">              didReceiveUpdate = <span class="literal">false</span>;</span><br><span class="line">              <span class="keyword">return</span>  <span class="title function_">attemptEarlyBailoutIfNoScheduledUpdate</span>(current,workInProgress,renderLanes)</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="comment">/* 这里省略了一些判断逻辑 */</span></span><br><span class="line">          didReceiveUpdate = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">      didReceiveUpdate = <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">/*  组件会被调和，进入更新阶段 */</span></span><br><span class="line">    <span class="keyword">switch</span>(workInProgress.<span class="property">tag</span>)&#123;</span><br><span class="line">        <span class="comment">/* 函数组件的情况 */</span></span><br><span class="line">        <span class="keyword">case</span> <span class="title class_">FunctionComponent</span>: &#123;</span><br><span class="line">           <span class="keyword">return</span> <span class="title function_">updateFunctionComponent</span>( current, workInProgress, <span class="title class_">Component</span>, resolvedProps, renderLanes )</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/* 类组件的情况 */</span></span><br><span class="line">        <span class="keyword">case</span> <span class="title class_">ClassComponent</span>:&#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="title function_">updateClassComponent</span>(current,workInProgress,<span class="title class_">Component</span>,resolvedProps,renderLanes)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/* 元素类型 &lt;div&gt;, &lt;span&gt;  */</span></span><br><span class="line">        <span class="keyword">case</span> <span class="title class_">HostComponent</span>:&#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="title function_">updateHostComponent</span>(current, workInProgress, renderLanes)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/* 其他 fiber 情况 */</span> </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从源码中我们可以看到beiginwork主要分为2个阶段</p>
<ul>
<li>第一阶段</li>
</ul>
<!---->

<ul>
<li><p>didReceiveUpdate ：标记当前更新是否来源于父级的更新</p>
</li>
<li><p>首先通过 current !&#x3D;&#x3D; null 来判断当前 fiber 是否创建过，如果 current 为 null，则进入mounted阶段， 否则进入update阶段</p>
</li>
<li><p>oldProps &#x3D;&#x3D;&#x3D; newProps</p>
<ul>
<li>判断当前组件更新前后的props是否相等</li>
<li>通过 useMemo或者meno 等方式缓存了 React element 元素</li>
<li>更新发生在当前组件本身，但是 B 组件的 props 并没有发生变化</li>
</ul>
</li>
</ul>
<p>反之如果两者不想等，证明父级 fiber 重新 rerender 导致了 props 改变，此时 didReceiveUpdate &#x3D; true ，那么第一阶段完成，进入到第二阶段</p>
<ul>
<li><p>第二阶段更新 fiber</p>
<ul>
<li>函数组件调用 updateFunctionComponent然后进行 rerender</li>
<li>类组件调用 updateClassComponent然后进行 rerender</li>
</ul>
</li>
</ul>
<h2 id="beiginWork流程图"><a href="#beiginWork流程图" class="headerlink" title="beiginWork流程图"></a>beiginWork流程图</h2><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/719932fbdce8474b876aa7aa30c410e6~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=1220&h=944&s=97048&e=png&b=19161f"></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ul>
<li>组件更新和调和过程。rerender 一定会调和，但是调和并不一定 rerender。。</li>
<li>标记是从state发生的改变沿着fiber的return指针向上标记</li>
<li>调和是从根接节点向下调和的，直到找到renderLanes等于lans的节点停止调和</li>
<li>进入beginWrok阶段，判断当前组件更新的原因是什么原因引起的</li>
<li>执行渲染fiber</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://imperial-long.github.io/blog/2024/04/17/form%E8%A1%A8%E5%8D%95%E5%AE%9E%E7%8E%B0%E6%80%9D%E8%B7%AF/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="朱广龙">
      <meta itemprop="description" content="定期会更新前端技术栈 不限于vue，react，node以及部分后端的知识">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="朱广龙的个人博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2024/04/17/form%E8%A1%A8%E5%8D%95%E5%AE%9E%E7%8E%B0%E6%80%9D%E8%B7%AF/" class="post-title-link" itemprop="url">表单实现思路</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-04-17 20:39:00" itemprop="dateCreated datePublished" datetime="2024-04-17T20:39:00+08:00">2024-04-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-10-10 13:25:39" itemprop="dateModified" datetime="2024-10-10T13:25:39+08:00">2024-10-10</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>在中后台这个领域，form是一个离不开老生常谈的话题，有很多优秀的form解决方案， 比如react-form-hook，formik，formaily等，在使用这些比较成熟的解决方案的时候有想过怎么实现的呢， 我们今天一起来揭开这层神秘的面纱, 一起探讨一下实现一个form的思路以及核心编码在开始今天的话题之前，需要了解 react 的一个比较新的api（useSyncExternalStore），我会根据设计方案的制定以及实现思路来带着大家进行对编码的实现</p>
<h2 id="设计方案"><a href="#设计方案" class="headerlink" title="设计方案"></a>设计方案</h2><h3 id="设计理念"><a href="#设计理念" class="headerlink" title="设计理念"></a>设计理念</h3><ol>
<li><strong>状态管理</strong>: <code>FormStore</code> 主要负责管理表单的状态，包括表单的值、初始值、错误信息、校验器和事件监听器。通过集中管理这些状态，可以简化表单逻辑并提高代码可维护性。</li>
<li><strong>响应式更新</strong>: 当表单值发生变化时，<code>FormStore</code> 会通知所有注册的监听器。这种设计允许视图组件能够自动更新，从而实现响应式 UI。</li>
<li><strong>表单校验</strong>: <code>FormStore</code> 提供了校验机制，确保表单提交时的有效性。通过注册校验器，可以对表单的不同字段进行单独的校验。</li>
<li><strong>解耦逻辑</strong>: <code>FormStore</code> 将表单的状态管理与 UI 逻辑解耦，使得表单逻辑更加模块化和可测试。</li>
</ol>
<h3 id="要解决的问题"><a href="#要解决的问题" class="headerlink" title="要解决的问题"></a>要解决的问题</h3><ol>
<li><strong>状态同步</strong>: 确保表单的值与初始值之间的同步，支持表单的重置操作。</li>
<li><strong>值更新</strong>: 提供方法更新表单字段的值，并确保这些变化能够被及时监听和响应。</li>
<li><strong>错误处理</strong>: 在表单校验失败时，能够准确地记录并处理错误信息。</li>
<li><strong>提交逻辑</strong>: 管理表单的提交行为，确保在提交之前进行必要的校验，并根据结果触发相应的回调函数。</li>
</ol>
<p>在编程语言中，单一职则应该是耳目共熟了吧，在这一思想的指导下我们来写一下我们的form表单的整体设计思路(UML图，流程图)</p>
<h3 id="UML图"><a href="#UML图" class="headerlink" title="UML图"></a>UML图</h3><ul>
<li>form组件：负责表单的提交以及表单组件的赋值</li>
<li>form-item组件：负责控制常见的表单组件，负责收集校验规则</li>
<li>表单组件需要提供onchange和value事件</li>
<li>采用面向对象来管理相关的事件</li>
</ul>
<p>根据以上思路整体的设计思路如下</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/18b1132a17954856aa6889bb9a014475~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=1656&h=1110&s=225828&e=png&b=17141d"></p>
<h3 id="流程图"><a href="#流程图" class="headerlink" title="流程图"></a>流程图</h3><ul>
<li>formItem组件触发onchange通知form组件收集校验规则</li>
<li>form组件setValue&#x2F;setVlaues通知form-item去set表单组件</li>
<li>Input组件发生改变触发onchane并通知form组件进行set</li>
</ul>
<p>流程图大致如下</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ad3ab50144c642b78955f9732e30c5ec~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=1610&h=1086&s=89960&e=png&b=17141d"></p>
<h2 id="编码实现"><a href="#编码实现" class="headerlink" title="编码实现"></a>编码实现</h2><h3 id="Form组件实现思路"><a href="#Form组件实现思路" class="headerlink" title="Form组件实现思路"></a>Form组件实现思路</h3><ul>
<li>form 组件主要承担了表单的最后提交</li>
<li>form组件负责管理Formstore类， formStore承担了所有的业务逻辑</li>
<li>form组件提供了上下文供form-item组件使用</li>
<li>form继承了原生form元素的能力</li>
</ul>
<p>根据以上form承担的责任以及结合设计思路因此我们的FormConext大致实现思路如下</p>
<h4 id="FormContext"><a href="#FormContext" class="headerlink" title="FormContext"></a>FormContext</h4><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> <span class="title class_">FormContext</span> &#123;</span><br><span class="line">  values?: <span class="title class_">Record</span>&lt;<span class="built_in">string</span>, <span class="built_in">unknown</span>&gt;; <span class="comment">// 用于存储表单数据</span></span><br><span class="line">  onValuesChange?: <span class="function">(<span class="params"><span class="attr">key</span>: <span class="built_in">string</span>, <span class="attr">value</span>: <span class="built_in">unknown</span></span>) =&gt;</span> <span class="built_in">void</span>; <span class="comment">// 用于监听表单数据变化</span></span><br><span class="line">  registerValidator?: <span class="function">(<span class="params"><span class="attr">key</span>: <span class="built_in">string</span>, <span class="attr">validator</span>: () =&gt; <span class="built_in">void</span></span>) =&gt;</span> <span class="built_in">void</span> <span class="comment">// 注册校验规则</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 表单context</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">FormProvider</span> = createContext&lt;<span class="title class_">FormContext</span>&gt;(&#123;&#125;);</span><br></pre></td></tr></table></figure>

<h4 id="FormStore"><a href="#FormStore" class="headerlink" title="FormStore"></a>FormStore</h4><p>实现了FormConetx以后我们来看一下我来设计一下我的FormStore类</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">Errors</span> &#123;</span><br><span class="line">  [<span class="attr">key</span>: <span class="built_in">string</span>]: <span class="title class_">Error</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">Validators</span> &#123;</span><br><span class="line">  [<span class="attr">key</span>: <span class="built_in">string</span>]: <span class="function">() =&gt;</span> <span class="built_in">void</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">Listeners</span> &#123;</span><br><span class="line">  (): <span class="built_in">void</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">HandleSubmit</span> &#123;</span><br><span class="line">  onFinish?: <span class="function">(<span class="params"><span class="attr">values</span>: <span class="title class_">FormValues</span></span>) =&gt;</span> <span class="built_in">void</span>;</span><br><span class="line">  onFinishFailed?: <span class="function">(<span class="params"><span class="attr">errors</span>: <span class="title class_">FormErrors</span></span>) =&gt;</span> <span class="built_in">void</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">IFormStore</span> &#123;</span><br><span class="line">   <span class="title function_">setValues</span>(<span class="attr">values</span>: <span class="title class_">Record</span>&lt;<span class="built_in">string</span>, <span class="built_in">unknown</span>&gt;): <span class="built_in">void</span>;</span><br><span class="line">   <span class="title function_">setValue</span>(<span class="attr">key</span>: <span class="built_in">string</span>, <span class="attr">value</span>: <span class="built_in">unknown</span>): <span class="built_in">void</span>;</span><br><span class="line">   <span class="title function_">setInitialValues</span> (<span class="attr">values</span>: <span class="title class_">Record</span>&lt;<span class="built_in">string</span>, <span class="built_in">unknown</span>&gt;): <span class="built_in">void</span>;</span><br><span class="line">   <span class="title function_">resetFields</span> (): <span class="built_in">void</span>;</span><br><span class="line">   <span class="title function_">onValuesChange</span> (<span class="attr">key</span>: <span class="built_in">string</span>, <span class="attr">value</span>: <span class="built_in">unknown</span>): <span class="built_in">void</span>;</span><br><span class="line">   <span class="title function_">emitChange</span>(): <span class="built_in">void</span>;</span><br><span class="line">   <span class="title function_">getFieldValue</span> (<span class="attr">key</span>: <span class="built_in">string</span>): <span class="built_in">unknown</span>;</span><br><span class="line">   <span class="title function_">getFieldsValue</span> (): <span class="title class_">Record</span>&lt;<span class="built_in">string</span>, <span class="built_in">unknown</span>&gt;;</span><br><span class="line">  <span class="title function_">subscribe</span> (<span class="attr">callback</span>: <span class="function">() =&gt;</span> <span class="built_in">void</span>): <span class="built_in">void</span>;</span><br><span class="line">   <span class="title function_">handleSubmit</span> (<span class="attr">e</span>: <span class="title class_">React</span>.<span class="property">FormEvent</span>&lt;<span class="title class_">HTMLFormElement</span>&gt;, </span><br><span class="line">   <span class="attr">options</span>: <span class="title class_">HandleSubmit</span>): <span class="title class_">Promise</span>&lt;<span class="built_in">void</span>&gt;;</span><br><span class="line">   <span class="title function_">registerValidator</span> (<span class="attr">key</span>: <span class="built_in">string</span>, <span class="attr">validator</span>: <span class="function">() =&gt;</span> <span class="built_in">void</span>);</span><br><span class="line">  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">HandleSubmitParams</span>  implements <span class="title class_">IFormStore</span> &#123;</span><br><span class="line">  onFinish?: <span class="function">(<span class="params"><span class="attr">values</span>: <span class="title class_">FormValues</span></span>) =&gt;</span> <span class="built_in">void</span>;</span><br><span class="line">  onFinishFailed?: <span class="function">(<span class="params"><span class="attr">errors</span>: <span class="title class_">FormErrors</span></span>) =&gt;</span> <span class="built_in">void</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">FormStore</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="attr">initialValues</span>: <span class="title class_">Record</span>&lt;<span class="built_in">string</span>, <span class="built_in">unknown</span>&gt;;</span><br><span class="line">    <span class="keyword">private</span> values : <span class="title class_">Record</span>&lt;<span class="built_in">string</span>, <span class="built_in">unknown</span>&gt;;</span><br><span class="line">    <span class="keyword">private</span> <span class="attr">errors</span>: <span class="title class_">Record</span>&lt;<span class="built_in">string</span>, <span class="title class_">Error</span>&gt;;</span><br><span class="line">    <span class="keyword">private</span> <span class="attr">validators</span>: <span class="title class_">Record</span>&lt;<span class="built_in">string</span>, <span class="function">() =&gt;</span> <span class="built_in">void</span>&gt;;</span><br><span class="line">    <span class="keyword">private</span> <span class="attr">listeners</span>: <span class="title class_">Array</span>&lt;<span class="function">() =&gt;</span> <span class="built_in">void</span>&gt;;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params"><span class="attr">initialValues</span>: <span class="title class_">Record</span>&lt;<span class="built_in">string</span>, <span class="built_in">unknown</span>&gt; </span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">initialValues</span> = initialValues;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">values</span> = &#123;&#125;;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">errors</span> = &#123;&#125;;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">validators</span> = &#123;&#125;;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">listeners</span> = [];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">setValues</span>(<span class="params"><span class="attr">values</span>: <span class="title class_">Record</span>&lt;<span class="built_in">string</span>, <span class="built_in">unknown</span>&gt;</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">values</span> = values;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">setValue</span>(<span class="params"><span class="attr">key</span>: <span class="built_in">string</span>, <span class="attr">value</span>: <span class="built_in">unknown</span></span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">values</span> = &#123;</span><br><span class="line">        ...<span class="variable language_">this</span>.<span class="property">values</span>,</span><br><span class="line">        [key]: value</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">setInitialValues</span> (<span class="attr">values</span>: <span class="title class_">Record</span>&lt;<span class="built_in">string</span>, <span class="built_in">unknown</span>&gt;) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">initialValues</span> = values;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">setValues</span>(values);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    <span class="title function_">resetFields</span> () &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">setValues</span>(<span class="variable language_">this</span>.<span class="property">initialValues</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">onValuesChange</span> (<span class="attr">key</span>: <span class="built_in">string</span>, <span class="attr">value</span>: <span class="built_in">unknown</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (key) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">setValues</span>(&#123;</span><br><span class="line">          ...<span class="variable language_">this</span>.<span class="property">values</span>,</span><br><span class="line">          [key]: value,</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">emitChange</span>()</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">emitChange</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">const</span> listener <span class="keyword">of</span> <span class="variable language_">this</span>.<span class="property">listeners</span>) &#123;</span><br><span class="line">        <span class="title function_">listener</span>();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">getFieldValue</span> (<span class="attr">key</span>: <span class="built_in">string</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">values</span>[key];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">getFieldsValue</span> () &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">values</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">subscribe</span> (<span class="attr">callback</span>: <span class="function">() =&gt;</span> <span class="built_in">void</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">listeners</span> = [...<span class="variable language_">this</span>.<span class="property">listeners</span>, callback];</span><br><span class="line">      <span class="keyword">return</span> <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">listeners</span> = <span class="variable language_">this</span>.<span class="property">listeners</span>.<span class="title function_">filter</span>(<span class="function">(<span class="params">listener</span>) =&gt;</span> listener !== callback);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 表单提交</span></span><br><span class="line">  <span class="keyword">async</span>  <span class="title function_">handleSubmit</span> (<span class="attr">e</span>: <span class="title class_">React</span>.<span class="property">FormEvent</span>&lt;<span class="title class_">HTMLFormElement</span>&gt;, </span><br><span class="line">    &#123; onFinish, onFinishFailed &#125;: <span class="title class_">HandleSubmit</span>) &#123;</span><br><span class="line">      e.<span class="title function_">preventDefault</span>();</span><br><span class="line"></span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">of</span> <span class="title class_">Object</span>.<span class="title function_">keys</span>(<span class="variable language_">this</span>.<span class="property">validators</span>)) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">validators</span>[key]();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">          <span class="variable language_">this</span>.<span class="property">errors</span>[key] = e <span class="keyword">as</span> <span class="title class_">Error</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (<span class="title class_">Object</span>.<span class="title function_">keys</span>(<span class="variable language_">this</span>.<span class="property">errors</span>).<span class="property">length</span>) &#123;</span><br><span class="line">        onFinishFailed?.(<span class="variable language_">this</span>.<span class="property">errors</span>);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        onFinish?.(<span class="variable language_">this</span>.<span class="property">values</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">registerValidator</span> (<span class="attr">key</span>: <span class="built_in">string</span>, <span class="attr">validator</span>: <span class="function">() =&gt;</span> <span class="built_in">void</span>)  &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">validators</span>[key] = validator;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="keyword">export</span> <span class="keyword">default</span> <span class="title class_">FormStore</span>;</span><br></pre></td></tr></table></figure>

<h4 id="useForm"><a href="#useForm" class="headerlink" title="useForm"></a>useForm</h4><p>有了FormStore以后，我们根据Formstore来实现 useForm hook来管理</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; useRef &#125; <span class="keyword">from</span> <span class="string">&quot;react&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">FormStore</span> <span class="keyword">from</span> <span class="string">&quot;./store&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">useForm</span>(<span class="params"><span class="attr">values</span>: <span class="title class_">Record</span>&lt;<span class="built_in">string</span>, <span class="built_in">unknown</span>&gt; = &#123;&#125;</span>) &#123;</span><br><span class="line">  <span class="comment">// 表单数据</span></span><br><span class="line">  <span class="keyword">const</span> formStore = useRef&lt;<span class="title class_">FormStore</span>&gt;(<span class="keyword">new</span> <span class="title class_">FormStore</span>(values || &#123;&#125;));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> [formStore.<span class="property">current</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> useForm;</span><br></pre></td></tr></table></figure>

<h4 id="Form-组件"><a href="#Form-组件" class="headerlink" title="Form 组件"></a>Form 组件</h4><p>最后一步结合FormContext，FormStore，useForm 封装出我们的Form组件</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> <span class="title class_">FormProps</span> <span class="keyword">extends</span> <span class="title class_">HtmlHTMLAttributes</span>&lt;<span class="title class_">HTMLFormElement</span>&gt;, <span class="title class_">PropsWithChildren</span> &#123;</span><br><span class="line">  className?: <span class="built_in">string</span>; <span class="comment">// 表单类名</span></span><br><span class="line">  style?: <span class="title class_">CSSProperties</span>; <span class="comment">// 表单样式</span></span><br><span class="line">  onFinish?: <span class="function">(<span class="params"><span class="attr">values</span>: <span class="title class_">Record</span>&lt;<span class="built_in">string</span>, <span class="built_in">unknown</span>&gt;</span>) =&gt;</span> <span class="built_in">void</span>; <span class="comment">// 表单提交回调</span></span><br><span class="line">  onFinishFailed?: <span class="function">(<span class="params"><span class="attr">values</span>: <span class="title class_">Record</span>&lt;<span class="built_in">string</span>, <span class="built_in">unknown</span>&gt;</span>) =&gt;</span> <span class="built_in">void</span>; <span class="comment">// 表单提交失败回调</span></span><br><span class="line">  initialValues?: <span class="title class_">Record</span>&lt;<span class="built_in">string</span>, <span class="built_in">unknown</span>&gt;; <span class="comment">// 表单初始值</span></span><br><span class="line">  form?: <span class="title class_">FormStore</span>;</span><br><span class="line">  watch?: <span class="title class_">Record</span>&lt;<span class="built_in">string</span>, <span class="title class_">Watch</span>&gt;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> <span class="title class_">Watch</span> &#123;</span><br><span class="line">  immediate?: <span class="built_in">boolean</span>;</span><br><span class="line">  <span class="attr">handler</span>: <span class="function">(<span class="params"><span class="attr">value</span>: <span class="built_in">unknown</span></span>) =&gt;</span> <span class="built_in">void</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Form</span>: <span class="variable constant_">FC</span>&lt;<span class="title class_">FormProps</span>&gt; = <span class="function">(<span class="params">&#123;</span></span></span><br><span class="line"><span class="params"><span class="function">  className,</span></span></span><br><span class="line"><span class="params"><span class="function">  style, children,</span></span></span><br><span class="line"><span class="params"><span class="function">  onFinish,</span></span></span><br><span class="line"><span class="params"><span class="function">  onFinishFailed,</span></span></span><br><span class="line"><span class="params"><span class="function">  initialValues,</span></span></span><br><span class="line"><span class="params"><span class="function">  form,</span></span></span><br><span class="line"><span class="params"><span class="function">  watch = &#123;&#125;,</span></span></span><br><span class="line"><span class="params"><span class="function">  ...resetProps</span></span></span><br><span class="line"><span class="params"><span class="function">&#125;</span></span></span><br><span class="line"><span class="params"><span class="function"></span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 表单数据</span></span><br><span class="line">  <span class="keyword">const</span> [innerFormStore] = <span class="title function_">useForm</span>(initialValues);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> formStore = form ?? innerFormStore;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">onValuesChange</span> = (<span class="params"><span class="attr">key</span>: <span class="built_in">string</span>, <span class="attr">value</span>: <span class="built_in">unknown</span></span>) =&gt; &#123;</span><br><span class="line">    watch?.[key]?.<span class="title function_">handler</span>(value);</span><br><span class="line">    formStore.<span class="title function_">onValuesChange</span>(key, value);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 表单提交</span></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">handleSubmit</span> = (<span class="params"><span class="attr">e</span>: <span class="title class_">React</span>.<span class="title class_">FormEvent</span>&lt;<span class="title class_">HTMLFormElement</span>&gt;</span>) =&gt; &#123;</span><br><span class="line">    formStore.<span class="title function_">handleSubmit</span>(e, &#123; onFinish, onFinishFailed &#125;);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">registerValidator</span> = (<span class="params"><span class="attr">key</span>: <span class="built_in">string</span>, <span class="attr">validator</span>: () =&gt; <span class="built_in">void</span></span>) =&gt; &#123;</span><br><span class="line">    formStore.<span class="title function_">registerValidator</span>(key, validator);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">getFieldsValue</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> formStore.<span class="title function_">getFieldsValue</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">subscribe</span> = (<span class="params"><span class="attr">callback</span>: () =&gt; <span class="built_in">void</span></span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> formStore.<span class="title function_">subscribe</span>(callback);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> values = <span class="title function_">useSyncExternalStore</span>(subscribe, getFieldsValue);</span><br><span class="line"></span><br><span class="line">  <span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">of</span> <span class="title class_">Object</span>.<span class="title function_">keys</span>(watch)) &#123;</span><br><span class="line">      <span class="keyword">const</span> &#123; immediate, handler &#125; = watch[key];</span><br><span class="line">      <span class="keyword">if</span> (immediate) &#123;</span><br><span class="line">        <span class="title function_">handler</span>(formStore.<span class="title function_">getFieldValue</span>(key));</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, [watch, formStore])</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">FormProvider.Provider</span> <span class="attr">value</span>=<span class="string">&#123;&#123;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">      <span class="attr">values</span>,</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">      <span class="attr">onValuesChange</span>,</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">      <span class="attr">registerValidator</span>,</span></span></span><br><span class="line"><span class="tag"><span class="language-xml"></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">    &#125;&#125;&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">form</span> <span class="attr">className</span>=<span class="string">&#123;className&#125;</span> <span class="attr">style</span>=<span class="string">&#123;style&#125;</span> &#123;<span class="attr">...resetProps</span>&#125; <span class="attr">onSubmit</span>=<span class="string">&#123;handleSubmit&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        &#123;children&#125;</span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">FormProvider.Provider</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title class_">Form</span>;</span><br></pre></td></tr></table></figure>

<h3 id="Form-item实现"><a href="#Form-item实现" class="headerlink" title="Form-item实现"></a>Form-item实现</h3><p>我们上面大致实现了Form组件的核心逻辑，接下来我们实现form-item组件，采用async-validator来进行数据校验</p>
<ul>
<li>form-item负责注入向其子组件value和onchange事件</li>
<li>form-item负责收集校验规则</li>
<li>form-item组件负责</li>
</ul>
<p>大致代码逻辑实现如下</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">CSSProperties</span>, <span class="title class_">ChangeEvent</span>, <span class="title class_">Children</span>, <span class="title class_">ReactElement</span>, cloneElement, useContext, useState &#125; <span class="keyword">from</span> <span class="string">&quot;react&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">FormProvider</span> &#125; <span class="keyword">from</span> <span class="string">&quot;.&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Schema</span>, &#123; <span class="title class_">Rule</span>, <span class="title class_">ValidateError</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;async-validator&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> <span class="title class_">FormItmProps</span> &#123;</span><br><span class="line">  className?: <span class="built_in">string</span>; <span class="comment">// 表单项类名</span></span><br><span class="line">  style?: <span class="title class_">CSSProperties</span>; <span class="comment">// 表单项样式</span></span><br><span class="line">  <span class="attr">name</span>: <span class="built_in">string</span>; <span class="comment">// 表单项名称</span></span><br><span class="line">  label?: <span class="built_in">string</span>; <span class="comment">// 表单项标签</span></span><br><span class="line">  rules?: <span class="title class_">Rule</span>; <span class="comment">// 表单项校验规则</span></span><br><span class="line">  children?: <span class="title class_">ReactElement</span>; <span class="comment">// 表单项内容</span></span><br><span class="line">  valuePropName?: <span class="built_in">string</span>; <span class="comment">// 表单项值属性名</span></span><br><span class="line">  onChange?: <span class="function">(<span class="params"><span class="attr">e</span>: <span class="title class_">ChangeEvent</span>&lt;<span class="title class_">HTMLInputElement</span>&gt;</span>) =&gt;</span> <span class="built_in">void</span>; <span class="comment">// 表单项值变化回调</span></span><br><span class="line">  value?: <span class="built_in">string</span> | <span class="built_in">number</span> | <span class="built_in">boolean</span>; <span class="comment">// 表单项值</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">FormItem</span> = (<span class="params">&#123;</span></span><br><span class="line"><span class="params">  className,</span></span><br><span class="line"><span class="params">  style,</span></span><br><span class="line"><span class="params">  name, label,</span></span><br><span class="line"><span class="params">  rules,</span></span><br><span class="line"><span class="params">  valuePropName = <span class="string">&#x27;value&#x27;</span>,</span></span><br><span class="line"><span class="params">  children,</span></span><br><span class="line"><span class="params">  ...resetProps</span></span><br><span class="line"><span class="params">&#125;: <span class="title class_">FormItmProps</span></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; onValuesChange, values = &#123;&#125;, registerValidator &#125; = <span class="title function_">useContext</span>(<span class="title class_">FormProvider</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> [value, setValue] = useState&lt;<span class="built_in">string</span> | <span class="built_in">number</span> | <span class="built_in">boolean</span>&gt;();</span><br><span class="line">  <span class="keyword">const</span> [error, setError] = useState&lt;<span class="built_in">string</span> | <span class="literal">undefined</span>&gt;(<span class="string">&#x27;&#x27;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (name &amp;&amp; value != values[name]) &#123;</span><br><span class="line">    <span class="title function_">setValue</span>(values[name] <span class="keyword">as</span> <span class="built_in">string</span> | <span class="built_in">number</span> | <span class="built_in">boolean</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">validate</span> = (<span class="params"><span class="attr">value</span>: <span class="built_in">unknown</span></span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (!rules) &#123;</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> newRules = <span class="title class_">Array</span>.<span class="title function_">isArray</span>(rules) ? rules : [rules];</span><br><span class="line">    <span class="keyword">const</span> validator = <span class="keyword">new</span> <span class="title class_">Schema</span>(&#123;</span><br><span class="line">      [name]: newRules.<span class="title function_">map</span>(<span class="function">(<span class="params">rule</span>) =&gt;</span> (&#123; ...rule, &#125;)),</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> validator.<span class="title function_">validate</span>(&#123; [name]: value &#125;, &#123;&#125;, <span class="function">(<span class="params"><span class="attr">errors</span>: <span class="title class_">ValidateError</span>[] | <span class="literal">null</span></span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (errors &amp;&amp; errors.<span class="property">length</span>) &#123;</span><br><span class="line">        <span class="title function_">setError</span>(errors[<span class="number">0</span>].<span class="property">message</span>);</span><br><span class="line"></span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="title function_">setError</span>(<span class="string">&#x27;&#x27;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">onChange</span> = <span class="keyword">async</span> (<span class="params"><span class="attr">e</span>: <span class="title class_">ChangeEvent</span>&lt;<span class="title class_">HTMLInputElement</span>&gt;</span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> value = <span class="title function_">getValueFormEvent</span>(e);</span><br><span class="line">    <span class="keyword">if</span> (name) &#123;</span><br><span class="line">      registerValidator?.(name, <span class="function">() =&gt;</span> <span class="title function_">validate</span>(value));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> hasValidate = <span class="keyword">await</span> <span class="title function_">validate</span>(value);</span><br><span class="line">      <span class="keyword">if</span> (name &amp;&amp; hasValidate) &#123;</span><br><span class="line">        <span class="title function_">setValue</span>(value);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">      <span class="title function_">setError</span>(e.<span class="property">message</span>);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (name) &#123;</span><br><span class="line">        onValuesChange?.(name, value);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    resetProps.<span class="property">onChange</span>?.(e);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">getValueFormEvent</span> = (<span class="params"><span class="attr">e</span>: <span class="title class_">ChangeEvent</span>&lt;<span class="title class_">HTMLInputElement</span>&gt;</span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; target &#125; = e;</span><br><span class="line">    <span class="keyword">return</span> target.<span class="property">type</span> === <span class="string">&#x27;checkbox&#x27;</span> ? target.<span class="property">checked</span> : target.<span class="property">value</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> childEle = <span class="title class_">Children</span>.<span class="title function_">toArray</span>(children).<span class="property">length</span> &gt; <span class="number">1</span> ? children : <span class="title function_">cloneElement</span>(children <span class="keyword">as</span> <span class="title class_">ReactElement</span>,</span><br><span class="line">    &#123;</span><br><span class="line">      [valuePropName]: name ? value : resetProps.<span class="property">value</span>,</span><br><span class="line">      onChange,</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!name) &#123;</span><br><span class="line">    <span class="keyword">return</span> children;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&#123;className&#125;</span> <span class="attr">style</span>=<span class="string">&#123;style&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">label</span> <span class="attr">htmlFor</span>=<span class="string">&#123;name&#125;</span>&gt;</span>&#123;label&#125;<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      &#123;childEle&#125;</span></span><br><span class="line"><span class="language-xml">      &#123;error &amp;&amp; <span class="tag">&lt;<span class="name">div</span>&gt;</span>&#123;error&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span>&#125;</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title class_">FormItem</span>;</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://imperial-long.github.io/blog/2024/02/06/vu3%E5%93%8D%E5%BA%94%E5%BC%8F%E5%AE%9E%E7%8E%B01/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="朱广龙">
      <meta itemprop="description" content="定期会更新前端技术栈 不限于vue，react，node以及部分后端的知识">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="朱广龙的个人博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2024/02/06/vu3%E5%93%8D%E5%BA%94%E5%BC%8F%E5%AE%9E%E7%8E%B01/" class="post-title-link" itemprop="url">vu3响应式实现（1）</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-02-06 20:39:00" itemprop="dateCreated datePublished" datetime="2024-02-06T20:39:00+08:00">2024-02-06</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-10-10 13:18:16" itemprop="dateModified" datetime="2024-10-10T13:18:16+08:00">2024-10-10</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>本文主要讲vue的响应式系统如何实现，在实现过程中我们也会遇到一些问题比如如何避免无限递归，副作用函数的嵌套，两个副作用函数之间会产生哪些影响等首先在认识vue等响应式系统之前我们先要了解函数的副作用</p>
<h2 id="函数的副作用"><a href="#函数的副作用" class="headerlink" title="函数的副作用"></a>函数的副作用</h2><p>函数副作用指的是函数在执行过程中对程序状态或外部环境造成的改变。通常，函数应该是一种纯函数，即给定相同的输入，总是返回相同的输出，而且不会对程序状态产生任何影响。但是，有些函数会产生副作用，这意味着它们除了返回一个值之外，还会执行其他操作，例如修改全局变量、写入文件、发送网络请求等</p>
<p>我们来看几个个函数副作用的例子</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// 案例一</span></span><br><span class="line"><span class="keyword">const</span> obj = &#123; <span class="attr">name</span>: <span class="string">&#x27;vue&#x27;</span> &#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">setName</span>(<span class="params"></span>)&#123;</span><br><span class="line"> obj.<span class="property">name</span> = <span class="string">&#x27;react&#x27;</span>;  <span class="comment">// 函数修改了外部变量obj的值</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//案例二</span></span><br><span class="line"><span class="keyword">import</span> &#123; readfile, writefile &#125; <span class="keyword">from</span> <span class="string">&#x27;fs&#x27;</span>;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">copy</span>(<span class="params">source, tagrget</span>) &#123;</span><br><span class="line">  <span class="title function_">readfile</span>(source, <span class="function">(<span class="params">err, data</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (err) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(data)</span><br><span class="line">     &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="title function_">writefile</span>(target)</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 案例三</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">effect</span>(<span class="params">text</span>) &#123;</span><br><span class="line">  <span class="variable language_">document</span>.<span class="title function_">write</span>(text)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>经过上面的3个例子大家应该页明白什么是函数的副作用了，函数的副作用其实可以简单的理解为函数在执行过程中对函数以外的外部环境造成了影响</p>
<h2 id="响应式数据"><a href="#响应式数据" class="headerlink" title="响应式数据"></a>响应式数据</h2><p>它能够自动地对数据的变化作出响应，以便更新与之相关的视图或操作。这种数据模型常常用于构建用户界面、数据流和事件驱动的应用程序，以确保界面和数据的实时同步。</p>
<p>我们简单的举个例子来理解一下</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> obj = &#123; <span class="attr">text</span>: <span class="string">&#x27;hello react&#x27;</span> &#125;;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">effect</span>(<span class="params"></span>)&#123;</span><br><span class="line">  <span class="variable language_">document</span>.<span class="property">body</span>.<span class="property">innerHtml</span> = obj.<span class="property">text</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">efffect</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 当 obj.text 发生改变时我们希望能够重新运行这个副作用函数</span></span><br><span class="line">obj.<span class="property">text</span> = <span class="string">&#x27;hello vue&#x27;</span></span><br></pre></td></tr></table></figure>
<p>如上面的代码所示，effect函数会设置body元素的innerHtml属性，当obj.text发生改变后我们希望能够重新运行副作用函数</p>
<p>要是我们能够知道obj.text的值发生改变后，重新运行副作用函数即可以实现</p>
<h3 id="响应式数据的基本实现"><a href="#响应式数据的基本实现" class="headerlink" title="响应式数据的基本实现"></a>响应式数据的基本实现</h3><p>我们来思考一下，如何才能让obj变为响应式数据呢，我们发现其中有2点至关重要</p>
<ul>
<li>当副作用函数effect运行时，会触发obj.text的读取操作</li>
<li>当修改obj.text会触发 obj.text的操作</li>
</ul>
<p>如果我们能拦截到对象obj的读取和设置操作，那么一切都变得简单了，整体流程如图所示</p>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2a68de4e69fe4c178f2efd8ea821de3a~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=1140&h=922&s=47738&e=png&b=18151e" alt="image.png"></p>
<ul>
<li>当effect函数运行时，我们将effect函数给存起来</li>
<li>当设置obj.text时我们再将副作用函数从桶中取出来并执行</li>
</ul>
<p>那么我们还有一个关键的问题没有解决如何拦截对象的读取草醉呢 我们可以采用proxy来进行拦截</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> obj = &#123; <span class="attr">text</span>: <span class="string">&#x27;hello react&#x27;</span> &#125;;</span><br><span class="line"><span class="keyword">const</span> proxyObj = <span class="keyword">new</span> <span class="title class_">Proxy</span>(obj, &#123;</span><br><span class="line">  <span class="comment">// 拦截对象属性读取操作</span></span><br><span class="line">  <span class="title function_">get</span>(<span class="params">target, key, receiver</span>) &#123;</span><br><span class="line">   <span class="keyword">return</span> <span class="title class_">Reflect</span>.<span class="title function_">get</span>(target, key, receiver)</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// 拦截对象属性的设置操作</span></span><br><span class="line">  <span class="title function_">set</span>(<span class="params">target, key, value, receiver</span>) &#123;</span><br><span class="line">   <span class="keyword">return</span> <span class="title class_">Reflect</span>.<span class="title function_">set</span>(target, key, value, receiver)</span><br><span class="line"> &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>有了上述这段代码我们也就很好的来实现了上述图片展示的逻辑</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> effects = [];</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">effect</span>(<span class="params"></span>)&#123;</span><br><span class="line"> <span class="variable language_">document</span>.<span class="property">body</span>.<span class="property">innerHtml</span> = obj.<span class="property">text</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 监听对象的读取操作</span></span><br><span class="line"> <span class="keyword">function</span> <span class="title function_">track</span>(<span class="params">target, key</span>)&#123;</span><br><span class="line">   effects.<span class="title function_">push</span>(effect);</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"> <span class="comment">// 对象设置触发的操作</span></span><br><span class="line"> <span class="keyword">function</span> <span class="title function_">trigger</span>(<span class="params">target, key, value</span>)&#123;</span><br><span class="line">   effects.<span class="title function_">forEach</span>(<span class="function"><span class="params">effect</span> =&gt;</span> <span class="title function_">effect</span>())</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"> <span class="keyword">const</span> obj = &#123; <span class="attr">text</span>: <span class="string">&#x27;hello react&#x27;</span> &#125;;</span><br><span class="line"> <span class="keyword">const</span> proxyObj = <span class="keyword">new</span> <span class="title class_">Proxy</span>(obj, &#123;</span><br><span class="line">   <span class="comment">// 拦截对象属性读取操作</span></span><br><span class="line">   <span class="title function_">get</span>(<span class="params">target, key, receiver</span>) &#123;</span><br><span class="line">     <span class="title function_">track</span>(target, key);</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Reflect</span>.<span class="title function_">get</span>(target, key, receiver)</span><br><span class="line">   &#125;,</span><br><span class="line">   <span class="comment">// 拦截对象属性的设置操作</span></span><br><span class="line">   <span class="title function_">set</span>(<span class="params">target, key, value, receiver</span>) &#123;</span><br><span class="line">    <span class="title function_">trigger</span>(target, key);</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Reflect</span>.<span class="title function_">set</span>(target, key, value, receiver)</span><br><span class="line">  &#125;,</span><br><span class="line"> &#125;)</span><br><span class="line"> </span><br><span class="line"> <span class="title function_">effect</span>();</span><br><span class="line"> </span><br><span class="line"> <span class="title class_">Promise</span>.<span class="title function_">resovle</span>().<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  obj.<span class="property">text</span> = <span class="string">&#x27;hello vue&#x27;</span>;</span><br><span class="line"> &#125;)</span><br><span class="line"> </span><br></pre></td></tr></table></figure>

<p>目前的实现存在很多缺陷，例如我们直接通过函数名字来获取副作用，以及会重复监听等问题，在下面一小节我们将着重来解决以上问题</p>
<h2 id="完善的响应式系统"><a href="#完善的响应式系统" class="headerlink" title="完善的响应式系统"></a>完善的响应式系统</h2><p>现在我们将来完善一下上述实现的响应式系统，通过本章学习将学习到如何构建完美的响应式系统</p>
<p>我们先来实现注册副作用函数部分</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> activeEffect = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">effect</span>(<span class="params">fn</span>) &#123;</span><br><span class="line">  activeEffect = fn;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接下来改造响应式数据部分</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 监听对象的读取操作</span></span><br><span class="line"> <span class="keyword">function</span> <span class="title function_">track</span>(<span class="params">target, key</span>)&#123;</span><br><span class="line">   effects.<span class="title function_">push</span>(activeEffect);</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"> <span class="comment">// 对象设置触发的操作</span></span><br><span class="line"> <span class="keyword">function</span> <span class="title function_">trigger</span>(<span class="params">target, key, value</span>)&#123;</span><br><span class="line">   effects.<span class="title function_">forEach</span>(<span class="function"><span class="params">effect</span> =&gt;</span> <span class="title function_">effect</span>())</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"> <span class="keyword">const</span> obj = &#123; <span class="attr">text</span>: <span class="string">&#x27;hello react&#x27;</span> &#125;;</span><br><span class="line"> <span class="keyword">const</span> proxyObj = <span class="keyword">new</span> <span class="title class_">Proxy</span>(obj, &#123;</span><br><span class="line">   <span class="comment">// 拦截对象属性读取操作</span></span><br><span class="line">   <span class="title function_">get</span>(<span class="params">target, key, receiver</span>) &#123;</span><br><span class="line">     <span class="title function_">track</span>(target, key);</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Reflect</span>.<span class="title function_">get</span>(target, key, receiver)</span><br><span class="line">   &#125;,</span><br><span class="line">   <span class="comment">// 拦截对象属性的设置操作</span></span><br><span class="line">   <span class="title function_">set</span>(<span class="params">target, key, value, receiver</span>) &#123;</span><br><span class="line">    <span class="title function_">trigger</span>(target, key);</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Reflect</span>.<span class="title function_">set</span>(target, key, value, receiver)</span><br><span class="line">  &#125;,</span><br><span class="line"> &#125;)</span><br></pre></td></tr></table></figure>
<p>经过上述改造我们再来看另外一个问题</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> obj = &#123; <span class="attr">foo</span>: <span class="string">&#x27;foo&#x27;</span>, <span class="attr">bar</span>: <span class="string">&#x27;bar&#x27;</span> &#125;;</span><br><span class="line"><span class="title function_">effect</span>(<span class="function">() =&gt;</span> &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(obj.<span class="property">foo</span>) &#125; );</span><br><span class="line">obj.<span class="property">bar</span> = <span class="string">&#x27;hello&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>我们发现当我们将obj.bar设置为hello，惊奇的发现副作用函数竟然运行了，其实我们希望副作用函数不应该运行</p>
<p>我们再来看一个例子</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">const</span> obj = &#123; <span class="attr">foo</span>: <span class="string">&#x27;foo&#x27;</span>, <span class="attr">bar</span>: <span class="string">&#x27;bar&#x27;</span> &#125;;</span><br><span class="line"> <span class="keyword">function</span> <span class="title function_">innerEffect</span>(<span class="params"></span>)&#123;</span><br><span class="line">   <span class="variable language_">console</span>.<span class="title function_">log</span>(obj,foo);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="title function_">effect</span>(innerEffect);</span><br><span class="line">  <span class="title function_">effect</span>(innerEffect);</span><br><span class="line">  </span><br><span class="line">obj.<span class="property">bar</span> = <span class="string">&#x27;hello&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>我们发现当effect传入的2个函数相同时，发现副作用函数运行了2次，其实这里我们更多的希望是能够运行一次</p>
<p>我们再来看一个例子</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">const</span> obj = &#123; <span class="attr">text</span>: <span class="string">&#x27;hello react&#x27;</span> &#125;;</span><br><span class="line"> <span class="keyword">const</span> obj1 = &#123; <span class="attr">text</span>: <span class="string">&#x27;hello react1&#x27;</span> &#125;;</span><br><span class="line"> </span><br><span class="line"> <span class="keyword">const</span> proxyObj = <span class="keyword">new</span> <span class="title class_">Proxy</span>(obj, &#123;</span><br><span class="line">   <span class="comment">// 拦截对象属性读取操作</span></span><br><span class="line">   <span class="title function_">get</span>(<span class="params">target, key, receiver</span>) &#123;</span><br><span class="line">     <span class="title function_">track</span>(target, key);</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Reflect</span>.<span class="title function_">get</span>(target, key, receiver)</span><br><span class="line">   &#125;,</span><br><span class="line">   <span class="comment">// 拦截对象属性的设置操作</span></span><br><span class="line">   <span class="title function_">set</span>(<span class="params">target, key, value, receiver</span>) &#123;</span><br><span class="line">    <span class="title function_">trigger</span>(target, key);</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Reflect</span>.<span class="title function_">set</span>(target, key, value, receiver)</span><br><span class="line">  &#125;,</span><br><span class="line"> &#125;)</span><br><span class="line"> </span><br><span class="line"> <span class="keyword">const</span> proxyObj1 = <span class="keyword">new</span> <span class="title class_">Proxy</span>(obj1, &#123;</span><br><span class="line">   <span class="comment">// 拦截对象属性读取操作</span></span><br><span class="line">   <span class="title function_">get</span>(<span class="params">target, key, receiver</span>) &#123;</span><br><span class="line">     <span class="title function_">track</span>(target, key);</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Reflect</span>.<span class="title function_">get</span>(target, key, receiver)</span><br><span class="line">   &#125;,</span><br><span class="line">   <span class="comment">// 拦截对象属性的设置操作</span></span><br><span class="line">   <span class="title function_">set</span>(<span class="params">target, key, value, receiver</span>) &#123;</span><br><span class="line">    <span class="title function_">trigger</span>(target, key);</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Reflect</span>.<span class="title function_">set</span>(target, key, value, receiver)</span><br><span class="line">  &#125;,</span><br><span class="line"> &#125;)</span><br><span class="line"> </span><br><span class="line">proxyObj1.<span class="property">text</span> = <span class="string">&#x27;hello vue&#x27;</span></span><br><span class="line"> </span><br></pre></td></tr></table></figure>
<p>我们发现即使proxyobj没有发生改变，但是还是会运行负副作用函数，主要是因为我们没有进行区分，将副作用和特定的对象进行绑定</p>
<h3 id="响应式系统的初步实现"><a href="#响应式系统的初步实现" class="headerlink" title="响应式系统的初步实现"></a>响应式系统的初步实现</h3><p>针对上述以上提出的3个问题，通过代以下代码进行解决</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> bucketMap = <span class="keyword">new</span> <span class="title class_">WeakMap</span>() <span class="comment">// 用来区分不同对象的副作用函数</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">track</span>(<span class="params">target, key</span>)&#123;</span><br><span class="line">     <span class="comment">// 没有副作用</span></span><br><span class="line">      <span class="keyword">if</span> (!activeEffect) &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 根据对象获取对应的副作用map</span></span><br><span class="line">      <span class="keyword">let</span> depsMap = bucketMap.<span class="title function_">get</span>(target);</span><br><span class="line">      <span class="keyword">if</span> (!depsMap) &#123;</span><br><span class="line">        depsMap = <span class="keyword">new</span> <span class="title class_">Map</span>();</span><br><span class="line">        bucketMap.<span class="title function_">set</span>(target, depsMap);</span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// 根据key获取对应的副作用集合</span></span><br><span class="line">      <span class="keyword">let</span> effects = depsMap.<span class="title function_">get</span>(key);</span><br><span class="line">      <span class="keyword">if</span> (!effects) &#123;</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// 对副作用函数做去重处理</span></span><br><span class="line">        effects = <span class="keyword">new</span> <span class="title class_">Set</span>();</span><br><span class="line">        depsMap.<span class="title function_">set</span>(key, effects);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      effects.<span class="title function_">add</span>(activeEffect);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">trigger</span>(<span class="params">target, key, value</span>)&#123; </span><br><span class="line">   <span class="comment">// 根据之前收集到集合的副作用函数来进行执行</span></span><br><span class="line">      <span class="keyword">const</span> depsMap = bucketMap.<span class="title function_">get</span>(target)</span><br><span class="line">      <span class="keyword">if</span> (!depsMap) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> effects = depsMap.<span class="title function_">get</span>(key);</span><br><span class="line">      effects &amp;&amp; effects.<span class="title function_">forEach</span>(<span class="function"><span class="params">effect</span> =&gt;</span> <span class="title function_">effect</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> obj = <span class="keyword">new</span> <span class="title class_">Proxy</span>(data, &#123;</span><br><span class="line">    <span class="title function_">get</span>(<span class="params">target, key, receiver</span>) &#123;</span><br><span class="line">    <span class="title function_">track</span>(target, key)</span><br><span class="line">      <span class="keyword">return</span> <span class="title class_">Reflect</span>.<span class="title function_">get</span>(target, key, receiver)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="title function_">set</span>(<span class="params">target, key, value, receiver</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> result = <span class="title class_">Reflect</span>.<span class="title function_">set</span>(target, key, value, receiver);</span><br><span class="line">      <span class="title function_">trigger</span>(target, key, value);</span><br><span class="line">      <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  </span><br></pre></td></tr></table></figure>
<p>将上述代码翻译成以下图片方便于理解，如图所示</p>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/13ba2f33a7134aa0afc81b944f3baa6e~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=998&h=954&s=37612&e=png&b=18151e" alt="image.png"></p>
<h3 id="分支切换与cleanup"><a href="#分支切换与cleanup" class="headerlink" title="分支切换与cleanup"></a>分支切换与cleanup</h3><p>首先我们明确分支切换的定义，如下图代码所示</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> obj = &#123; <span class="attr">isShow</span>: <span class="literal">true</span>, <span class="attr">text</span>: <span class="string">&#x27;hello react&#x27;</span> &#125;;</span><br><span class="line"><span class="title function_">effect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">document</span>.<span class="property">body</span>.<span class="property">innerHtml</span> = obj.<span class="property">isShow</span> ? obj.<span class="property">text</span> : <span class="string">&#x27;不显示&#x27;</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>在effect函数内部存在一个三元表达式，根据不同字段执行不同的逻辑，当isshow发生改变时代码执行的分支也会发生改变，这就是所谓的分支切换</p>
<p>我们来看一看此时副作用函数和响应式之间是怎么样的联系</p>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/643a560e43b94420ac255fa15a2f27d1~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=984&h=910&s=38164&e=png&b=18151e" alt="image.png"></p>
<p>我们再来看一下当将obj.isShow 修改为false时我们期望依赖的收集情况如图所示<br><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9722048c5308427a8531f09dc79f1064~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=982&h=808&s=31142&e=png&b=19161f" alt="image.png"></p>
<p>但实际的依赖收集情况如图所示</p>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/34641c61163341cea6fba565fe93a834~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=1022&h=824&s=37388&e=png&b=19161f" alt="image.png"></p>
<p>我们发现此时text的依赖收集其实不应该有依赖收集情况的，为了解决上述问题，我们每次进行依赖更新的时候都需需要重新收集依赖</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> activeEffect = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">effect</span>(<span class="params">fn</span>)&#123;</span><br><span class="line">    <span class="comment">// 新增依赖收集</span></span><br><span class="line">     <span class="keyword">const</span> <span class="title function_">innerEffect</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">     <span class="title function_">cleanup</span>(innerEffect);</span><br><span class="line">     activeEffect = innerEffect;</span><br><span class="line">       <span class="title function_">fn</span>();</span><br><span class="line">     &#125;</span><br><span class="line"> effect.<span class="property">deps</span> = [];</span><br><span class="line"> <span class="title function_">innerEffect</span>()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 清除依赖收集</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">cleanup</span>(<span class="params">effectFn</span>)&#123;</span><br><span class="line">  <span class="keyword">const</span> deps = effectFn.<span class="property">deps</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; deps.<span class="property">length</span>; i++) &#123;</span><br><span class="line">    <span class="keyword">const</span> depSet = deps[i];</span><br><span class="line">    depset.<span class="title function_">delete</span>(effectFn);</span><br><span class="line">  &#125;</span><br><span class="line">  deps.<span class="property">length</span> = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> bucketMap = <span class="keyword">new</span> <span class="title class_">WeakMap</span>() <span class="comment">// 用来区分不同对象的副作用函数</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">track</span>(<span class="params">target, key</span>)&#123;</span><br><span class="line">     <span class="comment">// 没有副作用</span></span><br><span class="line">      <span class="keyword">if</span> (!activeEffect) &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 根据对象获取对应的副作用map</span></span><br><span class="line">      <span class="keyword">let</span> depsMap = bucketMap.<span class="title function_">get</span>(target);</span><br><span class="line">      <span class="keyword">if</span> (!depsMap) &#123;</span><br><span class="line">        depsMap = <span class="keyword">new</span> <span class="title class_">Map</span>();</span><br><span class="line">        bucketMap.<span class="title function_">set</span>(target, depsMap);</span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// 根据key获取对应的副作用集合</span></span><br><span class="line">      <span class="keyword">let</span> effects = depsMap.<span class="title function_">get</span>(key);</span><br><span class="line">      <span class="keyword">if</span> (!effects) &#123;</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// 对副作用函数做去重处理</span></span><br><span class="line">        effects = <span class="keyword">new</span> <span class="title class_">Set</span>();</span><br><span class="line">        depsMap.<span class="title function_">set</span>(key, effects);</span><br><span class="line">        </span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      effects.<span class="title function_">add</span>(activeEffect);</span><br><span class="line">      <span class="comment">// 新增依赖收集</span></span><br><span class="line">      activeEffect.<span class="property">deps</span>.<span class="title function_">push</span>(effects);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">trigger</span>(<span class="params">target, key, value</span>)&#123; </span><br><span class="line">   <span class="comment">// 根据之前收集到集合的副作用函数来进行执行</span></span><br><span class="line">      <span class="keyword">const</span> depsMap = bucketMap.<span class="title function_">get</span>(target)</span><br><span class="line">      <span class="keyword">if</span> (!depsMap) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> effects = depsMap.<span class="title function_">get</span>(key);</span><br><span class="line">      </span><br><span class="line">     <span class="comment">// 避免依赖在删除和添加过程中死循环</span></span><br><span class="line">     <span class="keyword">const</span> effectsToRun = <span class="keyword">new</span> <span class="title class_">Set</span>(effects); </span><br><span class="line">     effectsToRun.<span class="title function_">forEach</span>(<span class="function"><span class="params">effect</span> =&gt;</span> <span class="title function_">effect</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> obj = <span class="keyword">new</span> <span class="title class_">Proxy</span>(data, &#123;</span><br><span class="line">    <span class="title function_">get</span>(<span class="params">target, key, receiver</span>) &#123;</span><br><span class="line">    <span class="title function_">track</span>(target, key)</span><br><span class="line">      <span class="keyword">return</span> <span class="title class_">Reflect</span>.<span class="title function_">get</span>(target, key, receiver)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="title function_">set</span>(<span class="params">target, key, value, receiver</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> result = <span class="title class_">Reflect</span>.<span class="title function_">set</span>(target, key, value, receiver);</span><br><span class="line">      <span class="title function_">trigger</span>(target, key, value);</span><br><span class="line">      <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="嵌套的effect和effect函数栈"><a href="#嵌套的effect和effect函数栈" class="headerlink" title="嵌套的effect和effect函数栈"></a>嵌套的effect和effect函数栈</h3><p>   其实在vue中effect是可以嵌套的，主要是因为组件之间时可以发生嵌套的，组件的挂载或者更新其实是发生在effect中的<br>   <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">effect</span>(<span class="function">() =&gt;</span>&#123;</span><br><span class="line"> <span class="title function_">effect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">   <span class="title function_">effect</span>();</span><br><span class="line"> &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<p>  按照嵌套环境来我们的响应式系统其实并不支持effect嵌套的</p>
  <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> bar = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">let</span> foo = <span class="literal">null</span>;</span><br><span class="line"><span class="title function_">effect</span>(<span class="function">() =&gt;</span>&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;effect1&#x27;</span>);</span><br><span class="line">    <span class="title function_">effecct</span>(<span class="function">() =&gt;</span>&#123;</span><br><span class="line">     <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;effect2&#x27;</span>);</span><br><span class="line">     bar = obj.<span class="property">bar</span>;</span><br><span class="line">    &#125;)</span><br><span class="line">    foo = obj.<span class="property">foo</span>;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>  我们发现上述代码共执行3次，第一次是执行effect1， 第二次是执行effect2, 第三次执行是effect2<br>  按照正常逻辑我们其实是希望执行effect1,因为我们是在外层执行obj.foo的，这显然和我们期望的结果是   违背的，为了解决上面问题，我们需要来分析effect执行的情况是怎么样的，在探讨effect是如何执行的我们需要先搞清一个东西那就是函数执行栈</p>
<h3 id="函数的执行栈"><a href="#函数的执行栈" class="headerlink" title="函数的执行栈"></a>函数的执行栈</h3><p>  函数执行栈（Function Call Stack），通常简称为执行栈，是计算机程序执行函数调用和返回的一种数据结构。它以栈（stack）的形式组织函数调用的顺序，遵循后进先出（Last-In, First-Out，LIFO）的原则。执行栈在程序运行中起着重要的作用，用于跟踪函数调用的层次和控制程序的执行流程</p>
<table>
<thead>
<tr>
<th>特点</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>函数调用顺序</td>
<td>函数按照调用顺序依次推入执行栈的顶部，维护函数调用的堆栈。</td>
</tr>
<tr>
<td>函数执行</td>
<td>执行栈中的函数被处理，包括变量分配、操作执行和其他操作。</td>
</tr>
<tr>
<td>返回值</td>
<td>函数执行完成后，从执行栈中弹出，并将返回值传递给调用者函数。</td>
</tr>
<tr>
<td>嵌套调用</td>
<td>如果函数内部调用其他函数，新函数被推入执行栈，直到执行完毕返回。</td>
</tr>
<tr>
<td>递归</td>
<td>递归函数会多次调用自身，导致多个函数调用堆叠在执行栈中。</td>
</tr>
<tr>
<td>栈溢出</td>
<td>如果执行栈变得过大，可能导致栈溢出错误。</td>
</tr>
</tbody></table>
<p>结合函数执行栈我们来分析effect的整个执行过程如图所示</p>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/92b9070790ed423b8ed27eb51d3134bc~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=1164&h=732&s=35990&e=png&b=17141d" alt="image.png"></p>
<ul>
<li>在执行effect1时将effect1放入栈中</li>
<li>在执行effect2时将effect2放入栈中</li>
<li>函数压栈完毕</li>
<li>effect2执行完毕将effect2从栈中弹出</li>
<li>effect1执行完毕将effect1从栈中弹出</li>
</ul>
<p>根据上述规律我们也受到了启发，我们是否能够将activeEffect和effect对应的执行栈一一对应，是不是就能解决effect嵌套问题了呢</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> activeEffect = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// activeEffect执行栈</span></span><br><span class="line"><span class="keyword">const</span> activeEffectStack = [];</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">effect</span>(<span class="params">fn</span>)&#123;</span><br><span class="line">    <span class="comment">// 新增依赖收集</span></span><br><span class="line">     <span class="keyword">const</span> <span class="title function_">innerEffect</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">     <span class="title function_">cleanup</span>(innerEffect);</span><br><span class="line">     activeEffect = innerEffect;</span><br><span class="line">     </span><br><span class="line">     <span class="comment">//新增 将activeEffect入栈</span></span><br><span class="line">     activeEffectStack.<span class="title function_">push</span>(activeEffect);</span><br><span class="line">       <span class="title function_">fn</span>();</span><br><span class="line">      <span class="comment">// 新增 将activeEffect出栈</span></span><br><span class="line">      activeEffectStack.<span class="title function_">pop</span>();</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// 新增 取出栈顶元素</span></span><br><span class="line">      activeEffect =  activeEffectStack[activeEffectStack.<span class="property">length</span> - <span class="number">1</span>];</span><br><span class="line">  </span><br><span class="line">     &#125;</span><br><span class="line"> effect.<span class="property">deps</span> = [];</span><br><span class="line"> <span class="title function_">innerEffect</span>()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 清除依赖收集</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">cleanup</span>(<span class="params">effectFn</span>)&#123;</span><br><span class="line">  <span class="keyword">const</span> deps = effectFn.<span class="property">deps</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; deps.<span class="property">length</span>; i++) &#123;</span><br><span class="line">    <span class="keyword">const</span> depSet = deps[i];</span><br><span class="line">    depset.<span class="title function_">delete</span>(effectFn);</span><br><span class="line">  &#125;</span><br><span class="line">  deps.<span class="property">length</span> = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> bucketMap = <span class="keyword">new</span> <span class="title class_">WeakMap</span>() <span class="comment">// 用来区分不同对象的副作用函数</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">track</span>(<span class="params">target, key</span>)&#123;</span><br><span class="line">     <span class="comment">// 没有副作用</span></span><br><span class="line">      <span class="keyword">if</span> (!activeEffect) &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 根据对象获取对应的副作用map</span></span><br><span class="line">      <span class="keyword">let</span> depsMap = bucketMap.<span class="title function_">get</span>(target);</span><br><span class="line">      <span class="keyword">if</span> (!depsMap) &#123;</span><br><span class="line">        depsMap = <span class="keyword">new</span> <span class="title class_">Map</span>();</span><br><span class="line">        bucketMap.<span class="title function_">set</span>(target, depsMap);</span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// 根据key获取对应的副作用集合</span></span><br><span class="line">      <span class="keyword">let</span> effects = depsMap.<span class="title function_">get</span>(key);</span><br><span class="line">      <span class="keyword">if</span> (!effects) &#123;</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// 对副作用函数做去重处理</span></span><br><span class="line">        effects = <span class="keyword">new</span> <span class="title class_">Set</span>();</span><br><span class="line">        depsMap.<span class="title function_">set</span>(key, effects);</span><br><span class="line">        </span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      effects.<span class="title function_">add</span>(activeEffect);</span><br><span class="line">      <span class="comment">// 新增依赖收集</span></span><br><span class="line">      activeEffect.<span class="property">deps</span>.<span class="title function_">push</span>(effects);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">trigger</span>(<span class="params">target, key, value</span>)&#123; </span><br><span class="line">   <span class="comment">// 根据之前收集到集合的副作用函数来进行执行</span></span><br><span class="line">      <span class="keyword">const</span> depsMap = bucketMap.<span class="title function_">get</span>(target)</span><br><span class="line">      <span class="keyword">if</span> (!depsMap) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> effects = depsMap.<span class="title function_">get</span>(key);</span><br><span class="line">      </span><br><span class="line">     <span class="comment">// 避免依赖在删除和添加过程中死循环</span></span><br><span class="line">     <span class="keyword">const</span> effectsToRun = <span class="keyword">new</span> <span class="title class_">Set</span>(effects); </span><br><span class="line">     effectsToRun.<span class="title function_">forEach</span>(<span class="function"><span class="params">effect</span> =&gt;</span> <span class="title function_">effect</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> obj = <span class="keyword">new</span> <span class="title class_">Proxy</span>(data, &#123;</span><br><span class="line">    <span class="title function_">get</span>(<span class="params">target, key, receiver</span>) &#123;</span><br><span class="line">    <span class="title function_">track</span>(target, key)</span><br><span class="line">      <span class="keyword">return</span> <span class="title class_">Reflect</span>.<span class="title function_">get</span>(target, key, receiver)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="title function_">set</span>(<span class="params">target, key, value, receiver</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> result = <span class="title class_">Reflect</span>.<span class="title function_">set</span>(target, key, value, receiver);</span><br><span class="line">      <span class="title function_">trigger</span>(target, key, value);</span><br><span class="line">      <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">    &#125;)</span><br></pre></td></tr></table></figure>
<h3 id="无限递归循环"><a href="#无限递归循环" class="headerlink" title="无限递归循环"></a>无限递归循环</h3><p>我们还剩余最后一个细节需要考虑，那就是无限递归的情况，我们来思考以下这段代码</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> obj= &#123; <span class="attr">count</span>: <span class="number">0</span> &#125;;</span><br><span class="line"><span class="title function_">effect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line"> obj.<span class="property">count</span>++;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>我们发现这段代码会导致死循环，主要是因为即读取了obj.count 又设置了obj.count 这样就会导致无限递归调用自己，解决办法也不是很难，我们只要在trigger函数里进行判断是不是自己调用自己</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"> </span><br><span class="line"><span class="keyword">function</span> <span class="title function_">trigger</span>(<span class="params">target, key, value</span>)&#123; </span><br><span class="line">   <span class="comment">// 根据之前收集到集合的副作用函数来进行执行</span></span><br><span class="line">      <span class="keyword">const</span> depsMap = bucketMap.<span class="title function_">get</span>(target)</span><br><span class="line">      <span class="keyword">if</span> (!depsMap) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> effects = depsMap.<span class="title function_">get</span>(key);</span><br><span class="line">      </span><br><span class="line">     <span class="comment">// 避免依赖在删除和添加过程中死循环</span></span><br><span class="line">     <span class="keyword">const</span> effectsToRun = <span class="keyword">new</span> <span class="title class_">Set</span>(effects); </span><br><span class="line">     effectsToRun.<span class="title function_">forEach</span>(<span class="function"><span class="params">effect</span> =&gt;</span> &#123;</span><br><span class="line">     </span><br><span class="line">       <span class="comment">//新增 自己调用自己时进行拦截</span></span><br><span class="line">       <span class="keyword">if</span> (activeEffect !== effect)&#123;</span><br><span class="line">         <span class="title function_">effect</span>();</span><br><span class="line">       &#125;</span><br><span class="line">     &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>根据以上几个问题的优化我们给出下面的最终代码</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">let</span> activeEffect = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// activeEffect执行栈</span></span><br><span class="line"><span class="keyword">const</span> activeEffectStack = [];</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">effect</span>(<span class="params">fn</span>)&#123;</span><br><span class="line">     <span class="keyword">const</span> <span class="title function_">innerEffect</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">         <span class="title function_">cleanup</span>(innerEffect);</span><br><span class="line">         activeEffect = innerEffect;</span><br><span class="line">    </span><br><span class="line">         activeEffectStack.<span class="title function_">push</span>(activeEffect);</span><br><span class="line">         <span class="title function_">fn</span>();</span><br><span class="line">      </span><br><span class="line">         activeEffectStack.<span class="title function_">pop</span>();</span><br><span class="line">         activeEffect =  activeEffectStack[activeEffectStack.<span class="property">length</span> - <span class="number">1</span>];</span><br><span class="line">  </span><br><span class="line">     &#125;</span><br><span class="line"> effect.<span class="property">deps</span> = [];</span><br><span class="line"> <span class="title function_">innerEffect</span>()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 清除依赖收集</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">cleanup</span>(<span class="params">effectFn</span>)&#123;</span><br><span class="line">  <span class="keyword">const</span> deps = effectFn.<span class="property">deps</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; deps.<span class="property">length</span>; i++) &#123;</span><br><span class="line">    <span class="keyword">const</span> depSet = deps[i];</span><br><span class="line">    depset.<span class="title function_">delete</span>(effectFn);</span><br><span class="line">  &#125;</span><br><span class="line">  deps.<span class="property">length</span> = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> bucketMap = <span class="keyword">new</span> <span class="title class_">WeakMap</span>() <span class="comment">// 用来区分不同对象的副作用函数</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">track</span>(<span class="params">target, key</span>)&#123;</span><br><span class="line">      <span class="keyword">if</span> (!activeEffect) &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">let</span> depsMap = bucketMap.<span class="title function_">get</span>(target);</span><br><span class="line">      <span class="keyword">if</span> (!depsMap) &#123;</span><br><span class="line">        depsMap = <span class="keyword">new</span> <span class="title class_">Map</span>();</span><br><span class="line">        bucketMap.<span class="title function_">set</span>(target, depsMap);</span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">let</span> effects = depsMap.<span class="title function_">get</span>(key);</span><br><span class="line">      <span class="keyword">if</span> (!effects) &#123;</span><br><span class="line">      </span><br><span class="line">        effects = <span class="keyword">new</span> <span class="title class_">Set</span>();</span><br><span class="line">        depsMap.<span class="title function_">set</span>(key, effects);</span><br><span class="line">        </span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      effects.<span class="title function_">add</span>(activeEffect);</span><br><span class="line">      activeEffect.<span class="property">deps</span>.<span class="title function_">push</span>(effects);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">trigger</span>(<span class="params">target, key, value</span>)&#123;</span><br><span class="line">      <span class="keyword">const</span> depsMap = bucketMap.<span class="title function_">get</span>(target)</span><br><span class="line">      <span class="keyword">if</span> (!depsMap) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">const</span> effects = depsMap.<span class="title function_">get</span>(key);</span><br><span class="line">     <span class="keyword">const</span> effectsToRun = <span class="keyword">new</span> <span class="title class_">Set</span>(effects); </span><br><span class="line">     effectsToRun.<span class="title function_">forEach</span>(<span class="function"><span class="params">effect</span> =&gt;</span> &#123;</span><br><span class="line">     </span><br><span class="line">       <span class="comment">//新增 自己调用自己时进行拦截</span></span><br><span class="line">       <span class="keyword">if</span> (activeEffect !== effect)&#123;</span><br><span class="line">         <span class="title function_">effect</span>();</span><br><span class="line">       &#125;</span><br><span class="line">     &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> obj = <span class="keyword">new</span> <span class="title class_">Proxy</span>(data, &#123;</span><br><span class="line">    <span class="title function_">get</span>(<span class="params">target, key, receiver</span>) &#123;</span><br><span class="line">    <span class="title function_">track</span>(target, key)</span><br><span class="line">      <span class="keyword">return</span> <span class="title class_">Reflect</span>.<span class="title function_">get</span>(target, key, receiver)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="title function_">set</span>(<span class="params">target, key, value, receiver</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> result = <span class="title class_">Reflect</span>.<span class="title function_">set</span>(target, key, value, receiver);</span><br><span class="line">      <span class="title function_">trigger</span>(target, key, value);</span><br><span class="line">      <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">    &#125;)</span><br></pre></td></tr></table></figure>

<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ul>
<li>我们了解到了什么是函数的定副作用以及函数的副作用和响应式系统有什么联系</li>
<li>我们通过proxy进行代理了对象的属性读取和赋值操作给出了第一版的响应式系统基本代码</li>
<li>通过分支的切换和清除完善了响应式系统</li>
<li>通过分析函数调用栈道关系解决了effect副作用函数嵌套问题</li>
<li>通过增加自身调用时不触发副作用函数的执行来避免无限递归的循环问题</li>
</ul>
<p>后续我们将继续完善响应式系统，主要来实现vue3响应式系统中的一些api</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://imperial-long.github.io/blog/2024/02/06/vue3%E5%93%8D%E5%BA%94%E5%BC%8F%E8%AE%BE%E8%AE%A12/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="朱广龙">
      <meta itemprop="description" content="定期会更新前端技术栈 不限于vue，react，node以及部分后端的知识">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="朱广龙的个人博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2024/02/06/vue3%E5%93%8D%E5%BA%94%E5%BC%8F%E8%AE%BE%E8%AE%A12/" class="post-title-link" itemprop="url">vu3响应式实现（2）</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-02-06 20:39:00" itemprop="dateCreated datePublished" datetime="2024-02-06T20:39:00+08:00">2024-02-06</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-10-10 13:19:52" itemprop="dateModified" datetime="2024-10-10T13:19:52+08:00">2024-10-10</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="前面回顾"><a href="#前面回顾" class="headerlink" title="前面回顾"></a>前面回顾</h1><p>在vue3响应式系统实现的一，我们通过解决在实现过程中遇到的一些问题实现了一个相对比较完善的vue3响应式系统，本章节我们通过上节实现的响应式系统来完成vue3相关的api进行实现<br>为方便大家进行回顾，如下代码实现了第一小节</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">let</span> activeEffect = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// activeEffect执行栈</span></span><br><span class="line"><span class="keyword">const</span> activeEffectStack = [];</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">effect</span>(<span class="params">fn</span>)&#123;</span><br><span class="line">     <span class="keyword">const</span> <span class="title function_">innerEffect</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">         <span class="title function_">cleanup</span>(innerEffect);</span><br><span class="line">         activeEffect = innerEffect;</span><br><span class="line">    </span><br><span class="line">         activeEffectStack.<span class="title function_">push</span>(activeEffect);</span><br><span class="line">         <span class="title function_">fn</span>();</span><br><span class="line">      </span><br><span class="line">         activeEffectStack.<span class="title function_">pop</span>();</span><br><span class="line">         activeEffect =  activeEffectStack[activeEffectStack.<span class="property">length</span> - <span class="number">1</span>];</span><br><span class="line">  </span><br><span class="line">     &#125;</span><br><span class="line"> effect.<span class="property">deps</span> = [];</span><br><span class="line"> <span class="title function_">innerEffect</span>()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 清除依赖收集</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">cleanup</span>(<span class="params">effectFn</span>)&#123;</span><br><span class="line">  <span class="keyword">const</span> deps = effectFn.<span class="property">deps</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; deps.<span class="property">length</span>; i++) &#123;</span><br><span class="line">    <span class="keyword">const</span> depSet = deps[i];</span><br><span class="line">    depset.<span class="title function_">delete</span>(effectFn);</span><br><span class="line">  &#125;</span><br><span class="line">  deps.<span class="property">length</span> = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> bucketMap = <span class="keyword">new</span> <span class="title class_">WeakMap</span>() <span class="comment">// 用来区分不同对象的副作用函数</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">track</span>(<span class="params">target, key</span>)&#123;</span><br><span class="line">      <span class="keyword">if</span> (!activeEffect) &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">let</span> depsMap = bucketMap.<span class="title function_">get</span>(target);</span><br><span class="line">      <span class="keyword">if</span> (!depsMap) &#123;</span><br><span class="line">        depsMap = <span class="keyword">new</span> <span class="title class_">Map</span>();</span><br><span class="line">        bucketMap.<span class="title function_">set</span>(target, depsMap);</span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">let</span> effects = depsMap.<span class="title function_">get</span>(key);</span><br><span class="line">      <span class="keyword">if</span> (!effects) &#123;</span><br><span class="line">      </span><br><span class="line">        effects = <span class="keyword">new</span> <span class="title class_">Set</span>();</span><br><span class="line">        depsMap.<span class="title function_">set</span>(key, effects);</span><br><span class="line">        </span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      effects.<span class="title function_">add</span>(activeEffect);</span><br><span class="line">      activeEffect.<span class="property">deps</span>.<span class="title function_">push</span>(effects);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">trigger</span>(<span class="params">target, key, value</span>)&#123;</span><br><span class="line">      <span class="keyword">const</span> depsMap = bucketMap.<span class="title function_">get</span>(target)</span><br><span class="line">      <span class="keyword">if</span> (!depsMap) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">const</span> effects = depsMap.<span class="title function_">get</span>(key);</span><br><span class="line">     <span class="keyword">const</span> effectsToRun = <span class="keyword">new</span> <span class="title class_">Set</span>(effects); </span><br><span class="line">     effectsToRun.<span class="title function_">forEach</span>(<span class="function"><span class="params">effect</span> =&gt;</span> &#123;</span><br><span class="line">     </span><br><span class="line">       <span class="comment">//新增 自己调用自己时进行拦截</span></span><br><span class="line">       <span class="keyword">if</span> (activeEffect !== effect)&#123;</span><br><span class="line">         <span class="title function_">effect</span>();</span><br><span class="line">       &#125;</span><br><span class="line">     &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> obj = <span class="keyword">new</span> <span class="title class_">Proxy</span>(data, &#123;</span><br><span class="line">    <span class="title function_">get</span>(<span class="params">target, key, receiver</span>) &#123;</span><br><span class="line">    <span class="title function_">track</span>(target, key)</span><br><span class="line">      <span class="keyword">return</span> <span class="title class_">Reflect</span>.<span class="title function_">get</span>(target, key, receiver)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="title function_">set</span>(<span class="params">target, key, value, receiver</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> result = <span class="title class_">Reflect</span>.<span class="title function_">set</span>(target, key, value, receiver);</span><br><span class="line">      <span class="title function_">trigger</span>(target, key, value);</span><br><span class="line">      <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="调度执行"><a href="#调度执行" class="headerlink" title="调度执行"></a>调度执行</h2><p>什么是调度执行,所谓的调度执行指的是triger函数动作触发副作用执行重新执行时，有权力去决定副作用函数执行的时机，次数以及方式</p>
<p>我们有一个需求我们需要知道知道trigger函数什么时候执行完毕，针对上述需求我们的代码如图所示</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> obj =&#123; <span class="attr">name</span>: <span class="string">&#x27;hello react&#x27;</span> &#125;;</span><br><span class="line"><span class="title function_">effect</span>(<span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(obj.<span class="property">name</span>));</span><br><span class="line"></span><br><span class="line">obj.<span class="property">name</span> = <span class="string">&#x27;hello vue&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;trigger执行结束了&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>现在我们需求有变，需要在触发trigger之前进行打印，有没有什么办法不需要改动代码就能实现呢，这里我们可以利用函数式编程的思想给effect函数增加scheduler函数</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">effect</span>(<span class="params">fn， scheduler</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">innerEffect</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">        <span class="title function_">cleanup</span>(innerEffect);</span><br><span class="line">        activeEffect = innerEffect;</span><br><span class="line">   </span><br><span class="line">        activeEffectStack.<span class="title function_">push</span>(activeEffect);</span><br><span class="line">        <span class="title function_">fn</span>();</span><br><span class="line">     </span><br><span class="line">        activeEffectStack.<span class="title function_">pop</span>();</span><br><span class="line">        activeEffect =  activeEffectStack[activeEffectStack.<span class="property">length</span> - <span class="number">1</span>];</span><br><span class="line"> </span><br><span class="line">    &#125;</span><br><span class="line">effect.<span class="property">deps</span> = [];</span><br><span class="line">effect.<span class="property">sceduler</span> = scheduler <span class="comment">// 新增代码</span></span><br><span class="line"><span class="title function_">innerEffect</span>()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们只需要判断是不是传递来scheduler，将对副作用的触发控制权交给用户的输入来决定</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">trigger</span>(<span class="params">target, key, value</span>)&#123;</span><br><span class="line">      <span class="keyword">const</span> depsMap = bucketMap.<span class="title function_">get</span>(target)</span><br><span class="line">      <span class="keyword">if</span> (!depsMap) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">const</span> effects = depsMap.<span class="title function_">get</span>(key);</span><br><span class="line">     <span class="keyword">const</span> effectsToRun = <span class="keyword">new</span> <span class="title class_">Set</span>(effects); </span><br><span class="line">     effectsToRun.<span class="title function_">forEach</span>(<span class="function"><span class="params">effect</span> =&gt;</span> &#123;</span><br><span class="line">     </span><br><span class="line">       <span class="comment">//新增 自己调用自己时进行拦截</span></span><br><span class="line">       <span class="keyword">if</span> (activeEffect !== effect)&#123;</span><br><span class="line">         <span class="keyword">if</span>(effect.<span class="property">scheduler</span>) &#123;</span><br><span class="line">          effect.<span class="title function_">scheduler</span>(effect) <span class="comment">// 将副作用的执行权进行移交</span></span><br><span class="line">         &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           <span class="title function_">effect</span>()</span><br><span class="line">         &#125;</span><br><span class="line">       &#125;</span><br><span class="line">     &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如上代码我们就实现了用户对副作用函数的控制权</p>
<p>我们再来看一个需求，有时候其实副作用的中间状态我们并关心，我们更多关系的是最终状态</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> obj =&#123; <span class="attr">count</span>: <span class="number">0</span> &#125;;</span><br><span class="line"> <span class="title function_">effect</span>(<span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(obj.<span class="property">count</span>));</span><br><span class="line"> </span><br><span class="line"> obj.<span class="property">count</span>++;</span><br><span class="line"> obj.<span class="property">count</span>++;</span><br><span class="line"> </span><br></pre></td></tr></table></figure>

<p>我们来分析上面的代码我们发现最终会打印 0，1，2，此时我们需要实现打印的效果是0，3也就是中间状态我们不需要关心我们应该怎么去解决呢，其实解决办法也很简单我们可以利用js函数异步的特点来进行解决如下代码所示</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> jobQueue = <span class="keyword">new</span> <span class="title class_">Set</span>();</span><br><span class="line"><span class="keyword">let</span> isFlushing = <span class="literal">false</span>; <span class="comment">// 是否要刷新队列</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">flushJob</span>(<span class="params"></span>) &#123;</span><br><span class="line"> <span class="keyword">if</span> (isFlushing) &#123;</span><br><span class="line">   <span class="keyword">return</span></span><br><span class="line"> &#125;</span><br><span class="line"> isFlushing = <span class="literal">true</span>;</span><br><span class="line"> <span class="title class_">Promise</span>.<span class="title function_">resove</span>().<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  jobQueue.<span class="title function_">forEach</span>(<span class="function"><span class="params">job</span> =&gt;</span> <span class="title function_">job</span>())</span><br><span class="line"> &#125;).<span class="title function_">catch</span>((e) &#123;</span><br><span class="line">   <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(e);</span><br><span class="line">  &#125;).<span class="title function_">finally</span>(<span class="function">() =&gt;</span> isFlushing = <span class="literal">false</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">effect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(obj.<span class="property">count</span>)</span><br><span class="line">&#125;, <span class="function">(<span class="params">fn</span>) =&gt;</span> &#123;</span><br><span class="line"> jobQueue.<span class="title function_">add</span>(fn);</span><br><span class="line"> <span class="title function_">flushJob</span>();</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>从上面代码也可以看出上述这段代码有点在vue中批量更新的那点味道了，多次修改响应式数据但只会触发一次更新</p>
<h2 id="计算属性computed和lazy"><a href="#计算属性computed和lazy" class="headerlink" title="计算属性computed和lazy"></a>计算属性computed和lazy</h2><h3 id="懒执行的副作用函数"><a href="#懒执行的副作用函数" class="headerlink" title="懒执行的副作用函数"></a>懒执行的副作用函数</h3><p>我们前面通过给副作用函数指定了schedule函数实现了用户对effect副作用函数的控制权，本节我们还需要增加其他参数，因此将上述代码进行改造如下所示</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">effect</span>(<span class="params">fn， options = &#123;&#125;</span>) &#123;</span><br><span class="line">   <span class="keyword">const</span> <span class="title function_">innerEffect</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">         <span class="title function_">cleanup</span>(innerEffect);</span><br><span class="line">         activeEffect = innerEffect;</span><br><span class="line">    </span><br><span class="line">         activeEffectStack.<span class="title function_">push</span>(activeEffect);</span><br><span class="line">         <span class="title function_">fn</span>();</span><br><span class="line">      </span><br><span class="line">         activeEffectStack.<span class="title function_">pop</span>();</span><br><span class="line">         activeEffect =  activeEffectStack[activeEffectStack.<span class="property">length</span> - <span class="number">1</span>];</span><br><span class="line">  </span><br><span class="line">     &#125;</span><br><span class="line"> effect.<span class="property">deps</span> = [];</span><br><span class="line"> effect.<span class="property">options</span> = options <span class="comment">// 改造部分</span></span><br><span class="line"> <span class="title function_">innerEffect</span>()</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"> <span class="keyword">function</span> <span class="title function_">trigger</span>(<span class="params">target, key, value</span>)&#123;</span><br><span class="line">      <span class="keyword">const</span> depsMap = bucketMap.<span class="title function_">get</span>(target)</span><br><span class="line">      <span class="keyword">if</span> (!depsMap) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">const</span> effects = depsMap.<span class="title function_">get</span>(key);</span><br><span class="line">     <span class="keyword">const</span> effectsToRun = <span class="keyword">new</span> <span class="title class_">Set</span>(effects); </span><br><span class="line">     effectsToRun.<span class="title function_">forEach</span>(<span class="function"><span class="params">effect</span> =&gt;</span> &#123;</span><br><span class="line">     </span><br><span class="line">       <span class="keyword">if</span> (activeEffect !== effect)&#123;</span><br><span class="line">         <span class="keyword">if</span>(effect.<span class="property">options</span>.<span class="property">scheduler</span>) &#123; <span class="comment">// 改造部分</span></span><br><span class="line">          effect.<span class="property">options</span>.<span class="title function_">scheduler</span>(effect) <span class="comment">// 改造部分</span></span><br><span class="line">         &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           <span class="title function_">effect</span>()</span><br><span class="line">         &#125;</span><br><span class="line">       &#125;</span><br><span class="line">     &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在开始实现计算属性之前，我们来看一下关于懒执行的effect，什么是懒执行呢，顾名思义就是我们不让副作用函数立即执行，举个例子如下代码所示</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> obj =&#123; <span class="attr">count</span>: <span class="number">0</span> &#125;;</span><br><span class="line"><span class="keyword">const</span> effectFn =  <span class="title function_">effect</span>(<span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(obj.<span class="property">count</span>));</span><br><span class="line"> obj.<span class="property">count</span>++;</span><br><span class="line"> </span><br><span class="line"> <span class="title function_">effectFn</span>() <span class="comment">// 只有当外界运行effectFn函数才会执行副作用函数，否则一直不会执行</span></span><br></pre></td></tr></table></figure>

<p>为了实现上述代码，我们需要额外增加一个参数用来控制是否返回一个函数</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">effect</span>(<span class="params">fn， options = &#123;&#125;</span>) &#123;</span><br><span class="line">   <span class="keyword">const</span> <span class="title function_">innerEffect</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">         <span class="title function_">cleanup</span>(innerEffect);</span><br><span class="line">         activeEffect = innerEffect;</span><br><span class="line">    </span><br><span class="line">         activeEffectStack.<span class="title function_">push</span>(activeEffect);</span><br><span class="line">         </span><br><span class="line">      </span><br><span class="line">         activeEffectStack.<span class="title function_">pop</span>();</span><br><span class="line">         activeEffect =  activeEffectStack[activeEffectStack.<span class="property">length</span> - <span class="number">1</span>];</span><br><span class="line">  </span><br><span class="line">     &#125;</span><br><span class="line"> effect.<span class="property">deps</span> = [];</span><br><span class="line"> effect.<span class="property">options</span> = options <span class="comment">// 改造部分</span></span><br><span class="line"> <span class="keyword">if</span> (options.<span class="property">lazy</span>) &#123;</span><br><span class="line">   <span class="keyword">return</span> <span class="title function_">innerEffect</span>()</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="title function_">innerEffect</span>()</span><br><span class="line">  &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<h3 id="computed的实现"><a href="#computed的实现" class="headerlink" title="computed的实现"></a>computed的实现</h3><h4 id="数据的懒计算"><a href="#数据的懒计算" class="headerlink" title="数据的懒计算"></a>数据的懒计算</h4><p>通过上述操作我们就实现了只有外界进行调用effectFn来会执行副作用函数，接下来根据这个特性我们来实现一下computed</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">computed</span>(<span class="params">getter</span>) &#123;</span><br><span class="line"> <span class="keyword">const</span> effectFn = <span class="title function_">effect</span>(getter,&#123;<span class="attr">lazy</span>: <span class="literal">true</span>&#125;)</span><br><span class="line"> <span class="keyword">const</span> obj = &#123;</span><br><span class="line">   <span class="keyword">get</span> <span class="title function_">value</span>()&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">effectFn</span>();</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="计算属性缓存的实现"><a href="#计算属性缓存的实现" class="headerlink" title="计算属性缓存的实现"></a>计算属性缓存的实现</h4><p>我们现在了computed的懒计算功能，还有一个计算属性可以进行值的缓存，为了解决以上问题，我们需要进行数据检查</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">computed</span>(<span class="params">getter</span>) &#123;</span><br><span class="line"> <span class="keyword">let</span> dirty = <span class="literal">true</span> <span class="comment">// 是否脏数据</span></span><br><span class="line"> <span class="keyword">let</span> value</span><br><span class="line"> <span class="keyword">const</span> effectFn = <span class="title function_">effect</span>(getter,&#123;<span class="attr">lazy</span>: <span class="literal">true</span>&#125;)</span><br><span class="line"> <span class="keyword">const</span> obj = &#123;</span><br><span class="line">    <span class="keyword">get</span> <span class="title function_">value</span>()&#123;</span><br><span class="line">     <span class="keyword">if</span>（dirty） &#123;</span><br><span class="line">     value = <span class="title function_">effectFn</span>();</span><br><span class="line">     dirty = <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> value;</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">return</span> obj;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们虽然实现了计算属性的缓存，我们发现下述这段代码运行其实不符合我们的预期</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> obj = &#123;</span><br><span class="line">  <span class="attr">a</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="attr">b</span>: <span class="number">2</span></span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"> <span class="title function_">computed</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> obj.<span class="property">a</span> + obj.<span class="property">b</span>;</span><br><span class="line"> &#125;)</span><br><span class="line"> </span><br><span class="line"> obj.<span class="property">a</span>++;</span><br></pre></td></tr></table></figure>
<p>我们发现当obj.a发生变换其实是符合我们的预期，我们希望拿到的值是4，但是执行输出的确是3，那么我们应该如何去解决呢，解决方法也比较简单，每次执行调度器的时候我们将 drity赋值为true</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">computed</span>(<span class="params">getter</span>) &#123;</span><br><span class="line"> <span class="keyword">let</span> dirty = <span class="literal">true</span> <span class="comment">// 是否脏数据</span></span><br><span class="line"> <span class="keyword">let</span> value</span><br><span class="line"> <span class="keyword">const</span> effectFn = <span class="title function_">effect</span>(getter,&#123;<span class="attr">lazy</span>: <span class="literal">true</span>， <span class="title function_">scheduler</span>(<span class="params"></span>)&#123; dirty = <span class="literal">true</span> &#125;&#125;)</span><br><span class="line"> <span class="keyword">const</span> obj = &#123;</span><br><span class="line">    <span class="keyword">get</span> <span class="title function_">value</span>()&#123;</span><br><span class="line">     <span class="keyword">if</span>（dirty） &#123;</span><br><span class="line">     value = <span class="title function_">effectFn</span>();</span><br><span class="line">     dirty = <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> value;</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">return</span> obj;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样只要数据发生改变就会执行schedler函数，从而将dirty赋值为true从而实现了从而重新运行副作用函数<br>这个时候我们的computed已经接近完美了但是还是有一个问题，就是在effect副作用函数进行读取computed的值时当computed值发生改变并不会触发副作用函数的执行，因此我们需要进行手动进行依赖的追踪<br> <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">computed</span>(<span class="params">getter</span>) &#123;</span><br><span class="line"> <span class="keyword">let</span> dirty = <span class="literal">true</span> <span class="comment">// 是否脏数据</span></span><br><span class="line"> <span class="keyword">let</span> value</span><br><span class="line"> <span class="keyword">const</span> effectFn = <span class="title function_">effect</span>(getter,&#123;<span class="attr">lazy</span>: <span class="literal">true</span>， <span class="title function_">scheduler</span>(<span class="params"></span>)&#123; </span><br><span class="line">  dirty = <span class="literal">true</span>;</span><br><span class="line">  <span class="title function_">trigger</span>(obj, <span class="string">&#x27;value&#x27;</span>, value); <span class="comment">// 手动进行依赖触发</span></span><br><span class="line"> &#125;&#125;)</span><br><span class="line"> <span class="keyword">const</span> obj = &#123;</span><br><span class="line">    <span class="keyword">get</span> <span class="title function_">value</span>()&#123;</span><br><span class="line">     <span class="keyword">if</span>（dirty） &#123;</span><br><span class="line">     value = <span class="title function_">effectFn</span>();</span><br><span class="line">     dirty = <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">track</span>(obj, <span class="string">&#x27;value&#x27;</span>); <span class="comment">// 手动进行依赖收集</span></span><br><span class="line">    <span class="keyword">return</span> value;</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">return</span> obj;</span><br></pre></td></tr></table></figure></p>
<h4 id="最终代码"><a href="#最终代码" class="headerlink" title="最终代码"></a>最终代码</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">computed</span>(<span class="params">getter</span>) &#123;</span><br><span class="line">  <span class="keyword">let</span> dirty = <span class="literal">true</span> <span class="comment">// 是否脏数据</span></span><br><span class="line">  <span class="keyword">let</span> value</span><br><span class="line">  <span class="keyword">const</span> effectFn = <span class="title function_">effect</span>(getter,&#123;<span class="attr">lazy</span>: <span class="literal">true</span>， <span class="title function_">scheduler</span>(<span class="params"></span>)&#123; </span><br><span class="line">   dirty = <span class="literal">true</span>;</span><br><span class="line">   <span class="title function_">trigger</span>(obj, <span class="string">&#x27;value&#x27;</span>, value); <span class="comment">// 手动进行依赖触发</span></span><br><span class="line">  &#125;&#125;)</span><br><span class="line">  <span class="keyword">const</span> obj = &#123;</span><br><span class="line">     <span class="keyword">get</span> <span class="title function_">value</span>()&#123;</span><br><span class="line">      <span class="keyword">if</span>（dirty） &#123;</span><br><span class="line">      value = <span class="title function_">effectFn</span>();</span><br><span class="line">      dirty = <span class="literal">false</span></span><br><span class="line">     &#125;</span><br><span class="line">     <span class="title function_">track</span>(obj, <span class="string">&#x27;value&#x27;</span>); <span class="comment">// 手动进行依赖收集</span></span><br><span class="line">     <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> obj;</span><br></pre></td></tr></table></figure>

<h2 id="watch的实现原理"><a href="#watch的实现原理" class="headerlink" title="watch的实现原理"></a>watch的实现原理</h2><p>什么是wathc呢，其实本质就是观测一个响应式数据的改变，当数据发生改变时通知并执行相应的副作用函数，<br>本质上watch的实现也是利用了effect函数进行实现</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">watch</span>(<span class="params">source, cb</span>)&#123;</span><br><span class="line"> <span class="title function_">effect</span>(<span class="function">() =&gt;</span> source.<span class="property">count</span>, &#123; <span class="title function_">scheduler</span>(<span class="params"></span>)&#123; <span class="title function_">cb</span>() &#125; &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们再来思考一下我们应该如何去实现对值读取呢，其实也可以利用函数编程的思想</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">watch</span>(<span class="params">source, cb,</span>) &#123;</span><br><span class="line">  <span class="title function_">effect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">traverse</span>(source);</span><br><span class="line">  &#125;, &#123; </span><br><span class="line">    <span class="title function_">scheduler</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="title function_">cb</span>()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">traverse</span>(<span class="params">value, seen = <span class="keyword">new</span> <span class="built_in">Set</span>()</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> value !== <span class="string">&#x27;object&#x27;</span> || value === <span class="literal">null</span> || !seen.<span class="title function_">has</span>(value)) &#123;</span><br><span class="line">    seen.<span class="title function_">add</span>(value)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> value) &#123;</span><br><span class="line">      <span class="comment">// 触发trigger</span></span><br><span class="line">      <span class="title function_">traverse</span>(value[key], seen);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> value</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们再次利用函数式编程的思想让其更加灵活</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">watch</span>(<span class="params">source, cb,</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> source === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">    getter = <span class="title function_">source</span>()</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    getter = <span class="function">() =&gt;</span> <span class="title function_">traverse</span>(source)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">effect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="title function_">getter</span>()</span><br><span class="line">  &#125;, &#123; </span><br><span class="line">    <span class="title function_">scheduler</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="title function_">cb</span>()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接下来我们只要实现如何将旧值和新值进行组装基本上就ok了</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">watch</span>(<span class="params">source, cb,</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> source === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">    getter = <span class="title function_">source</span>()</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    getter = <span class="function">() =&gt;</span> <span class="title function_">traverse</span>(source)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> newValue, oldValue;</span><br><span class="line">  <span class="keyword">const</span> effectFn = <span class="title function_">effect</span>(<span class="function">() =&gt;</span> <span class="title function_">getter</span>(), &#123;  <span class="title function_">scheduler</span>(<span class="params"></span>) &#123; </span><br><span class="line">    newValue = <span class="title function_">effectFn</span>()</span><br><span class="line">    <span class="title function_">cb</span>(newValue, oldValue);</span><br><span class="line">    oldValue = newValue;</span><br><span class="line">  &#125;, <span class="attr">lazy</span>: <span class="literal">true</span> &#125;);</span><br><span class="line"></span><br><span class="line">  oldValue = <span class="title function_">effectFn</span>();</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="立即执行"><a href="#立即执行" class="headerlink" title="立即执行"></a>立即执行</h3><p> 我们来看一下立即执行的回调函数，默认情况下，一个watch的回调只会在响应式数据发生变化才执行<br> <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">watch</span>(obj,<span class="function">() =&gt;</span>&#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;值发生改变&#x27;</span>) &#125;, &#123; <span class="attr">immediate</span>: <span class="literal">true</span> &#125;)</span><br></pre></td></tr></table></figure><br> 为了实现以上功能我们需要在我们的watch函数里面增加immediate参数</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">watch</span>(<span class="params">source, cb, options</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> source === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">    getter = <span class="title function_">source</span>()</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    getter = <span class="function">() =&gt;</span> <span class="title function_">traverse</span>(source)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> newValue, oldValue;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">job</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">    newValue = <span class="title function_">effectFn</span>()</span><br><span class="line">    <span class="title function_">cb</span>(newValue, oldValue);</span><br><span class="line">    oldValue = newValue;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> effectFn = <span class="title function_">effect</span>(<span class="function">() =&gt;</span> <span class="title function_">getter</span>(), &#123; <span class="attr">scheduler</span>: job, <span class="attr">lazy</span>: <span class="literal">true</span> &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( options &amp;&amp; options.<span class="property">immediate</span>) &#123;</span><br><span class="line">    <span class="title function_">job</span>()</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    oldValue = <span class="title function_">effectFn</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="回调执行时机"><a href="#回调执行时机" class="headerlink" title="回调执行时机"></a>回调执行时机</h3><p>在vue中我们可以通过参数来控制调度函数的执行时机，因此我们的watch也需要实现这个功能，其实实现；逻辑也相对比较简单可以借助于上述的jobQueue来进行实现，至于vue中的pre设涉及到组件的更新机制暂时没办法实现</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">watch</span>(<span class="params">source, cb, options</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> source === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">    getter = <span class="title function_">source</span>()</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    getter = <span class="function">() =&gt;</span> <span class="title function_">traverse</span>(source)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> newValue, oldValue;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">job</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">    newValue = <span class="title function_">effectFn</span>()</span><br><span class="line">    <span class="title function_">cb</span>(newValue, oldValue);</span><br><span class="line">    oldValue = newValue;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> effectFn = <span class="title function_">effect</span>(<span class="function">() =&gt;</span> <span class="title function_">getter</span>(), &#123; <span class="attr">scheduler</span>: <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (options &amp;&amp; options.<span class="property">flush</span> === <span class="string">&#x27;post&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> p = <span class="title class_">Promise</span>.<span class="title function_">resolve</span>()</span><br><span class="line">      p.<span class="title function_">then</span>(job).<span class="title function_">catch</span>(<span class="function">() =&gt;</span> &#123;&#125;);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="title function_">job</span>()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, <span class="attr">lazy</span>: <span class="literal">true</span> &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( options &amp;&amp; options.<span class="property">immediate</span>) &#123;</span><br><span class="line">    <span class="title function_">job</span>()</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    oldValue = <span class="title function_">effectFn</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="过期的副作用"><a href="#过期的副作用" class="headerlink" title="过期的副作用"></a>过期的副作用</h3><p>使用过react的都知道effect函数可以返回一个回调函数用于副作用函数的处理，在react effect中我们经常遇到请求竞态的问题，为了在reat中解决请求竞态的问题我们通常会设置一个变量来进行解决</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> [expired, setExpired] = useState&lt;boolen&gt;(<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line"><span class="title function_">useffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line"> <span class="keyword">if</span> (exprired === <span class="literal">false</span>) &#123;</span><br><span class="line">  <span class="comment">// 网络请求</span></span><br><span class="line">  expried = <span class="literal">true</span></span><br><span class="line">  &#125; </span><br><span class="line">  <span class="keyword">return</span> <span class="function">() =&gt;</span>&#123;</span><br><span class="line">   exprired = <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>上述是react进行解决请求竞态的问题，那么在vue中我们应该如何去解决呢，其实我们可以参考react的解决思路也是通过标识符来进行解决</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> finallyData = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="title function_">watch</span>( obj, <span class="title function_">async</span>() =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> data = <span class="keyword">await</span> <span class="title function_">fetch</span>(<span class="string">&#x27;xxx&#x27;</span>);</span><br><span class="line">  finallyData = data;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="title function_">watch</span>(obj, <span class="title function_">async</span>(newVal, oldVal) =&gt; &#123;</span><br><span class="line">  <span class="keyword">let</span> expired = <span class="literal">false</span>;</span><br><span class="line">  <span class="title function_">onInvalidate</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    expired = <span class="literal">true</span>;</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> data = <span class="keyword">await</span> <span class="title function_">fetch</span>(<span class="string">&#x27;xxx&#x27;</span>);</span><br><span class="line">  <span class="keyword">if</span> (!expired) &#123;</span><br><span class="line">    finallyData = data;</span><br><span class="line">    <span class="title function_">onInvalidate</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h2 id="watch最终代码"><a href="#watch最终代码" class="headerlink" title="watch最终代码"></a>watch最终代码</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">watch</span>(<span class="params">source, cb, options</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> source === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">    getter = <span class="title function_">source</span>()</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    getter = <span class="function">() =&gt;</span> <span class="title function_">traverse</span>(source)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> newValue, oldValue, cleanup;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">onInvalidate</span>(<span class="params">fn</span>) &#123;</span><br><span class="line">    cleanup = fn</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">job</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">    newValue = <span class="title function_">effectFn</span>();</span><br><span class="line">    <span class="keyword">if</span> (cleanup) &#123;</span><br><span class="line">      <span class="title function_">cleanup</span>();</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">cb</span>(newValue, oldValue, onInvalidate);</span><br><span class="line">    oldValue = newValue;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> effectFn = <span class="title function_">effect</span>(<span class="function">() =&gt;</span> <span class="title function_">getter</span>(), &#123; <span class="attr">scheduler</span>: <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (options &amp;&amp; options.<span class="property">flush</span> === <span class="string">&#x27;post&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> p = <span class="title class_">Promise</span>.<span class="title function_">resolve</span>()</span><br><span class="line">      p.<span class="title function_">then</span>(job).<span class="title function_">catch</span>(<span class="function">() =&gt;</span> &#123;&#125;);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="title function_">job</span>()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, <span class="attr">lazy</span>: <span class="literal">true</span> &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( options &amp;&amp; options.<span class="property">immediate</span>) &#123;</span><br><span class="line">    <span class="title function_">job</span>()</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    oldValue = <span class="title function_">effectFn</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ul>
<li>完善effect函数实现用户对副作用函数执行时机的控制</li>
<li>watch 和 computed 其实都是依赖于副作用effect的函数的实现</li>
<li>实现computed的最终实现</li>
<li>实现wathc的最终实现</li>
<li>通过分析react的请求竞态问题解决vue的请求竞态问题</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://imperial-long.github.io/blog/2024/01/17/vue3%E8%AE%BE%E8%AE%A1%E6%80%9D%E8%B7%AF/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="朱广龙">
      <meta itemprop="description" content="定期会更新前端技术栈 不限于vue，react，node以及部分后端的知识">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="朱广龙的个人博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2024/01/17/vue3%E8%AE%BE%E8%AE%A1%E6%80%9D%E8%B7%AF/" class="post-title-link" itemprop="url">vue3设计思路</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-01-17 20:39:00" itemprop="dateCreated datePublished" datetime="2024-01-17T20:39:00+08:00">2024-01-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-10-10 13:15:33" itemprop="dateModified" datetime="2024-10-10T13:15:33+08:00">2024-10-10</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>vue是一个声明式的ui框架，如果让你设计一个声明式的ui框架，你会怎么设计呢，下面我们将站在框架的设计者角度来一起探讨一下vue3的设计思路</p>
<p>为了让vue的设计思路更加清晰、易懂，我们可以将声明式UI与命令式UI的区别，用类似”行为主义”和”联结主义”这样的概念来形象化地解释。行为主义者认为人的行为是由外界的刺激所引起的，联结主义者则认为人的行为是由大脑内部的神经网络相互作用而形成的。vue的设计正是借鉴了这两种理论，将UI的设计视为一种外界的刺激，通过模版、对象、虚拟DOM、渲染器等一系列手段，使得UI的实现能够顺应行为主义的逻辑。同时，Vue还融入了联结主义的思想，将虚拟DOM看作是一个由神经元组成的网络，通过不断的学习和更新，最终实现对真实DOM的准确渲染。这种行为主义和联结主义的结合，让Vue的UI设计更加符合人类的认知和学习方式，从而达到了更高的效率和更好的用户体验。</p>
<h2 id="声明式-VS-命令式"><a href="#声明式-VS-命令式" class="headerlink" title="声明式 VS 命令式"></a>声明式 VS 命令式</h2><p>声明式编程和命令式编程是两种不同的编程范式，它们在处理计算和编程逻辑的方式上有着显著的区别。以下是它们的基本特点和区别</p>
<table>
<thead>
<tr>
<th>特点</th>
<th>声明式编程</th>
<th>命令式编程</th>
</tr>
</thead>
<tbody><tr>
<td>侧重点</td>
<td>“做什么”（What to do）</td>
<td>“如何做”（How to do）</td>
</tr>
<tr>
<td>控制流</td>
<td>通常使用表达式和描述性语言</td>
<td>通常使用显式指令和控制结构</td>
</tr>
<tr>
<td>数据可变性</td>
<td>数据通常不可变</td>
<td>数据通常可变</td>
</tr>
<tr>
<td>状态管理</td>
<td>通常避免显式状态管理</td>
<td>通常需要显式状态管理</td>
</tr>
<tr>
<td>编程范式</td>
<td>常与函数式编程范式结合使用</td>
<td>常与面向对象编程结合使用</td>
</tr>
<tr>
<td>循环</td>
<td>通常避免显式循环</td>
<td>常使用循环和迭代控制结构</td>
</tr>
<tr>
<td>数据转换</td>
<td>重点在数据变换和操作</td>
<td>重点在程序状态和控制流</td>
</tr>
<tr>
<td>示例语言</td>
<td>SQL、HTML、CSS、React等</td>
<td>C、C++、Java、Python等</td>
</tr>
<tr>
<td>代码可读性</td>
<td>代码通常更易读和易懂</td>
<td>代码中可能包含较多细节和控制逻辑</td>
</tr>
<tr>
<td>应用领域</td>
<td>数据查询、声明性描述</td>
<td>通用应用、系统编程、面向对象编程</td>
</tr>
</tbody></table>
<p>在设计一个声明式的ui框架之前我们需要搞清楚编写ui时会涉及到哪些问题，具体涉及到的问题如下</p>
<ul>
<li>DOM元素: div元素还是span元素或者其他元素</li>
<li>属性: 比如元素的通用属性id，class等，元素的特有属性，比如a标签的herf，img的scr属性等</li>
<li>事件: 比如鼠标事件click等以及键盘事件keydown等</li>
<li>元素的结构: DOM的层级结构，比如父节点，子节点，兄弟节点，祖先节点等</li>
</ul>
<p>如果我们采用命令式的方法去描述以上内容，具体代码如下<br> <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> divElm = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;div&#x27;</span>);</span><br><span class="line">divElm.<span class="property">textContent</span> = <span class="string">&#x27;this is recommand demo&#x27;</span>;</span><br><span class="line">divElm.<span class="title function_">addEventListener</span>(<span class="string">&#x27;click&#x27;</span>, <span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;click me&#x27;</span>), <span class="literal">false</span>);</span><br></pre></td></tr></table></figure><br> 假如我们需要使用声明式的方式去实现，应当如何去实现呢，其实解决方案也比较多，我们拿vue3来说采用模版的方法去描述</p>
<ul>
<li>使用与html标签一致的方式来描述dom元素，例如一个div标签可以使用<div></div>或者<div />来描述</li>
<li>使用v-bind来描述动态绑定的属性，例如<div v-bind:id="id"></div></li>
<li>使用v-on来描述绑定的事件，例如<div v-on:click="onClick"></div></li>
<li>使用与html一样的结构来描述层级结构，例如<div><span>hello vue3</span></div></li>
</ul>
<p>当然我们也可以通过javascript对象的形式来描述</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> vNode = &#123;</span><br><span class="line">  <span class="comment">// 标签名称</span></span><br><span class="line">  <span class="attr">tag</span>: <span class="string">&#x27;div&#x27;</span>,</span><br><span class="line">  <span class="comment">// 标签属性</span></span><br><span class="line">  <span class="attr">props</span>: &#123;</span><br><span class="line">    <span class="attr">onClick</span>: <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;click&#x27;</span>);</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// 子节点</span></span><br><span class="line">  <span class="attr">children</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">tag</span>: <span class="string">&#x27;span&#x27;</span>,</span><br><span class="line">      <span class="attr">children</span>: <span class="string">&#x27;hello, world&#x27;</span></span><br><span class="line">    &#125;,</span><br><span class="line">  ],</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="虚拟dom"><a href="#虚拟dom" class="headerlink" title="虚拟dom"></a>虚拟dom</h2><p>那么使用模版和对象来描述UI时有什么不同呢，使用javscript来描述相对来说更加灵活，我们以需要渲染h1-h5为例，并且分情况展示</p>
<p>模版描述<br>  <figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">templete</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">h1</span> <span class="attr">v-if</span>=<span class="string">&quot;level===1&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">h2</span> <span class="attr">v-else-if</span>=<span class="string">&quot;level===2&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">h3</span> <span class="attr">v-else-if</span>=<span class="string">&quot;level===3&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">h4</span> <span class="attr">v-else-if</span>=<span class="string">&quot;level===4&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">h4</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">h5</span> <span class="attr">v-else</span>&gt;</span><span class="tag">&lt;/<span class="name">h5</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">templete</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure></p>
<p>  javascript对象描述</p>
  <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> vnode = &#123;</span><br><span class="line"> <span class="attr">type</span>: <span class="string">`h<span class="subst">$&#123;level&#125;</span>`</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="string">``</span><span class="string">``</span></span><br><span class="line"></span><br><span class="line">从上面的结果来看，模版没有对象来得更加例灵活，其实这就是所谓的虚拟dom，其实虚拟dom没什么神秘的了吧，正是因为虚拟dom的这种灵活性，其实我们在vuejs组件中手写的render函数就是使用虚拟dom来描述ui，如下代码所示</span><br><span class="line"></span><br><span class="line"><span class="string">``</span><span class="string">`javascript</span></span><br><span class="line"><span class="string">import &#123; h &#125; from &#x27;vue&#x27;;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">export default &#123;</span></span><br><span class="line"><span class="string">  render()&#123;</span></span><br><span class="line"><span class="string">  return h(&#x27;div&#x27;, &#123; onClick: onClick &#125;);</span></span><br><span class="line"><span class="string">  &#125;;</span></span><br><span class="line"><span class="string">&#125;;</span></span><br></pre></td></tr></table></figure>
<h2 id="渲染器"><a href="#渲染器" class="headerlink" title="渲染器"></a>渲染器</h2><p> 现在我们已经了解什么是虚拟dom，它的本质其实就是用javascript对象来描述真实的dom结构，那么虚拟dom是如何变成真实dom渲染到页面中呢，这其实涉及到了渲染器</p>
<p> 渲染器的作用就是把虚拟dom渲染为真实dom，如图所示</p>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/cd6be2faf50c4097a1ca6022377e5e26~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=1146&h=426&s=23389&e=png&b=18151e" alt="image.png"></p>
<p>渲染器是非常重要的角色，大家平时编写的vue组件都是通过渲染器来进行工作的，</p>
<p>我们假设有如下虚拟dom</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> vnode = &#123;</span><br><span class="line">  <span class="attr">tag</span>: <span class="string">&#x27;div&#x27;</span>, <span class="comment">// 标签名称</span></span><br><span class="line">  <span class="attr">props</span>: &#123;</span><br><span class="line">    <span class="attr">calssName</span>: <span class="string">&#x27;div&#x27;</span></span><br><span class="line">    <span class="attr">on</span>: &#123;</span><br><span class="line">      <span class="attr">click</span>: <span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;click me&#x27;</span>); <span class="comment">// 点击事件</span></span><br><span class="line">    &#125;,</span><br><span class="line"> &#125;,</span><br><span class="line"> <span class="attr">children</span>: <span class="string">&#x27;hello vue&#x27;</span>, <span class="comment">//标签的子节点</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>接下来我们需要编写一个渲染器，将上面这段虚拟dom代码渲染为真实dom</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"> * @description 将虚拟dom渲染为真实的dom</span><br><span class="line"> * @param &#123;<span class="title class_">VNode</span>&#125; vNode 虚拟dom对象</span><br><span class="line"> * @param &#123; <span class="title class_">HTMLElement</span> &#125; container 挂载点</span><br><span class="line"> */</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">renderer</span>(<span class="params">vNode, container</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; tag, props = &#123;&#125; children  &#125; = vNode;</span><br><span class="line">  <span class="keyword">const</span> ons = props.<span class="property">on</span> || &#123;&#125;;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 创建真实dom</span></span><br><span class="line">  <span class="keyword">const</span> el = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(tag);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 处理属性,将dom事件进行添加</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> props) &#123;</span><br><span class="line">      <span class="keyword">if</span> (key === <span class="string">&#x27;on&#x27;</span>) &#123;</span><br><span class="line">      <span class="comment">// 将事件进行绑定</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">const</span> eventName <span class="keyword">in</span> ons) &#123;</span><br><span class="line">           el.<span class="title function_">addEventListener</span>(eventName, ons[eventName]);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 递归处理子节点</span></span><br><span class="line">    <span class="keyword">if</span> (children) &#123;</span><br><span class="line">      <span class="comment">// 单个文本节点 </span></span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> children === <span class="string">&#x27;string&#x27;</span>) &#123;</span><br><span class="line">        el.<span class="title function_">appendChild</span>(<span class="variable language_">document</span>.<span class="title function_">createTextNode</span>(children));</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 多个节点</span></span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span>（<span class="title class_">Array</span>.<span class="title function_">isArray</span>(<span class="params">children</span>)&#123;</span><br><span class="line">         children.<span class="title function_">forEach</span>(<span class="function"><span class="params">child</span> =&gt;</span> <span class="title function_">renderer</span>(child, el));</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 将元素挂载到挂载点</span></span><br><span class="line">    container.<span class="title function_">appendChild</span>(el)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="title function_">render</span>(vnode, <span class="variable language_">document</span>.<span class="property">body</span>);</span><br></pre></td></tr></table></figure>
<p>现在我们来分析 渲染器做了什么事</p>
<ul>
<li>创建元素：根据标签名来创建dom元素</li>
<li>为元素添加属性和事件：遍历vnode的props对象，如果key是on，说明on里面绑定的全是对象</li>
<li>处理children： 如果children是一个数组，就递归的调用render进行渲染，如果是文本节点调用createTextNode创建文本节点</li>
</ul>
<p>是不是突然感觉渲染器没有那么神秘了呢，其实我们别忘了我们目前仅涉及到创建节点，还未涉及到更新节点，渲染器的精髓其实在更新节点的阶段，渲染器的工作原理其实是利用我们所熟悉的api来完成渲染工作</p>
<h2 id="组件的本质"><a href="#组件的本质" class="headerlink" title="组件的本质"></a>组件的本质</h2><p>其实虚拟dom除了能够描述真实dom之外，还能够描述组件，那么如何使用虚拟dom来描述组件呢，想要明白这个问题，我们就需要知道组件的本质是什么， 组件其实就是一组dom元素的封装，这组元素就是组件要渲染的内容</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// 函数式组件</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">functionComponent</span>(<span class="params"></span>)&#123;</span><br><span class="line"> <span class="keyword">return</span> &#123;</span><br><span class="line">  <span class="attr">tag</span>: <span class="string">&#x27;div&#x27;</span>, <span class="comment">// 标签名称</span></span><br><span class="line">  <span class="attr">props</span>: &#123;</span><br><span class="line">    <span class="attr">calssName</span>: <span class="string">&#x27;div&#x27;</span></span><br><span class="line">    <span class="attr">on</span>: &#123;</span><br><span class="line">      <span class="attr">click</span>: <span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;click me&#x27;</span>); <span class="comment">// 点击事件</span></span><br><span class="line">    &#125;,</span><br><span class="line"> &#125;,</span><br><span class="line"> <span class="attr">children</span>: <span class="string">&#x27;hello vue&#x27;</span>, <span class="comment">//标签的子节点</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 类组件</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ClassComponent</span> &#123;</span><br><span class="line">  <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="attr">tag</span>: <span class="string">&#x27;div&#x27;</span>, <span class="comment">// 标签名称</span></span><br><span class="line">      <span class="attr">props</span>: &#123;</span><br><span class="line">        <span class="attr">calssName</span>: <span class="string">&#x27;div&#x27;</span></span><br><span class="line">        <span class="attr">on</span>: &#123;</span><br><span class="line">          <span class="attr">click</span>: <span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;click me&#x27;</span>); <span class="comment">// 点击事件</span></span><br><span class="line">        &#125;,</span><br><span class="line">     &#125;,</span><br><span class="line">     <span class="attr">children</span>: <span class="string">&#x27;hello vue&#x27;</span>, <span class="comment">//标签的子节点</span></span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> componentVnode = &#123;</span><br><span class="line">  <span class="attr">tag</span>: functionComponent,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>我们发现此时组件的tag属性不再是标签名称，而是一个函数或者类</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"> <span class="keyword">function</span> <span class="title function_">render</span>(<span class="params">vnode, container</span>)&#123;</span><br><span class="line">   <span class="keyword">if</span> (<span class="keyword">typeof</span> vnode.<span class="property">tag</span> ==== <span class="string">&#x27;object&#x27;</span> &amp;&amp; vnode.<span class="property">tag</span> !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="title function_">mountComponent</span>(vnode, container);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> vnode.<span class="property">tag</span> === <span class="string">&#x27;string&#x27;</span>) &#123;</span><br><span class="line">      <span class="title function_">mountElement</span>(vnode, container);</span><br><span class="line">    &#125;</span><br><span class="line"> &#125;;</span><br><span class="line"> </span><br><span class="line"> <span class="keyword">function</span> <span class="title function_">mountElement</span>(<span class="params">vNode, container</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; tag, props = &#123;&#125; children  &#125; = vNode;</span><br><span class="line">  <span class="keyword">const</span> ons = props.<span class="property">on</span> || &#123;&#125;;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 创建真实dom</span></span><br><span class="line">  <span class="keyword">const</span> el = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(tag);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 处理属性,将dom事件进行添加</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> props) &#123;</span><br><span class="line">      <span class="keyword">if</span> (key === <span class="string">&#x27;on&#x27;</span>) &#123;</span><br><span class="line">      <span class="comment">// 将事件进行绑定</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">const</span> eventName <span class="keyword">in</span> ons) &#123;</span><br><span class="line">           el.<span class="title function_">addEventListener</span>(eventName, ons[eventName]);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 递归处理子节点</span></span><br><span class="line">    <span class="keyword">if</span> (children) &#123;</span><br><span class="line">      <span class="comment">// 单个文本节点 </span></span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> children === <span class="string">&#x27;string&#x27;</span>) &#123;</span><br><span class="line">        el.<span class="title function_">appendChild</span>(<span class="variable language_">document</span>.<span class="title function_">createTextNode</span>(children));</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 多个节点</span></span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span>（<span class="title class_">Array</span>.<span class="title function_">isArray</span>(<span class="params">children</span>)&#123;</span><br><span class="line">         children.<span class="title function_">forEach</span>(<span class="function"><span class="params">child</span> =&gt;</span> <span class="title function_">renderer</span>(child, el));</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 将元素挂载到挂载点</span></span><br><span class="line">    container.<span class="title function_">appendChild</span>(el)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">mountComponent</span>(<span class="params">vnode, container</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> subTree = <span class="string">&#x27;render&#x27;</span> <span class="keyword">in</span> vnode.<span class="property">tag</span> ? vnode.<span class="property">tag</span>.<span class="title function_">render</span>() : vnode.<span class="title function_">tag</span>();</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 递归调用渲染sutree</span></span><br><span class="line">  <span class="title function_">render</span>(subTeree, container);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>可以看到，如果tag是函数，那么我们就知道它其实是组件本身的函数</p>
<h2 id="模版的工作原理"><a href="#模版的工作原理" class="headerlink" title="模版的工作原理"></a>模版的工作原理</h2><p>无论是手写虚拟dom还是使用模版，都属于声明式ui，并且vue同时支持2种声明式的描述ui，上面我们了解到了虚拟dom是如何渲染成真实dom的，那么模版是如何工作的<br>这其实是vue的另一个重要组成部分: 编译器</p>
<p>编译器和渲染器其实一样，只是一段程序而已，不过他们的工作内容不同，编译器的作用其实就是将模版编译成渲染函数</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> @<span class="attr">click</span>=<span class="string">&quot;onClick&quot;</span>&gt;</span> click me <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>对于编译器来说，模版就是一个普通的字符串，它会分析该字符串并生成一个功能与之相同的渲染函数</p>
 <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">render</span>(<span class="params">h</span>)&#123;</span><br><span class="line"> <span class="keyword">return</span> <span class="title function_">h</span>(<span class="string">&#x27;div&#x27;</span>,&#123; <span class="attr">onClick</span>: onClick &#125;, <span class="string">&#x27;click me&#x27;</span>);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p> 以我们熟悉的.vue文件为例，一个.vue文件就是一个组件<br> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;templete&gt;</span><br><span class="line"> &lt;div @clik=&#x27;onClick&#x27;&gt; click me  &lt;/div&gt;</span><br><span class="line">&lt;/templete&gt;</span><br><span class="line"></span><br><span class="line">&lt;script setup lang=&quot;ts&quot;&gt;</span><br><span class="line"> const onClick = () =&gt; &#123;&#125;;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure></p>
<p> 其中templete标签的内容就是模版内容，编译器会把模版内容编译成渲染函数并添加到script标签中</p>
 <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="attr">methods</span>: &#123;</span><br><span class="line">    <span class="title function_">onClick</span>(<span class="params"></span>)&#123;&#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">  </span><br><span class="line">  <span class="title function_">render</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">h</span>(<span class="string">&#x27;div&#x27;</span>, &#123; <span class="attr">onClick</span>: onClick &#125;, <span class="string">&#x27;click me&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> 所以无论是使用模版还是直接手写渲染函数，对于一个组件来说，它最终的内容都是通过渲染函数产生的，<br> 然后渲染器再把渲染函数返回的虚拟dom渲染为真实dom</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ul>
<li>vue是一个声明式的框架，声明式的好处在于直接描述结果</li>
<li>vue采用模版的方式来描述ui，但它同样支持使用虚拟dom来描述ui</li>
<li>渲染器的作用: 将虚拟dom对象渲染为真实dom对象，工作原理本质就是通过递归遍历递归虚拟dom对象利用dom相关的api来完成真实dom的创建</li>
<li>组件本质是一组虚拟dom元素的封装</li>
<li>vue的模版会被一个叫做编译器的程序进行编译为渲染函数</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://imperial-long.github.io/blog/2023/01/17/commonjs%E6%8F%AD%E7%A7%98/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="朱广龙">
      <meta itemprop="description" content="定期会更新前端技术栈 不限于vue，react，node以及部分后端的知识">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="朱广龙的个人博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2023/01/17/commonjs%E6%8F%AD%E7%A7%98/" class="post-title-link" itemprop="url">commonjs揭秘</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-01-17 20:39:00" itemprop="dateCreated datePublished" datetime="2023-01-17T20:39:00+08:00">2023-01-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-10-10 12:46:37" itemprop="dateModified" datetime="2024-10-10T12:46:37+08:00">2024-10-10</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>最近我在梳理nodejs的模块机制，以供日后查阅。以下代码实例基于node v14.16.0，并且实例主要采用javascript进行书写,示例文件目录如下</p>
<p>commonjs</p>
<p>├── index.js</p>
<p>├── person.js</p>
<p>├── propagation.js</p>
<p>├── require</p>
<p>│ ├── index.js</p>
<p>│ ├── main.jsx</p>
<p>│ └── package.json</p>
<p>├── require.json</p>
<p>├── require.jsx</p>
<p>├── require.node</p>
<p>└── synchronization.js</p>
<p>下面将会有几个问题，可以自己先想一想，如果你对这些问题都能回答上来，那么你可以选择不需要往下看</p>
<ol>
<li>cjs模块化定义分为几个部分</li>
<li>模块导出机制是怎么样的（module.exports和exports有什么区别）</li>
<li>cjs模块查找机制是怎么样的</li>
<li>cjs模块引用是同步的还是异步的</li>
<li>cjs是如何解决模块之间相互引用的</li>
<li>require函数做了什么</li>
<li>模块中并没有申明module变量，为什么可以输出一个对象</li>
<li>自己能否实现一个类似cjs的模块</li>
</ol>
<h3 id="cjs模块定义"><a href="#cjs模块定义" class="headerlink" title="cjs模块定义"></a>cjs模块定义</h3><p>cjs定义模块主要分为以下3个部分</p>
<h4 id="模块定义-导出"><a href="#模块定义-导出" class="headerlink" title="模块定义(导出)"></a>模块定义(导出)</h4><p>必须使用module.exports或exports定义模块</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> person1 = &#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;zgl1&#x27;</span>,</span><br><span class="line">  <span class="attr">age</span>: <span class="number">27</span>,</span><br><span class="line">  <span class="title function_">getName</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">name</span>;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="title function_">setName</span>(<span class="params">name</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">name</span> = name;</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> person2 = &#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;zgl2&#x27;</span>,</span><br><span class="line">  <span class="attr">age</span>: <span class="number">27</span>,</span><br><span class="line">  <span class="title function_">getName</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">name</span>;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="title function_">setName</span>(<span class="params">name</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">name</span> = name;</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 采用module.exports的方式进行模块导出</span></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  person1</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 采用exports的方式进行模块导出</span></span><br><span class="line"><span class="built_in">exports</span>.<span class="property">person2</span> = person2;</span><br></pre></td></tr></table></figure>

<h4 id="模块引用（导入）"><a href="#模块引用（导入）" class="headerlink" title="模块引用（导入）"></a>模块引用（导入）</h4><p>必须使用require函数引入模块</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> person = <span class="built_in">require</span>(<span class="string">&#x27;./person&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(person.<span class="property">person2</span>, <span class="string">&#x27;person2&#x27;</span>);</span><br></pre></td></tr></table></figure>

<h4 id="模块标识"><a href="#模块标识" class="headerlink" title="模块标识"></a>模块标识</h4><p>本质上就是传给require函数的参数，他可以是具体的文件路径（相对路径或绝对路径），也可以是字符串，也可以是省略后缀的文件名</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 字符串</span></span><br><span class="line"><span class="keyword">const</span> react = <span class="built_in">require</span>(<span class="string">&#x27;react&#x27;</span>);</span><br><span class="line"><span class="comment">// 相对路径</span></span><br><span class="line"><span class="keyword">const</span> person = <span class="built_in">require</span>(<span class="string">&#x27;./person&#x27;</span>);</span><br><span class="line"><span class="comment">// 绝对路径</span></span><br><span class="line"><span class="keyword">const</span> methods = <span class="built_in">require</span>(<span class="string">&#x27;src/shard/index.js&#x27;</span>);</span><br><span class="line"><span class="comment">// 省略后缀的文件名</span></span><br><span class="line"><span class="keyword">const</span> components = <span class="built_in">require</span>(<span class="string">&#x27;src/components/index&#x27;</span>) </span><br></pre></td></tr></table></figure>

<h3 id="模块导出机制"><a href="#模块导出机制" class="headerlink" title="模块导出机制"></a>模块导出机制</h3><h4 id="module"><a href="#module" class="headerlink" title="module"></a>module</h4><p>让那个需要导出的模块成为整个模块进行导出</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> person = &#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;zgl1&#x27;</span>,</span><br><span class="line">  <span class="attr">age</span>: <span class="number">27</span>,</span><br><span class="line">  <span class="title function_">getName</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">name</span>;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="title function_">setName</span>(<span class="params">name</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">name</span> = name;</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> person2 = &#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;zgl2&#x27;</span>,</span><br><span class="line">  <span class="attr">age</span>: <span class="number">27</span>,</span><br><span class="line">  <span class="title function_">getName</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">name</span>;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="title function_">setName</span>(<span class="params">name</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">name</span> = name;</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  person</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="exports"><a href="#exports" class="headerlink" title="exports"></a>exports</h4><ul>
<li>让需要导出的模块成为模块的某个属性进行导出</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> person = &#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;zgl1&#x27;</span>,</span><br><span class="line">  <span class="attr">age</span>: <span class="number">27</span>,</span><br><span class="line">  <span class="title function_">getName</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">name</span>;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="title function_">setName</span>(<span class="params">name</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">name</span> = name;</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> person2 = &#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;zgl2&#x27;</span>,</span><br><span class="line">  <span class="attr">age</span>: <span class="number">27</span>,</span><br><span class="line">  <span class="title function_">getName</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">name</span>;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="title function_">setName</span>(<span class="params">name</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">name</span> = name;</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="built_in">exports</span>.<span class="property">person</span> = person</span><br></pre></td></tr></table></figure>

<p>由此可见，module.expprts和exports刚开始引用的是同一个对象</p>
<h4 id="module-exports和exports的关系"><a href="#module-exports和exports的关系" class="headerlink" title="module.exports和exports的关系"></a>module.exports和exports的关系</h4><p>在不修改module.exports的引用时，module.exports和exports指向了用一个引用对象，如果修改了module.exports,那么他们之间的引用关系就会断开</p>
<ul>
<li>没有修改module.exports的引用</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">module</span>.<span class="property">exports</span> === <span class="built_in">exports</span>); <span class="comment">// true</span></span><br></pre></td></tr></table></figure>

<ul>
<li>给exports增加了一个属性</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> person2 = &#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;zgl2&#x27;</span>,</span><br><span class="line">  <span class="attr">age</span>: <span class="number">27</span>,</span><br><span class="line">  <span class="title function_">getName</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">name</span>;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="title function_">setName</span>(<span class="params">name</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">name</span> = name;</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">exports</span>.<span class="property">person2</span> = person2;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">module</span>.<span class="property">exports</span> === <span class="built_in">exports</span>); <span class="comment">// true</span></span><br></pre></td></tr></table></figure>

<ul>
<li>修改module.exports的引用</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">module</span>.<span class="property">exports</span> === <span class="built_in">exports</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> person1 = &#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;zgl1&#x27;</span>,</span><br><span class="line">  <span class="attr">age</span>: <span class="number">27</span>,</span><br><span class="line">  <span class="title function_">getName</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">name</span>;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="title function_">setName</span>(<span class="params">name</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">name</span> = name;</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  person</span><br><span class="line">&#125;;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="built_in">exports</span>, <span class="string">&#x27;exprots&#x27;</span>); <span class="comment">// &#123;&#125;</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">module</span>.<span class="property">exports</span>, <span class="string">&#x27;module.exports&#x27;</span>); </span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment">&#123;</span></span><br><span class="line"><span class="comment">  name: &#x27;zgl1&#x27;,</span></span><br><span class="line"><span class="comment">  age: 27,</span></span><br><span class="line"><span class="comment">  getName: [Function: getName],</span></span><br><span class="line"><span class="comment">  setName: [Function: setName]</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">module</span>.<span class="property">exports</span> === <span class="built_in">exports</span>); <span class="comment">// false</span></span><br></pre></td></tr></table></figure>

<h3 id="模块导入机制"><a href="#模块导入机制" class="headerlink" title="模块导入机制"></a>模块导入机制</h3><p>模块导入机制比较复杂，接下来我们一点一点的去揭开他的神秘面纱，由于这一块内容比较复杂，我们先来简单的看一下脑图</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ceee61d2996843f8bcd0fc68981fd453~tplv-k3u1fbpfcp-zoom-1.image"></p>
<h4 id="模块真正导入的是module-exports"><a href="#模块真正导入的是module-exports" class="headerlink" title="模块真正导入的是module.exports"></a>模块真正导入的是module.exports</h4><p>我们分别采用module.exports和exports分别导出一个对象，看看最后require引用的对象是谁</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> person1 = &#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;zgl1&#x27;</span>,</span><br><span class="line">  <span class="attr">age</span>: <span class="number">27</span>,</span><br><span class="line">  <span class="title function_">getName</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">name</span>;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="title function_">setName</span>(<span class="params">name</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">name</span> = name;</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> person2 = &#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;zgl2&#x27;</span>,</span><br><span class="line">  <span class="attr">age</span>: <span class="number">27</span>,</span><br><span class="line">  <span class="title function_">getName</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">name</span>;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="title function_">setName</span>(<span class="params">name</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">name</span> = name;</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  person1</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">exports</span>.<span class="property">person2</span> = person2;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> person = <span class="built_in">require</span>(<span class="string">&#x27;./person&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(person.<span class="property">person2</span>, <span class="string">&#x27;person2&#x27;</span>); </span><br><span class="line"><span class="comment">// undefined person2</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(person.<span class="property">person1</span>, <span class="string">&#x27;person1&#x27;</span>);</span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment">&#123;</span></span><br><span class="line"><span class="comment">  name: &#x27;zgl1&#x27;,</span></span><br><span class="line"><span class="comment">  age: 27,</span></span><br><span class="line"><span class="comment">  getName: [Function: getName],</span></span><br><span class="line"><span class="comment">  setName: [Function: setName]</span></span><br><span class="line"><span class="comment">&#125; person1 </span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 实际导出的是module.exports</span></span><br></pre></td></tr></table></figure>

<h4 id="模块导入是值传递（浅复制）"><a href="#模块导入是值传递（浅复制）" class="headerlink" title="模块导入是值传递（浅复制）"></a>模块导入是值传递（浅复制）</h4><ul>
<li>对于基本数据类型，模块导入复制的是数值</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">let number1 = 1;</span><br><span class="line"></span><br><span class="line">module.exports = number1;</span><br><span class="line"></span><br><span class="line">setTimeout(() =&gt; &#123;</span><br><span class="line">  console.log(number1,&#x27;我是暴露出去的number1&#x27;) // 1</span><br><span class="line">&#125;,2000)</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">let number1 = require(&#x27;./propagation&#x27;);</span><br><span class="line"></span><br><span class="line">number1 = 2;</span><br><span class="line"></span><br><span class="line">setTimeout(() =&gt; &#123;</span><br><span class="line">  console.log(number1, &#x27;我是引用被修改后的number1&#x27;)// 2</span><br><span class="line">&#125;,1000)</span><br></pre></td></tr></table></figure>

<ul>
<li>对于引用数据类型，模块导入复制的是引用地址</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> obj = &#123;</span><br><span class="line">  <span class="attr">number1</span>: <span class="number">1</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = obj;</span><br><span class="line"></span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(obj, <span class="string">&#x27;我是暴露出去的obj&#x27;</span>) <span class="comment">// &#123;number1: 2&#125;</span></span><br><span class="line">&#125;,<span class="number">1000</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">const obj = require(&#x27;./propagation&#x27;);</span><br><span class="line"></span><br><span class="line">obj.number1 = 2;</span><br><span class="line"></span><br><span class="line">setTimeout(() =&gt; &#123;</span><br><span class="line">  console.log(obj, &#x27;我是引用的obj&#x27;) // &#123;number1: 2&#125;</span><br><span class="line">&#125;,2000)</span><br></pre></td></tr></table></figure>

<h4 id="require函数的查询机制"><a href="#require函数的查询机制" class="headerlink" title="require函数的查询机制"></a>require函数的查询机制</h4><h5 id="模块路径是文件名"><a href="#模块路径是文件名" class="headerlink" title="模块路径是文件名"></a>模块路径是文件名</h5><ul>
<li>模块路径未省略后缀名</li>
</ul>
<p>如果当前require引用的模块标识是完整的，那么就会按照当前标识符进行查找</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">extname</span>: <span class="string">&#x27;js&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>模块路径省略后缀名</p>
<ul>
<li>优先查找是否存在模块名.js文件</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">extname</span>: <span class="string">&#x27;js&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;js&#x27;</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;extname&quot;</span>: <span class="string">&quot;json&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">extname</span>: <span class="string">&#x27;node&#x27;</span></span><br><span class="line">&#125; <span class="comment">// 该文件为二进制文件，会报错，但是不会报查找不到报错</span></span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> extnameObj = <span class="built_in">require</span>(<span class="string">&#x27;./require&#x27;</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(extnameObj, <span class="string">&#x27;444&#x27;</span>);</span><br><span class="line"><span class="comment">// &#123; extname: &#x27;js&#x27; &#125;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>如果未找到模块名.js，其次查找模块名.json</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">extname</span>: <span class="string">&#x27;js&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;js&#x27;</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;extname&quot;</span>: <span class="string">&quot;json&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">extname</span>: <span class="string">&#x27;node&#x27;</span></span><br><span class="line">&#125; <span class="comment">// 该文件为二进制文件，会报错，但是不会报查找不到报错</span></span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> extnameObj = <span class="built_in">require</span>(<span class="string">&#x27;./require&#x27;</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(extnameObj, <span class="string">&#x27;444&#x27;</span>);</span><br><span class="line"><span class="comment">// &#123; extname: &#x27;json&#x27; &#125;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>如果未找到模块名.json，其次查找模块名.node</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">extname</span>: <span class="string">&#x27;js&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;js&#x27;</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;extname&quot;</span>: <span class="string">&quot;json&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">extname</span>: <span class="string">&#x27;node&#x27;</span></span><br><span class="line">&#125; <span class="comment">// 该文件为二进制文件，会报错，但是不会报查找不到报错</span></span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> extnameObj = <span class="built_in">require</span>(<span class="string">&#x27;./require&#x27;</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(extnameObj, <span class="string">&#x27;444&#x27;</span>);</span><br><span class="line"><span class="comment">// return process.dlopen(module, path.toNamespacedPath(filename));</span></span><br></pre></td></tr></table></figure>

<ul>
<li>如果未查找到模块名.node，则报错</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">extname</span>: <span class="string">&#x27;js&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;js&#x27;</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;extname&quot;</span>: <span class="string">&quot;json&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">extname</span>: <span class="string">&#x27;node&#x27;</span></span><br><span class="line">&#125; <span class="comment">// 该文件为二进制文件，会报错，但是不会报查找不到报错</span></span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> extnameObj = <span class="built_in">require</span>(<span class="string">&#x27;./require&#x27;</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(extnameObj, <span class="string">&#x27;444&#x27;</span>);</span><br><span class="line"><span class="comment">// Error: Cannot find module &#x27;./require&#x27;</span></span><br></pre></td></tr></table></figure>

<h5 id="模块路径是文件夹名"><a href="#模块路径是文件夹名" class="headerlink" title="模块路径是文件夹名"></a>模块路径是文件夹名</h5><ul>
<li>先判断该模块路径是否存在，如果不存在报错</li>
<li>如果模块路径存在，查找当前文件夹中是否存在package.json</li>
</ul>
<!---->

<ul>
<li><ul>
<li>如果存在package.json,判断package.json是否有main字段</li>
</ul>
</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">    <span class="attr">extname</span>: <span class="string">&#x27;我是require文件中的index.js&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;main&quot;</span>: <span class="string">&quot;main.js&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">extname</span>: <span class="string">&#x27;我是通过package中指定的路径&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> extname = <span class="built_in">require</span>(<span class="string">&#x27;./require&#x27;</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(extname, <span class="string">&#x27;extname&#x27;</span>); <span class="comment">// &#123; extname: &#x27;我是package中的main.js&#x27; &#125;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><ul>
<li><ul>
<li>如果不存在main字段则依次查找当前目录是否存在index.js,index.json,index.node</li>
</ul>
</li>
</ul>
</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">    <span class="attr">extname</span>: <span class="string">&#x27;我是require文件中的index.js&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;main1&quot;</span>: <span class="string">&quot;main.js&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">extname</span>: <span class="string">&#x27;我是通过package中指定的路径&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> extname = <span class="built_in">require</span>(<span class="string">&#x27;./require&#x27;</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(extname, <span class="string">&#x27;extname&#x27;</span>); <span class="comment">// &#123; extname: &#x27;我是require文件中的index.js&#x27; &#125;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><ul>
<li>如果不存在package.json, 依次查找当前文件是否存在index.js,index.json,index.node</li>
</ul>
</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">    <span class="attr">extname</span>: <span class="string">&#x27;我是require文件中的index.js&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;main1&quot;</span>: <span class="string">&quot;main.js&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">module.exports = &#123;</span><br><span class="line">  extname: &#x27;我是通过package中指定的路径&#x27;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> extname = <span class="built_in">require</span>(<span class="string">&#x27;./require&#x27;</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(extname, <span class="string">&#x27;extname&#x27;</span>); <span class="comment">// &#123; extname: &#x27;我是require文件中的index.js&#x27; &#125;</span></span><br></pre></td></tr></table></figure>

<h5 id="模块路径是字符串（node-modules查找）"><a href="#模块路径是字符串（node-modules查找）" class="headerlink" title="模块路径是字符串（node_modules查找）"></a>模块路径是字符串（node_modules查找）</h5><ul>
<li>判读模块路径是否为内置模块</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">fs</span>: <span class="string">&#x27;自定义的fs&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(fs, <span class="string">&#x27;6666&#x27;</span>); <span class="comment">// node内置的fs模块</span></span><br></pre></td></tr></table></figure>

<ul>
<li>如果模块路径是内置模块，则直接加载</li>
<li>如果文件不是内置模块，那么查找和当前引用所在的文件下是否存在node_modules</li>
<li>如果存在则去node_modules中按照模块路径是文件夹的规则进行查找</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">fs</span>: <span class="string">&#x27;自定义的fs&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs1&#x27;</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(fs, <span class="string">&#x27;6666&#x27;</span>); <span class="comment">// &#123; fs: &#x27;自定义的fs&#x27; &#125;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>如果不存在，则返回上一级目录继续查找，一直查找不到则一直返回，直到返回根node_modules</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">fs</span>: <span class="string">&#x27;自定义的fs&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">fs</span>: <span class="string">&#x27;我是common下面的node_modules&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs1&#x27;</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(fs, <span class="string">&#x27;6666&#x27;</span>); <span class="comment">// &#123; fs: &#x27;我是common下面的node_modules&#x27; &#125;</span></span><br></pre></td></tr></table></figure>

<p>讲了这么模块查找机制总结一下</p>
<p>模块的导入机制</p>
<ul>
<li><strong>核心模块</strong>，如http、fs、path等</li>
<li><strong>相对路径文件模块</strong>，以.或者..开头的</li>
<li><strong>绝对路径文件模块</strong>，以&#x2F;开头</li>
<li><strong>非路径模块形式的文件模块</strong>，比如自定义模块</li>
</ul>
<p>针对不同的标识符，Node会区别对待</p>
<ul>
<li>文件扩展名分析 如果require()传递的标识是不包含文件的扩展名，那么Node会按.js、.json、.node的次序不全扩展名，而后依次尝试定位文件。</li>
<li>目录分析和包 在分析标识符的过程中，可能没有找到对应的文件，但却得到一个目录，此时Node会将目录当做一个包来处理</li>
</ul>
<p>那么，Node首先在当前目录查找package.json，通过JSON.parse()解析出包的描述对象，从中取出main属性指定的文件名进行定位，如果文件缺少扩展名，将会进入到扩展名分析的步骤。而如果main属性指定的文件名错误或压根没有package.json文件，Node就会把index当做默认文件名，然后依次查找index.js、index.json、index.node</p>
<p>如果在目录分析过程中没有成功定位，则自定义模块进入下一个模块路径进行查找（node_modules查找规则）。如果模块路径数组都遍历完依然没找到目标文件，则抛出查找失败的异常</p>
<h3 id="模块加载机制"><a href="#模块加载机制" class="headerlink" title="模块加载机制"></a>模块加载机制</h3><p>内置模块是由Node.js官方提供，内置模块的加载优先级是最高的。</p>
<h4 id="自定义模块的加载机制"><a href="#自定义模块的加载机制" class="headerlink" title="自定义模块的加载机制"></a>自定义模块的加载机制</h4><p>使用require（）加载自定义模块时，必须指定以.&#x2F;或..&#x2F;开头的文件路径，如果没有指定，就会按内置模块或第三方模块进行加载；</p>
<p>如果缺省文件后缀时，先会按照具体的文件路径加载，然后会自动补齐js后缀进行加载，如果还是没找到，就补齐json后缀进行加载，还是没找到，就会补上node后缀进行查找，如果还是没查到，报错。</p>
<h4 id="第三方模块的加载机制"><a href="#第三方模块的加载机制" class="headerlink" title="第三方模块的加载机制"></a>第三方模块的加载机制</h4><p>首先一般会先尝试在node_modules文件夹进行加载，如果没有，就会翻到上一层目录中去查找，如果还是都没有找到，就报错</p>
<h4 id="以目录作为模块"><a href="#以目录作为模块" class="headerlink" title="以目录作为模块"></a>以目录作为模块</h4><p>首先在package.json中查找main属性，以main属性指向的入口作为require入口，如果没有main属性，就会以index.js进行加载。</p>
<h3 id="模块缓存机制"><a href="#模块缓存机制" class="headerlink" title="模块缓存机制"></a>模块缓存机制</h3><p>Node.js 模块不会被重复加载，这是因为 Node.js 通过文件名缓存所有加载过的文件模块，所以以后再访问到时就不会重新加载了。Node.js 是根据实际文件名缓存的， 而不是 require() 提供的参数缓存的， 也就是说即使你分别通过require(‘react’) 和 require(‘.&#x2F;node_modules&#x2F;react’) 加载两次，也不会重复加载，因为尽管两次参数不同，解析到的文件却是同一个。正是这一机制的存在很好的解决了模块相互之间引用导致的模块依赖问题</p>
<h3 id="实现模块加载器"><a href="#实现模块加载器" class="headerlink" title="实现模块加载器"></a>实现模块加载器</h3><h4 id="module是什么"><a href="#module是什么" class="headerlink" title="module是什么"></a>module是什么</h4><p>我们来输出看一下module 是什么东西</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">number</span>: <span class="number">1</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">module</span>, <span class="string">&#x27;module&#x27;</span>)</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">Module &#123;</span></span><br><span class="line"><span class="comment">  id: &#x27;.&#x27;,</span></span><br><span class="line"><span class="comment">  path: &#x27;/Users/zhuguanglong/Desktop/前端工程化/模块化/commonjs/test&#x27;,</span></span><br><span class="line"><span class="comment">  exports: &#123; number: 1 &#125;,</span></span><br><span class="line"><span class="comment">  parent: null,</span></span><br><span class="line"><span class="comment">  filename: &#x27;/Users/zhuguanglong/Desktop/前端工程化/模块化/commonjs/test/index.js&#x27;,</span></span><br><span class="line"><span class="comment">  loaded: false,</span></span><br><span class="line"><span class="comment">  children: [],</span></span><br><span class="line"><span class="comment">  paths: [</span></span><br><span class="line"><span class="comment">    &#x27;/Users/zhuguanglong/Desktop/前端工程化/模块化/commonjs/test/node_modules&#x27;,</span></span><br><span class="line"><span class="comment">    &#x27;/Users/zhuguanglong/Desktop/前端工程化/模块化/commonjs/node_modules&#x27;,</span></span><br><span class="line"><span class="comment">    &#x27;/Users/zhuguanglong/Desktop/前端工程化/模块化/node_modules&#x27;,</span></span><br><span class="line"><span class="comment">    &#x27;/Users/zhuguanglong/Desktop/前端工程化/node_modules&#x27;,</span></span><br><span class="line"><span class="comment">    &#x27;/Users/zhuguanglong/Desktop/node_modules&#x27;,</span></span><br><span class="line"><span class="comment">    &#x27;/Users/zhuguanglong/node_modules&#x27;,</span></span><br><span class="line"><span class="comment">    &#x27;/Users/node_modules&#x27;,</span></span><br><span class="line"><span class="comment">    &#x27;/node_modules&#x27;</span></span><br><span class="line"><span class="comment">  ]</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p>我们发现module其实是一个对象，我们接下来分析一下module对象上的各属性</p>
<p>module对象上的属性</p>
<ul>
<li>id 模块唯一标识(一般是当前文件所在的路径）</li>
<li>path 模块所在的文件夹的路径</li>
<li>exports 模块的导出对象</li>
<li>parent</li>
<li>filename 文件绝对路径</li>
<li>loaded 是否第一次加载</li>
<li>children 所被加载的其他模块</li>
<li>paths 当前文件假想的所在node_modules的路径</li>
</ul>
<p>搞清楚了module对象上都有哪些属性以后我们就可以着手创建模块对象了</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&#x27;path&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Module</span> &#123;</span><br><span class="line">  private <span class="attr">id</span>: string;</span><br><span class="line">  private <span class="attr">path</span>: string;</span><br><span class="line">  public <span class="attr">exports</span>: <span class="title class_">Record</span>&lt;string, any&gt;;</span><br><span class="line">  private <span class="attr">parent</span>: <span class="literal">null</span> | <span class="title class_">Array</span>&lt;any&gt;;</span><br><span class="line">  private <span class="attr">filename</span>: string;</span><br><span class="line">  public <span class="attr">loaded</span>: boolean;</span><br><span class="line">  public <span class="attr">children</span>: <span class="title class_">Module</span>[];</span><br><span class="line">  private <span class="attr">paths</span>: string[];</span><br><span class="line"></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">filename: string</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">path</span> = path.<span class="title function_">resolve</span>(<span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">paths</span> = <span class="title function_">resolvePaths</span>(path);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">loaded</span> = <span class="literal">false</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">filename</span> = filename;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">id</span> = filename;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">parent</span> = <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">NODE_MODULES</span> = <span class="string">&#x27;/node_modules&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> path &#123; string &#125; 文件路径;</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns</span> paths &#123;string[]&#125; 文件可能存在的路径；</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> <span class="variable">zgl</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@desprition</span> 获取文件路径数组</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">resolvePaths</span>(<span class="params">path: string</span>): string[] &#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="attr">newPaths</span>: string[] = [];</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> path !== <span class="string">&#x27;string&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> newPaths;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> paths = path.<span class="title function_">split</span>(<span class="string">&#x27;/&#x27;</span>);</span><br><span class="line">  <span class="keyword">let</span> <span class="attr">filepath</span>: string  = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; paths.<span class="property">length</span>; i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (i &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      filepath += <span class="string">&#x27;/&#x27;</span> + paths[i];</span><br><span class="line">    &#125; </span><br><span class="line">      newPaths.<span class="title function_">push</span>(<span class="string">`<span class="subst">$&#123;filepath&#125;</span><span class="subst">$&#123;NODE_MODULES&#125;</span>`</span>);   </span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> newPaths;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="加载模块"><a href="#加载模块" class="headerlink" title="加载模块"></a>加载模块</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">tryModuleLoad</span>(<span class="params"><span class="variable language_">module</span>: Module</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> extension = <span class="title function_">extname</span>(<span class="variable language_">module</span>.<span class="property">filename</span>);</span><br><span class="line">    extensions[extension](<span class="variable language_">module</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="将路径转化为绝对路径"><a href="#将路径转化为绝对路径" class="headerlink" title="将路径转化为绝对路径"></a>将路径转化为绝对路径</h4><p>不管模块标识是怎么样的，最后都会将其转化为绝对路径</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; resolve &#125; = <span class="built_in">require</span>(<span class="string">&#x27;path&#x27;</span>);</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">resolveFilename</span>(<span class="params">path: stirng</span>): string &#123;</span><br><span class="line">  <span class="keyword">const</span> absoultPath = <span class="title function_">resolve</span>(__dirname, path);</span><br><span class="line">  <span class="keyword">return</span> absoultPath;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="获取文件后缀"><a href="#获取文件后缀" class="headerlink" title="获取文件后缀"></a>获取文件后缀</h4><p>由于针对以.js结尾的和.json结尾和.node结尾的逻辑不一样，因此我们需要获取文件后缀</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">getExtision</span>(<span class="params">path: string</span>): stirng &#123;</span><br><span class="line">  <span class="keyword">const</span> extision = path.<span class="title function_">extname</span>(path);</span><br><span class="line">  <span class="keyword">return</span> extision;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="处理不一样后缀的逻辑"><a href="#处理不一样后缀的逻辑" class="headerlink" title="处理不一样后缀的逻辑"></a>处理不一样后缀的逻辑</h4><ul>
<li>.js: 将代码包裹在一个匿名自执行函数中</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> wrapper = [</span><br><span class="line">  <span class="string">&#x27;(function(exports, module, require, __dirname, __filename))&#123;&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;&#125;)&#x27;</span></span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> extensions = &#123;</span><br><span class="line">  <span class="string">&#x27;.js&#x27;</span>(<span class="variable language_">module</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> content = <span class="title function_">readFileSync</span>(<span class="variable language_">module</span>.<span class="property">filename</span>, <span class="string">&#x27;utf-8&#x27;</span>);</span><br><span class="line">    <span class="keyword">const</span> fnStr = wrapper[<span class="number">0</span>] + content + wrapper[<span class="number">1</span>];</span><br><span class="line">    <span class="keyword">const</span> fn = <span class="title function_">runInThisContext</span>(fnStr);</span><br><span class="line">    <span class="keyword">const</span> &#123; <span class="built_in">exports</span>, path, filename &#125; = <span class="variable language_">module</span>;</span><br><span class="line">    <span class="comment">// 将this绑定给暴露出来的模块</span></span><br><span class="line">    fn.<span class="title function_">call</span>(<span class="built_in">exports</span>, <span class="built_in">exports</span>, <span class="variable language_">module</span>, myRequire, path, filename)</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>.json: 将json进行序列化</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> extensions = &#123;</span><br><span class="line">  <span class="string">&#x27;.json&#x27;</span>(<span class="variable language_">module</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> content = <span class="title function_">readFileSync</span>(<span class="variable language_">module</span>.<span class="property">filename</span>, <span class="string">&#x27;utf-8&#x27;</span>);</span><br><span class="line">    <span class="keyword">const</span> contentObj =  <span class="title class_">JSON</span>.<span class="title function_">parse</span>(content);</span><br><span class="line">    <span class="variable language_">module</span>.<span class="property">exports</span> = contentObj;</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>.node: 利用process.dlopen进行执行</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> extensions = &#123;</span><br><span class="line">  <span class="string">&#x27;.node&#x27;</span>(<span class="variable language_">module</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; filename &#125; = <span class="variable language_">module</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">dlopen</span>(<span class="variable language_">module</span>, <span class="title function_">toNamespacedPath</span>(filename));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="string">``</span><span class="string">`js</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#### 尝试添加后缀</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">如果文件是省略文件后缀的形式给文件名分别添加.js，.json, .node 判断文件是否存在</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">`</span><span class="string">``</span>js</span><br><span class="line"><span class="keyword">const</span> &#123; accessSync &#125; = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">findExt</span>(<span class="params">absolutePath: sting</span>): sting &#123;</span><br><span class="line">  <span class="keyword">const</span> extNames = <span class="title class_">Object</span>.<span class="title function_">keys</span>(extensions);</span><br><span class="line">  <span class="keyword">let</span> index = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">if</span>(extNames.<span class="property">length</span> === index) &#123;</span><br><span class="line">      <span class="comment">// 如果没有找到文件名，那么就去找文件夹</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">accessSync</span>(absolutePath + extNames[index]);</span><br><span class="line">    <span class="keyword">return</span> absolutePath + extNames[index];</span><br><span class="line">  &#125;<span class="keyword">catch</span>(e) &#123;</span><br><span class="line">    index++;</span><br><span class="line">    <span class="title function_">findExt</span>(absolutePath + extNames[index]);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="路径是文件"><a href="#路径是文件" class="headerlink" title="路径是文件"></a>路径是文件</h4><p>如果当前路径为文件，那么先判断当前文件下是否存在package.json, 如果存在解析main字段所对应的文件路径，如果不存在package.json,那么尝试寻找index.js，index.json, index.node</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(extNames.<span class="property">length</span> === index) &#123;</span><br><span class="line">      <span class="comment">// 如果没有找到文件名，那么就去找文件夹</span></span><br><span class="line">  <span class="title function_">findDirExt</span>(absoultPath);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">findDirExt</span>(<span class="params">absoultPath: string</span>): string &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">     <span class="title function_">accessSync</span>(<span class="title function_">join</span>(absolutePath, <span class="string">&#x27;package.json&#x27;</span>));</span><br><span class="line">     <span class="keyword">const</span> content = <span class="title function_">findExt</span>(<span class="title function_">join</span>(absolutePath, <span class="string">&#x27;./package.json&#x27;</span>));</span><br><span class="line">      <span class="keyword">const</span> contentObj = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(content);</span><br><span class="line">      <span class="keyword">if</span> (<span class="string">&#x27;main&#x27;</span> <span class="keyword">in</span> contentObj) &#123;</span><br><span class="line">        absolutePath = <span class="title function_">findExt</span>(<span class="title function_">resolve</span>(absolutePath, contentObj[main]));</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        absolutePath = <span class="title function_">findExt</span>(<span class="title function_">resolve</span>(absolutePath, <span class="string">&#x27;index&#x27;</span>));</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  &#125; <span class="keyword">catch</span>(e) &#123;</span><br><span class="line">    absolutePath = <span class="title function_">findExt</span>(<span class="title function_">resolve</span>(absolutePath, <span class="string">&#x27;index&#x27;</span>));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="路径是模块"><a href="#路径是模块" class="headerlink" title="路径是模块"></a>路径是模块</h4><h6 id="内置模块"><a href="#内置模块" class="headerlink" title="内置模块"></a>内置模块</h6><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (naviteModule.<span class="title function_">includes</span>(absolutePath)) &#123;</span><br><span class="line">      <span class="comment">// 内置模块对应的二机制文件</span></span><br><span class="line">      absolutePath = <span class="string">&#x27;内置模块路径&#x27;</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h6 id="自定义模块"><a href="#自定义模块" class="headerlink" title="自定义模块"></a>自定义模块</h6><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> paths = <span class="title function_">resolvePaths</span>(absolutePath);</span><br><span class="line">      <span class="keyword">let</span> i = paths.<span class="property">length</span> - <span class="number">1</span>;</span><br><span class="line">      <span class="keyword">while</span> (i &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_">findExt</span>(paths[i)) &#123;</span><br><span class="line">          absolutePath = <span class="title function_">findExt</span>(paths[i]);</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          </span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">const</span> path = <span class="title function_">findDirExt</span>(paths[i]);</span><br><span class="line">        <span class="keyword">if</span> (path) &#123;</span><br><span class="line">          absolutePath = path;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        i--;</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>

<h4 id="完整的require函数逻辑"><a href="#完整的require函数逻辑" class="headerlink" title="完整的require函数逻辑"></a>完整的require函数逻辑</h4><p>require函数主要是用来加载模块的</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="variable constant_">CHAR_DOT</span> = <span class="string">&#x27;.&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">CHAR_FORWARD_SLASH</span> = <span class="string">&#x27;/&#x27;</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">require</span>(<span class="params">moduleId</span>) &#123;</span><br><span class="line">  <span class="comment">// 获取文件绝对路径</span></span><br><span class="line">  <span class="keyword">let</span> absolutePath = <span class="title function_">resolve</span>(__dirname, moduleId);</span><br><span class="line">  <span class="keyword">let</span> oldAbsolutePath = absolutePath;</span><br><span class="line">  <span class="keyword">const</span> extension = <span class="title function_">extname</span>(absolutePath);</span><br><span class="line">  <span class="keyword">if</span> (<span class="title class_">Module</span>.<span class="title function_">getCacheByModuleId</span>(absolutePath)) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Module</span>.<span class="title function_">getCacheByModuleId</span>(absolutePath);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 如果模块后缀不存在那么加判断加载模块</span></span><br><span class="line">  <span class="keyword">if</span> (!extension) &#123;</span><br><span class="line">    absolutePath = <span class="title function_">findExt</span>(absolutePath);</span><br><span class="line">    <span class="comment">// 不是完整的路径</span></span><br><span class="line">  &#125;  <span class="keyword">else</span> <span class="keyword">if</span> (absolutePath.<span class="title function_">charCodeAt</span>(<span class="number">0</span>) !== <span class="variable constant_">CHAR_DOT</span> ||</span><br><span class="line">       absolutePath.<span class="title function_">charCodeAt</span>(<span class="number">0</span>) !== <span class="variable constant_">CHAR_FORWARD_SLASH</span>) &#123;</span><br><span class="line">    <span class="comment">// 内置模块</span></span><br><span class="line">    <span class="keyword">if</span> (naviteModule.<span class="title function_">includes</span>(absolutePath)) &#123;</span><br><span class="line">      <span class="comment">// 内置模块对应的二机制文件</span></span><br><span class="line">      absolutePath = <span class="string">&#x27;内置模块路径&#x27;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 第三方定义的模块</span></span><br><span class="line">      <span class="keyword">const</span> paths = <span class="title function_">resolvePaths</span>(absolutePath);</span><br><span class="line">      <span class="keyword">let</span> i = paths.<span class="property">length</span> - <span class="number">1</span>;</span><br><span class="line">      <span class="keyword">while</span> (i &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> path = <span class="built_in">require</span>(paths[i]);</span><br><span class="line">        <span class="keyword">if</span> (path) &#123;</span><br><span class="line">          absolutePath = path;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        i--;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 加载模块</span></span><br><span class="line">  <span class="comment">// 模块加载完以后才创建一个模块</span></span><br><span class="line">  <span class="keyword">const</span> <span class="variable language_">module</span> = <span class="keyword">new</span> <span class="title class_">Module</span>(absolutePath);</span><br><span class="line">  <span class="title class_">Module</span>.<span class="title function_">setCacheByModuleId</span>(absolutePath, <span class="variable language_">module</span>);</span><br><span class="line">  <span class="variable language_">module</span>.<span class="property">loade</span> = <span class="literal">true</span>;</span><br><span class="line">  <span class="variable language_">module</span>.<span class="property">children</span>.<span class="title function_">push</span>(absolutePath);</span><br><span class="line">  <span class="title function_">tryModuleLoad</span>(<span class="variable language_">module</span>);</span><br><span class="line">  <span class="comment">// 返回module.exports</span></span><br><span class="line">  <span class="keyword">return</span> <span class="variable language_">module</span>.<span class="property">exports</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://imperial-long.github.io/blog/2023/01/17/promise%E6%8F%AD%E7%A7%98/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="朱广龙">
      <meta itemprop="description" content="定期会更新前端技术栈 不限于vue，react，node以及部分后端的知识">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="朱广龙的个人博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2023/01/17/promise%E6%8F%AD%E7%A7%98/" class="post-title-link" itemprop="url">promise揭秘</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-01-17 20:39:00" itemprop="dateCreated datePublished" datetime="2023-01-17T20:39:00+08:00">2023-01-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-10-10 13:09:49" itemprop="dateModified" datetime="2024-10-10T13:09:49+08:00">2024-10-10</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>最近我看了很多与promise相关的文章以及书籍，我觉得他们并没有将promise讲的特别透彻，比如promise的resolve是一个带有then方法的对象会是怎么样，尤其这一点特别重要在讲实现async await的时候这一点尤其的重要，接下来请大家忘记自己之前学的东西，和我一起梳理一下promise</p>
<h2 id="promise的含义"><a href="#promise的含义" class="headerlink" title="promise的含义"></a>promise的含义</h2><p>promise一个采用订阅发布设计模式进行设计的容器，准确的说只有外界通过函数进行订阅了以后，里面会发布出某个将来才会得到的结果（通常是一个异步操作）的结果。</p>
<h2 id="promise的特点"><a href="#promise的特点" class="headerlink" title="promise的特点"></a>promise的特点</h2><h3 id="状态不受外界影响"><a href="#状态不受外界影响" class="headerlink" title="状态不受外界影响"></a>状态不受外界影响</h3><p>Promise对象代表一个异步操作，有三种状态</p>
<ul>
<li>pending(进行中)</li>
<li>fulfilled(已成功)</li>
<li>rejected(已拒绝)</li>
</ul>
<p>只有reject，resolve可以决定当前是哪一种状态，任何其他操作都无法改变这个状态。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> p = <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span>&#123;&#125;);</span><br><span class="line">p.<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;pending&#x27;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(p, <span class="string">&#x27;pending&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>上述代码由于promise内部没有调用resolve或者reject,所以promise的状态还是pending状态 <img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6cfc10c916c847b981d5ac6c0bd31ea3~tplv-k3u1fbpfcp-zoom-1.image" alt="image.png"> 下面我们将通过调用resolve来进行改变promise的状态</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> p = <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span>&#123;</span><br><span class="line">  <span class="title function_">resolve</span>();</span><br><span class="line">&#125;);</span><br><span class="line">p.<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;fulfilled&#x27;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(p, <span class="string">&#x27;fulfilled&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/43c9edf9b632403692e5072304612fd1~tplv-k3u1fbpfcp-zoom-1.image" alt="image.png"> 下面我们将通过调用reject来进行改变promise的状态</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> p = <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span>&#123;</span><br><span class="line">  <span class="title function_">reject</span>();</span><br><span class="line">&#125;);</span><br><span class="line">p.<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;fulfilled&#x27;</span>);</span><br><span class="line">&#125;).<span class="title function_">catch</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;rejected&#x27;</span>)</span><br><span class="line">&#125;);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(p, <span class="string">&#x27;rejected&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c66b226fb3034cb7a1958a6d67d15403~tplv-k3u1fbpfcp-zoom-1.image" alt="image.png"></p>
<h3 id="一旦状态改变，就不会再变"><a href="#一旦状态改变，就不会再变" class="headerlink" title="一旦状态改变，就不会再变"></a>一旦状态改变，就不会再变</h3><p>Promise对象的状态改变，只有两种可能：</p>
<ul>
<li>pending -&gt; fulfilled</li>
<li>pending -&gt; rejected</li>
</ul>
<p>只要这两种情况发生，状态就凝固了，不会再变了，会一直保持这个结果</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> p = <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span>&#123;</span><br><span class="line">  <span class="title function_">resovle</span>();</span><br><span class="line">  <span class="title function_">reject</span>();</span><br><span class="line">&#125;);</span><br><span class="line">p.<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;fulfilled&#x27;</span>);</span><br><span class="line">&#125;).<span class="title function_">catch</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;rejected&#x27;</span>)</span><br><span class="line">&#125;);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(p, <span class="string">&#x27;fulfilled&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3e39d6e871f34a5e9200d78f66133b99~tplv-k3u1fbpfcp-zoom-1.image" alt="image.png"></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> p = <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span>&#123;</span><br><span class="line">  <span class="title function_">reject</span>();</span><br><span class="line">  <span class="title function_">resolve</span>();</span><br><span class="line">&#125;);</span><br><span class="line">p.<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;fulfilled&#x27;</span>);</span><br><span class="line">&#125;).<span class="title function_">catch</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;rejected&#x27;</span>)</span><br><span class="line">&#125;);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(p, <span class="string">&#x27;rejected&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/bf9be13c639f4f90a3d092c0d2787615~tplv-k3u1fbpfcp-zoom-1.image" alt="image.png"></p>
<h2 id="promise的基本用法"><a href="#promise的基本用法" class="headerlink" title="promise的基本用法"></a>promise的基本用法</h2><h3 id="promise是构造函数"><a href="#promise是构造函数" class="headerlink" title="promise是构造函数"></a>promise是构造函数</h3><p>Promise对象是一个构造函数，用来生成Promise实例。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> a = <span class="keyword">new</span> <span class="title class_">Promie</span>();</span><br></pre></td></tr></table></figure>

<h3 id="promise接受一个函数"><a href="#promise接受一个函数" class="headerlink" title="promise接受一个函数"></a>promise接受一个函数</h3><p>Promise构造函数接受一个函数作为参数，该函数的两个参数分别是resolve和reject,都是函数 <img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/5190082d4c784fe2bd208cb2d87085e5~tplv-k3u1fbpfcp-zoom-1.image" alt="image.png"> <img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ae16f4dc4e2f46dc896f768a8e5a7646~tplv-k3u1fbpfcp-zoom-1.image" alt="image.png"></p>
<h3 id="reslove函数传参"><a href="#reslove函数传参" class="headerlink" title="reslove函数传参"></a>reslove函数传参</h3><p>如果调用resolve函数和reject函数时带有参数，那么它们的参数会被传递给回调函数。resolve函数的参数除了正常的值以外，还可能是另一个 Promise 实例</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">const</span> p = <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span>&#123;</span><br><span class="line">  <span class="title function_">resolve</span>(<span class="string">&#x27;zgl&#x27;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> p1 = <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span>&#123;</span><br><span class="line">  <span class="title function_">resolve</span>(p);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">p.<span class="title function_">then</span>(<span class="function">(<span class="params">name</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(name); <span class="comment">// zgl</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">p1.<span class="title function_">then</span>(<span class="function">(<span class="params">name</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(name); <span class="comment">// zgl</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>这时p的状态就会传递给p1，也就是说，p的状态决定了p1的状态。如果p的状态是pending，那么p1的回调函数就会等待p的状态改变；如果p的状态已经是resolved或者rejected那么p1的回调函数将会立刻执行</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> p = <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span>&#123;</span><br><span class="line">  <span class="title function_">resolve</span>(<span class="string">&#x27;zgl&#x27;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="keyword">const</span> p1 = <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span>&#123;</span><br><span class="line">  <span class="title function_">resolve</span>(p);</span><br><span class="line">&#125;);</span><br><span class="line">p1.<span class="title function_">then</span>(<span class="function">(<span class="params">name</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(name); <span class="comment">// zgl</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> p2 = <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span>&#123;</span><br><span class="line">  <span class="title function_">reject</span>(<span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;reject&#x27;</span>));</span><br><span class="line">&#125;);</span><br><span class="line"><span class="keyword">const</span> p3 = <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span>&#123;</span><br><span class="line">  <span class="title function_">resolve</span>(p2); <span class="comment">// 未执行p2</span></span><br><span class="line">&#125;);</span><br><span class="line">p3.<span class="title function_">then</span>(<span class="function">(<span class="params">name</span>)=&gt;</span>&#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(name)</span><br><span class="line">&#125;,<span class="function">(<span class="params">error</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(error);</span><br><span class="line">  <span class="comment">/* error: reject</span></span><br><span class="line"><span class="comment">    at &lt;anonymous&gt;:2:10</span></span><br><span class="line"><span class="comment">    at new Promise (&lt;anonymous&gt;)</span></span><br><span class="line"><span class="comment">    at &lt;anonymous&gt;:1:12</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="reject函数传参"><a href="#reject函数传参" class="headerlink" title="reject函数传参"></a>reject函数传参</h3><p>reject函数的参数通常是Error对象的实例，表示抛出的错误</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">const</span> p = <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span>&#123;</span><br><span class="line">  <span class="title function_">reject</span>(<span class="string">&#x27;zgl&#x27;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">p.<span class="title function_">then</span>(<span class="function">(<span class="params">name</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(name);</span><br><span class="line">&#125;,<span class="function">(<span class="params">error</span>)=&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(error); <span class="comment">// zgl</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h2 id="promise对象常见的方法"><a href="#promise对象常见的方法" class="headerlink" title="promise对象常见的方法"></a>promise对象常见的方法</h2><h3 id="then方法"><a href="#then方法" class="headerlink" title="then方法"></a>then方法</h3><h4 id="then参数支持传入2个函数"><a href="#then参数支持传入2个函数" class="headerlink" title="then参数支持传入2个函数"></a>then参数支持传入2个函数</h4><p>Promise实例生成以后，可以在then方法传入2个函数参数分别监听resolved状态和rejected状态的回调函数,</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">const</span> p = <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span>&#123;</span><br><span class="line">  <span class="title function_">resolve</span>();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">p.<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;fulfilled&#x27;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> p1 = <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span>&#123;</span><br><span class="line">  <span class="title function_">reject</span>();</span><br><span class="line">&#125;);</span><br><span class="line">p1.<span class="title function_">then</span>(<span class="function">()=&gt;</span>&#123;&#125;,<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;fulfilled&#x27;</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/77982a4b97bd4dc4ad676cdf1e7f7d9e~tplv-k3u1fbpfcp-zoom-1.image" alt="image.png"></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> p = <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span>&#123;</span><br><span class="line">  <span class="title function_">reject</span>();</span><br><span class="line">&#125;);</span><br><span class="line">p.<span class="title function_">then</span>(<span class="function">()=&gt;</span>&#123;&#125;,<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;rejected&#x27;</span>)</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/52cfbdffd93f4010905deaf7f6b59209~tplv-k3u1fbpfcp-zoom-1.image" alt="image.png"></p>
<h4 id="第一个函数接受resolve函数的参数"><a href="#第一个函数接受resolve函数的参数" class="headerlink" title="第一个函数接受resolve函数的参数"></a>第一个函数接受resolve函数的参数</h4><p>如果调用resolve函数和reject函数时带有参数，那么它们的参数会被传递给then的第一个参数。resolve函数的参数除了正常的值以外，还可能是带有then方法的对象,只有当前对象resolveed或者rejected才会改变当前promise的状态</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">const</span> p = <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span>&#123;</span><br><span class="line">  <span class="title function_">resolve</span>(<span class="string">&#x27;zgl&#x27;</span>);</span><br><span class="line">&#125;);</span><br><span class="line">p.<span class="title function_">then</span>(<span class="function">(<span class="params">name</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(name); <span class="comment">// zgl</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">const p = new Promise((resolve, reject) =&gt;&#123;</span><br><span class="line">  resolve(&#x27;zgl&#x27;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">const p1 = new Promise((resolve, reject) =&gt;&#123;</span><br><span class="line">  resolve(p);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">p1.then((name) =&gt; &#123;</span><br><span class="line">  console.log(name); // zgl</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>这时如果传入的参数为带有then的方法的对象那么就会执行该对象的then方法</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> obj = &#123;</span><br><span class="line">  <span class="attr">age</span>: <span class="string">&#x27;24&#x27;</span>,</span><br><span class="line">  <span class="title function_">then</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">age</span>); <span class="comment">// 24</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> p1 = <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span>&#123;</span><br><span class="line">  <span class="title function_">resolve</span>(obj);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p1.<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h4 id="第二个函数接受reject函数的参数"><a href="#第二个函数接受reject函数的参数" class="headerlink" title="第二个函数接受reject函数的参数"></a>第二个函数接受reject函数的参数</h4><p>reject函数的参数通常是Error对象的实例，表示抛出的错误</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">const</span> p = <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span>&#123;</span><br><span class="line">  <span class="title function_">reject</span>(<span class="string">&#x27;zgl&#x27;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">p.<span class="title function_">then</span>(<span class="function">(<span class="params">name</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(name);</span><br><span class="line">&#125;,<span class="function">(<span class="params">error</span>)=&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(error); <span class="comment">// zgl</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h4 id="then返回新的promise"><a href="#then返回新的promise" class="headerlink" title="then返回新的promise"></a>then返回新的promise</h4><p>then方法的返回值是一个新的promise</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> p = <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span>&#123;</span><br><span class="line">  <span class="title function_">resolve</span>(<span class="string">&#x27;zgl&#x27;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="keyword">const</span> p1 = p.<span class="title function_">then</span>(<span class="function">(<span class="params">name</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(name); <span class="comment">// zgl</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(p1 <span class="keyword">instanceof</span> <span class="title class_">Promise</span>) <span class="comment">// true;</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(p1 === p) <span class="comment">// false</span></span><br></pre></td></tr></table></figure>

<h5 id="then方法支持链式调用"><a href="#then方法支持链式调用" class="headerlink" title="then方法支持链式调用"></a>then方法支持链式调用</h5><p>then方法返回的是一个新的Promise实例。因此可以采用链式写法，即then方法后面再调用另一个then方法</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> p = <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span>&#123;</span><br><span class="line">  <span class="title function_">resolve</span>(<span class="string">&#x27;zgl&#x27;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="keyword">const</span> p1 = p.<span class="title function_">then</span>(<span class="function">(<span class="params">name</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(name); <span class="comment">// zgl</span></span><br><span class="line">&#125;).<span class="title function_">then</span>(<span class="function">()=&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">2222</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h5 id="第一个then的返回值会传入第二个then函数的形参中"><a href="#第一个then的返回值会传入第二个then函数的形参中" class="headerlink" title="第一个then的返回值会传入第二个then函数的形参中"></a>第一个then的返回值会传入第二个then函数的形参中</h5><p>第一个回调函数完成以后，会将返回结果作为参数，传入第二个回调函数,第一个then函数的返回值除了正常的值以外，还可能是带有then方法的对象,只有当前对象resolved或者rejected才会将resolved的值传入第二个then的形参中</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> p = <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span>&#123;</span><br><span class="line">  <span class="title function_">resolve</span>(<span class="string">&#x27;zgl&#x27;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="keyword">const</span> p1 = p.<span class="title function_">then</span>(<span class="function">(<span class="params">name</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> name;</span><br><span class="line">&#125;).<span class="title function_">then</span>(<span class="function">(<span class="params">name</span>)=&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(name); <span class="comment">// zgl</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> p = <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span>&#123;</span><br><span class="line">  <span class="title function_">resolve</span>(<span class="string">&#x27;zgl&#x27;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> p1 = <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span>&#123;</span><br><span class="line">  <span class="title function_">resolve</span>(<span class="number">24</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"> p.<span class="title function_">then</span>(<span class="function">(<span class="params">name</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> p1 ;</span><br><span class="line">&#125;).<span class="title function_">then</span>(<span class="function">(<span class="params">age</span>)=&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(age); <span class="comment">// 24</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>如果then的返回值为一个带有then的对象，那么就会调用该对象的then方法。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> obj = &#123;</span><br><span class="line">  <span class="attr">age</span>: <span class="string">&#x27;24&#x27;</span>,</span><br><span class="line">  <span class="title function_">then</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">age</span>); <span class="comment">// 24</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> p1 = <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span>&#123;</span><br><span class="line">  <span class="title function_">resolve</span>(<span class="string">&#x27;zgl&#x27;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">p1.<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> obj</span><br><span class="line">&#125;).<span class="title function_">then</span>(<span class="function">(<span class="params">obj</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(obj)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h5 id="then方法第一个参数传入不是函数时，会一直传递"><a href="#then方法第一个参数传入不是函数时，会一直传递" class="headerlink" title="then方法第一个参数传入不是函数时，会一直传递"></a>then方法第一个参数传入不是函数时，会一直传递</h5><p>当传入then的第一个参数不为函数时，此时promise resolved的值会一直传递下去，直到某个then的第一个参数为函数时</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> p = <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span>&#123;</span><br><span class="line">  <span class="title function_">resolve</span>(<span class="string">&#x27;zgl&#x27;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="keyword">const</span> p1 = p.<span class="title function_">then</span>().<span class="title function_">then</span>().<span class="title function_">then</span>(<span class="function">(<span class="params">name</span>)=&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(name); <span class="comment">// zgl</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>当promise发生错误时，then的第二个参数不为函数时，此时promise rejected的值会一直传递下去，直到某个then的第二个参数捕获到当前错误</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> p = <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span>&#123;</span><br><span class="line">  <span class="title function_">reject</span>(<span class="string">&#x27;zgl&#x27;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="keyword">const</span> p1 = p.<span class="title function_">then</span>(<span class="function">()=&gt;</span> &#123;&#125;).<span class="title function_">then</span>(<span class="function">()=&gt;</span>&#123;&#125;).<span class="title function_">then</span>(<span class="function">()=&gt;</span>&#123;&#125;,<span class="function">(<span class="params">name</span>)=&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(name); <span class="comment">// zgl</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h4 id="then方法可以监听多个回调函数"><a href="#then方法可以监听多个回调函数" class="headerlink" title="then方法可以监听多个回调函数"></a>then方法可以监听多个回调函数</h4><p>对于同一个promise的then方法是能够注册多个回调函数的</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> p = <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span>&#123;</span><br><span class="line">  <span class="title function_">resolve</span>(<span class="string">&#x27;zgl&#x27;</span>);</span><br><span class="line">&#125;);</span><br><span class="line">p.<span class="title function_">then</span>(<span class="function">(<span class="params">name</span>)=&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(name);</span><br><span class="line">&#125;);</span><br><span class="line">p.<span class="title function_">then</span>(<span class="function">(<span class="params">name</span>)=&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(name);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="catch方法"><a href="#catch方法" class="headerlink" title="catch方法"></a>catch方法</h3><p>catch方法是then(undefined, rejection)的别名，用于指定发生错误时的回调函数。</p>
<h4 id="catch是then-undefined-rejection-的语法糖"><a href="#catch是then-undefined-rejection-的语法糖" class="headerlink" title="catch是then(undefined, rejection)的语法糖"></a>catch是then(undefined, rejection)的语法糖</h4><p>catch是为了方便then能够更加方便的，简化捕获错误的过程,then能够支持的。catch都能够支持</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> p = <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span>&#123;</span><br><span class="line">  <span class="title function_">reject</span>(<span class="string">&#x27;zgl&#x27;</span>);</span><br><span class="line">&#125;);</span><br><span class="line">p.<span class="title function_">then</span>(<span class="literal">undefined</span>, <span class="function">(<span class="params">name</span>)=&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(name); <span class="comment">// zgl</span></span><br><span class="line">&#125;);</span><br><span class="line">p.<span class="title function_">catch</span>(<span class="function"><span class="params">name</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(name); <span class="comment">//zgl</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>我们再来看看下面的几段代码思考一下</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> p = <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span>&#123;</span><br><span class="line">  <span class="title function_">reject</span>(<span class="string">&#x27;zgl&#x27;</span>);</span><br><span class="line">&#125;);</span><br><span class="line">p.<span class="title function_">then</span>(<span class="literal">undefined</span>, <span class="function">(<span class="params">name</span>)=&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(name); <span class="comment">// zgl</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> p = <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span>&#123;</span><br><span class="line">  <span class="title function_">reject</span>(<span class="string">&#x27;zgl&#x27;</span>);</span><br><span class="line">&#125;);</span><br><span class="line">p.<span class="title function_">then</span>(<span class="literal">undefined</span>, <span class="function">(<span class="params">name</span>)=&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span>&#123;</span><br><span class="line">  <span class="title function_">reject</span>(<span class="number">27</span>);</span><br><span class="line">&#125;)</span><br><span class="line">&#125;).<span class="title function_">then</span>(<span class="literal">undefined</span>, <span class="function">(<span class="params">age</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(age); <span class="comment">// 27</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> p = <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span>&#123;</span><br><span class="line">  <span class="title function_">reject</span>(<span class="string">&#x27;zgl&#x27;</span>);</span><br><span class="line">&#125;);</span><br><span class="line">p.<span class="title function_">then</span>(<span class="literal">undefined</span>, <span class="function">(<span class="params">name</span>)=&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span>&#123;</span><br><span class="line">  <span class="title function_">reject</span>(<span class="number">27</span>);</span><br><span class="line">&#125;)</span><br><span class="line">&#125;)</span><br><span class="line">&#125;).<span class="title function_">then</span>(<span class="literal">undefined</span>, <span class="function">(<span class="params">age</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span>&#123;</span><br><span class="line">  <span class="title function_">reject</span>(<span class="string">&#x27;xxxx&#x27;</span>);</span><br><span class="line">&#125;).<span class="title function_">then</span>(<span class="literal">undefined</span>, <span class="function">(<span class="params">val</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(val); <span class="comment">// xxxx</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>通过以上实验发现，then的第二个参数作为函数时只能捕获前面一个promise产生的错误，并不能捕获到一开始就状态为rejected的promise，还记得在then中如果第二个参数不为函数时会直到为某个函数时才会捕获</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> p = <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span>&#123;</span><br><span class="line">  <span class="title function_">reject</span>(<span class="string">&#x27;zgl&#x27;</span>);</span><br><span class="line">&#125;);</span><br><span class="line">p.<span class="title function_">then</span>(<span class="literal">undefined</span>).<span class="title function_">then</span>(<span class="literal">undefined</span>, <span class="function">(<span class="params">age</span>) =&gt;</span> &#123;</span><br><span class="line">   <span class="variable language_">console</span>.<span class="title function_">log</span>(age)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> p = <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span>&#123;</span><br><span class="line">  <span class="title function_">resolve</span>(<span class="string">&#x27;zgl&#x27;</span>);</span><br><span class="line">&#125;);</span><br><span class="line">p.<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span>&#123;</span><br><span class="line">  <span class="title function_">reject</span>(<span class="number">27</span>);</span><br><span class="line">&#125;);</span><br><span class="line">&#125;).<span class="title function_">then</span>(<span class="literal">undefined</span>, <span class="function">(<span class="params">age</span>) =&gt;</span> &#123;</span><br><span class="line">   <span class="variable language_">console</span>.<span class="title function_">log</span>(age)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>我们只要在最后一个then的函数中进行捕获错误，就不需要考虑前面是否有捕获错误，但是这个写法还是很乏锁因此我们再一次简化，就有了catch方法</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> p = <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span>&#123;</span><br><span class="line">  <span class="title function_">resolve</span>(<span class="string">&#x27;zgl&#x27;</span>);</span><br><span class="line">&#125;);</span><br><span class="line">p.<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span>&#123;</span><br><span class="line">  <span class="title function_">reject</span>(<span class="number">27</span>);</span><br><span class="line">&#125;);</span><br><span class="line">&#125;).<span class="title function_">catch</span>(<span class="function">(<span class="params">age</span>) =&gt;</span> &#123;</span><br><span class="line">   <span class="variable language_">console</span>.<span class="title function_">log</span>(age)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h4 id="有then捕获异常后不会传递到catch中"><a href="#有then捕获异常后不会传递到catch中" class="headerlink" title="有then捕获异常后不会传递到catch中"></a>有then捕获异常后不会传递到catch中</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> p = <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span>&#123;</span><br><span class="line">  <span class="title function_">reject</span>(<span class="string">&#x27;zgl&#x27;</span>);</span><br><span class="line">&#125;);</span><br><span class="line">p.<span class="title function_">then</span>(<span class="literal">undefined</span>, <span class="function">(<span class="params">age</span>) =&gt;</span> &#123;</span><br><span class="line">   <span class="variable language_">console</span>.<span class="title function_">log</span>(age)</span><br><span class="line">&#125;).<span class="title function_">catch</span>(<span class="function">(<span class="params">age</span>) =&gt;</span> &#123;</span><br><span class="line">   <span class="variable language_">console</span>.<span class="title function_">log</span>(age, <span class="string">&#x27;age&#x27;</span>) <span class="comment">// 不会执行</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>因此建议在实际使用过程中因在最后一个then进行追加catch这样就不需要在then中写每一个异常处理的逻辑，因此，建议总是使用catch()方法，而不使用then()方法的第二个参数。</p>
<h2 id="promise对象的实现原理"><a href="#promise对象的实现原理" class="headerlink" title="promise对象的实现原理"></a>promise对象的实现原理</h2><h3 id="promise是构造函数-1"><a href="#promise是构造函数-1" class="headerlink" title="promise是构造函数"></a>promise是构造函数</h3><p>由于浏览器实现的promie是一个函数，因此我们也需要遵循promise是一个构造函数</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MyPromise</span> &#123;</span><br><span class="line">  <span class="title function_">constrouctor</span>(<span class="params"></span>)&#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="promise对象接受一个函数"><a href="#promise对象接受一个函数" class="headerlink" title="promise对象接受一个函数"></a>promise对象接受一个函数</h3><p>通过在promise的基本用法中分析，promise构造函数必须接受一个函数</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">isFunction</span>(<span class="params">val</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">typeof</span> val === <span class="string">&#x27;function&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyPromise</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">executor</span>)&#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="title function_">isFunction</span>(executor)) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TypeError</span>(<span class="string">`MyPromise resolver <span class="subst">$&#123;<span class="keyword">typeof</span> executor&#125;</span> is not a function</span></span><br><span class="line"><span class="string">    at new MyPromise`</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="执行器函数接受2个参数"><a href="#执行器函数接受2个参数" class="headerlink" title="执行器函数接受2个参数"></a>执行器函数接受2个参数</h3><p>executor函数必须接受2个参数，第一个参数resolve必须是一个函数，第二个参数是选传</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">isFunction</span>(<span class="params">val</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">typeof</span> val === <span class="string">&#x27;function&#x27;</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyPromise</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">executor</span>)&#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="title function_">isFunction</span>(executor)) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TypeError</span>(<span class="string">`MyPromise resolver <span class="subst">$&#123;<span class="keyword">typeof</span> executor&#125;</span> is not a function</span></span><br><span class="line"><span class="string">    at new MyPromise`</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">executor</span>(<span class="variable language_">this</span>.<span class="property">resolve</span>, <span class="variable language_">this</span>.<span class="property">reject</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">resolve</span>(<span class="params"></span>) &#123;&#125;;</span><br><span class="line">  <span class="title function_">reject</span>(<span class="params"></span>)&#123;&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="resolve绑定的this为promise对象"><a href="#resolve绑定的this为promise对象" class="headerlink" title="resolve绑定的this为promise对象"></a>resolve绑定的this为promise对象</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> p = <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="keyword">function</span> (<span class="params">resolve</span>) &#123;</span><br><span class="line">  <span class="title function_">resolve</span>()</span><br><span class="line">&#125;)</span><br><span class="line">  </span><br><span class="line">  </span><br></pre></td></tr></table></figure>

<p>上述代码按照正常逻辑来讲的话，resolve的this指向了window，但是我们在执行的时候并没有报错说明了this并不是指向window而是指向了promise实例</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">function isFunction(val) &#123;</span><br><span class="line">  return typeof val === &#x27;function&#x27;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">class MyPromise &#123;</span><br><span class="line">  constructor(executor)&#123;</span><br><span class="line">    if (!isFunction(executor)) &#123;</span><br><span class="line">      throw new TypeError(`MyPromise resolver $&#123;typeof executor&#125; is not a function</span><br><span class="line">    at new MyPromise`);</span><br><span class="line">    this.resolve = this.resolve.bind(this);</span><br><span class="line">    this.reject = this.reject.bind(this);</span><br><span class="line">    executor(this.resolve, this.reject);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  resolve() &#123;&#125;;</span><br><span class="line">  reject()&#123;&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="resolve函数将状态由pending-fulfilled"><a href="#resolve函数将状态由pending-fulfilled" class="headerlink" title="resolve函数将状态由pending -&gt; fulfilled"></a>resolve函数将状态由pending -&gt; fulfilled</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">isFunction</span>(<span class="params">val</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">typeof</span> val === <span class="string">&#x27;function&#x27;</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">PENDING</span> = <span class="string">&#x27;pending&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">FULFILLED</span> = <span class="string">&#x27;fulfilled&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">REJECTED</span> = <span class="string">&#x27;rejected&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyPromise</span> &#123;</span><br><span class="line">  status;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">executor</span>)&#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="title function_">isFunction</span>(executor)) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TypeError</span>(<span class="string">`MyPromise resolver <span class="subst">$&#123;<span class="keyword">typeof</span> executor&#125;</span> is not a function</span></span><br><span class="line"><span class="string">    at new MyPromise`</span>);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">resolve</span> = <span class="variable language_">this</span>.<span class="property">resolve</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">reject</span> = <span class="variable language_">this</span>.<span class="property">reject</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">status</span> === <span class="variable constant_">PENDING</span></span><br><span class="line">    <span class="title function_">executor</span>(<span class="variable language_">this</span>.<span class="property">resolve</span>, <span class="variable language_">this</span>.<span class="property">reject</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">resolve</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">status</span> === <span class="variable constant_">PENDING</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">status</span> = <span class="variable constant_">FULFILLED</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">reject</span>(<span class="params"></span>)&#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="resolve函数将状态由pending-rejected"><a href="#resolve函数将状态由pending-rejected" class="headerlink" title="resolve函数将状态由pending -&gt; rejected"></a>resolve函数将状态由pending -&gt; rejected</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">isFunction</span>(<span class="params">val</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">typeof</span> val === <span class="string">&#x27;function&#x27;</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">PENDING</span> = <span class="string">&#x27;pending&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">FULFILLED</span> = <span class="string">&#x27;fulfilled&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">REJECTED</span> = <span class="string">&#x27;rejected&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyPromise</span> </span><br><span class="line">  status;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">executor</span>)&#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="title function_">isFunction</span>(executor)) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TypeError</span>(<span class="string">`MyPromise resolver <span class="subst">$&#123;<span class="keyword">typeof</span> executor&#125;</span> is not a function</span></span><br><span class="line"><span class="string">    at new MyPromise`</span>);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">resolve</span> = <span class="variable language_">this</span>.<span class="property">resolve</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">reject</span> = <span class="variable language_">this</span>.<span class="property">reject</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">status</span> === <span class="variable constant_">PENDING</span></span><br><span class="line">    <span class="title function_">executor</span>(<span class="variable language_">this</span>.<span class="property">resolve</span>, <span class="variable language_">this</span>.<span class="property">reject</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">resolve</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">status</span> === <span class="variable constant_">PENDING</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">status</span> = <span class="variable constant_">FULFILLED</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">    </span><br><span class="line">  <span class="title function_">reject</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">status</span> === <span class="variable constant_">PENDING</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">status</span> = <span class="variable constant_">REJECTED</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="resolve函数支持传参"><a href="#resolve函数支持传参" class="headerlink" title="resolve函数支持传参"></a>resolve函数支持传参</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">isFunction</span>(<span class="params">val</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">typeof</span> val === <span class="string">&#x27;function&#x27;</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">PENDING</span> = <span class="string">&#x27;pending&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">FULFILLED</span> = <span class="string">&#x27;fulfilled&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">REJECTED</span> = <span class="string">&#x27;rejected&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyPromise</span> &#123;</span><br><span class="line">  status;</span><br><span class="line">  result;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">executor</span>)&#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="title function_">isFunction</span>(executor)) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TypeError</span>(<span class="string">`MyPromise resolver <span class="subst">$&#123;<span class="keyword">typeof</span> executor&#125;</span> is not a function</span></span><br><span class="line"><span class="string">    at new MyPromise`</span>);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">resolve</span> = <span class="variable language_">this</span>.<span class="property">resolve</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">reject</span> = <span class="variable language_">this</span>.<span class="property">reject</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">status</span> === <span class="variable constant_">PENDING</span></span><br><span class="line">    <span class="title function_">executor</span>(<span class="variable language_">this</span>.<span class="property">resolve</span>, <span class="variable language_">this</span>.<span class="property">reject</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">resolve</span>(<span class="params">result</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">status</span> === <span class="variable constant_">PENDING</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">status</span> = <span class="variable constant_">FULFILLED</span>;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">result</span> = result</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">    </span><br><span class="line">  <span class="title function_">reject</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">status</span> === <span class="variable constant_">PENDING</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">status</span> = rejected;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="reject函数支持传参"><a href="#reject函数支持传参" class="headerlink" title="reject函数支持传参"></a>reject函数支持传参</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">isFunction</span>(<span class="params">val</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">typeof</span> val === <span class="string">&#x27;function&#x27;</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">PENDING</span> = <span class="string">&#x27;pending&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">FULFILLED</span> = <span class="string">&#x27;fulfilled&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">REJECTED</span> = <span class="string">&#x27;rejected&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyPromise</span> </span><br><span class="line">  status;</span><br><span class="line">  result;</span><br><span class="line">  error;</span><br><span class="line"><span class="title function_">constrouctor</span>(<span class="params">executor</span>)&#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="title function_">isFunction</span>(executor)) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TypeError</span>(<span class="string">`MyPromise resolver <span class="subst">$&#123;<span class="keyword">typeof</span> executor&#125;</span> is not a function</span></span><br><span class="line"><span class="string">    at new MyPromise`</span>);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">resolve</span> = <span class="variable language_">this</span>.<span class="property">resolve</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">reject</span> = <span class="variable language_">this</span>.<span class="property">reject</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">status</span> === <span class="variable constant_">PENDING</span></span><br><span class="line">    <span class="title function_">executor</span>(<span class="variable language_">this</span>.<span class="property">resolve</span>, <span class="variable language_">this</span>.<span class="property">reject</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">resolve</span>(<span class="params">result</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">status</span> === <span class="variable constant_">PENDING</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">status</span> = <span class="variable constant_">FULFILLED</span>;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">result</span> = result</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">reject</span>(<span class="params">error</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">status</span> === <span class="variable constant_">PENDING</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">status</span> = <span class="variable constant_">REJECTED</span>;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">error</span> = error;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure>

<h3 id="reject会捕获resolve的错误"><a href="#reject会捕获resolve的错误" class="headerlink" title="reject会捕获resolve的错误"></a>reject会捕获resolve的错误</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">isFunction</span>(<span class="params">val</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">typeof</span> val === <span class="string">&#x27;function&#x27;</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">PENDING</span> = <span class="string">&#x27;pending&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">FULFILLED</span> = <span class="string">&#x27;fulfilled&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">REJECTED</span> = <span class="string">&#x27;rejected&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyPromise</span> &#123;</span><br><span class="line">  status;</span><br><span class="line">  result;</span><br><span class="line">  error;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">executor</span>)&#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="title function_">isFunction</span>(executor)) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TypeError</span>(<span class="string">`MyPromise resolver <span class="subst">$&#123;<span class="keyword">typeof</span> executor&#125;</span> is not a function</span></span><br><span class="line"><span class="string">    at new MyPromise`</span>);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">resolve</span> = <span class="variable language_">this</span>.<span class="property">resolve</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">reject</span> = <span class="variable language_">this</span>.<span class="property">reject</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">status</span> === <span class="variable constant_">PENDING</span></span><br><span class="line">    <span class="title function_">executor</span>(<span class="variable language_">this</span>.<span class="property">resolve</span>, <span class="variable language_">this</span>.<span class="property">reject</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">resolve</span>(<span class="params">result</span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">status</span> === <span class="variable constant_">PENDING</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">status</span> = <span class="variable constant_">FULFILLED</span>;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">result</span> = result</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;<span class="keyword">catch</span>(e) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">reject</span>(e);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">reject</span>(<span class="params">error</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">status</span> === <span class="variable constant_">PENDING</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">status</span> = <span class="variable constant_">REJECTED</span>;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">error</span> = error;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure>

<h3 id="then方法-1"><a href="#then方法-1" class="headerlink" title="then方法"></a>then方法</h3><h4 id="then参数的第一个值为resolved的值"><a href="#then参数的第一个值为resolved的值" class="headerlink" title="then参数的第一个值为resolved的值"></a>then参数的第一个值为resolved的值</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">isFunction</span>(<span class="params">val</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">typeof</span> val === <span class="string">&#x27;function&#x27;</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">PENDING</span> = <span class="string">&#x27;pending&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">FULFILLED</span> = <span class="string">&#x27;fulfilled&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">REJECTED</span> = <span class="string">&#x27;rejected&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyPromise</span> &#123;</span><br><span class="line"> status;</span><br><span class="line"> result;</span><br><span class="line"> error;</span><br><span class="line"> <span class="title function_">constructor</span>(<span class="params">executor</span>)&#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="title function_">isFunction</span>(executor)) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TypeError</span>(<span class="string">`MyPromise resolver <span class="subst">$&#123;<span class="keyword">typeof</span> executor&#125;</span> is not a function</span></span><br><span class="line"><span class="string">    at new MyPromise`</span>);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">resolve</span> = <span class="variable language_">this</span>.<span class="property">resolve</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">reject</span> = <span class="variable language_">this</span>.<span class="property">reject</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">status</span> === <span class="variable constant_">PENDING</span></span><br><span class="line">    <span class="title function_">executor</span>(<span class="variable language_">this</span>.<span class="property">resolve</span>, <span class="variable language_">this</span>.<span class="property">reject</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">resolve</span>(<span class="params">result</span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">status</span> === <span class="variable constant_">PENDING</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">status</span> = <span class="variable constant_">FULFILLED</span>;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">result</span> = result</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;<span class="keyword">catch</span>(e) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">reject</span>(e);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="title function_">reject</span>(<span class="params">error</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">status</span> === <span class="variable constant_">PENDING</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">status</span> = <span class="variable constant_">REJECTED</span>;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">error</span> = error;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">then</span>(<span class="function">(<span class="params">resolved</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="title function_">resolved</span>(<span class="variable language_">this</span>.<span class="property">result</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure>

<h4 id="then参数的第二个值为resolved的值"><a href="#then参数的第二个值为resolved的值" class="headerlink" title="then参数的第二个值为resolved的值"></a>then参数的第二个值为resolved的值</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">isFunction</span>(<span class="params">val</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">typeof</span> val === <span class="string">&#x27;function&#x27;</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">PENDING</span> = <span class="string">&#x27;pending&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">FULFILLED</span> = <span class="string">&#x27;fulfilled&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">REJECTED</span> = <span class="string">&#x27;rejected&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyPromise</span> &#123;</span><br><span class="line">  status;</span><br><span class="line">  result;</span><br><span class="line">  error;</span><br><span class="line"><span class="title function_">constructor</span>(<span class="params">executor</span>)&#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="title function_">isFunction</span>(executor)) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TypeError</span>(<span class="string">`MyPromise resolver <span class="subst">$&#123;<span class="keyword">typeof</span> executor&#125;</span> is not a function</span></span><br><span class="line"><span class="string">    at new MyPromise`</span>);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">resolve</span> = <span class="variable language_">this</span>.<span class="property">resolve</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">reject</span> = <span class="variable language_">this</span>.<span class="property">reject</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">status</span> === <span class="variable constant_">PENDING</span></span><br><span class="line">    <span class="title function_">executor</span>(<span class="variable language_">this</span>.<span class="property">resolve</span>, <span class="variable language_">this</span>.<span class="property">reject</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">resolve</span>(<span class="params">result</span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">status</span> === <span class="variable constant_">PENDING</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">status</span> = <span class="variable constant_">FULFILLED</span>;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">result</span> = result</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;<span class="keyword">catch</span>(e) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">reject</span>(e);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="title function_">reject</span>(<span class="params">error</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">status</span> === <span class="variable constant_">PENDING</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">status</span> = <span class="variable constant_">REJECTED</span>;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">error</span> = error;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">then</span>(<span class="function">(<span class="params">resolved,reject</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="title function_">resolved</span>(<span class="variable language_">this</span>.<span class="property">result</span>)</span><br><span class="line">      &#125;<span class="keyword">catch</span>(e) &#123;</span><br><span class="line">        <span class="title function_">reject</span>(<span class="variable language_">this</span>.<span class="property">error</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure>

<h4 id="then方法是异步的"><a href="#then方法是异步的" class="headerlink" title="then方法是异步的"></a>then方法是异步的</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">isFunction</span>(<span class="params">val</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">typeof</span> val === <span class="string">&#x27;function&#x27;</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">PENDING</span> = <span class="string">&#x27;pending&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">FULFILLED</span> = <span class="string">&#x27;fulfilled&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">REJECTED</span> = <span class="string">&#x27;rejected&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyPromise</span> &#123;</span><br><span class="line">  status;</span><br><span class="line">  result;</span><br><span class="line">  error;</span><br><span class="line"><span class="title function_">constrouctor</span>(<span class="params">executor</span>)&#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="title function_">isFunction</span>(executor)) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TypeError</span>(<span class="string">`MyPromise resolver <span class="subst">$&#123;<span class="keyword">typeof</span> executor&#125;</span> is not a function</span></span><br><span class="line"><span class="string">    at new MyPromise`</span>);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">resolve</span> = <span class="variable language_">this</span>.<span class="property">resolve</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">reject</span> = <span class="variable language_">this</span>.<span class="property">reject</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">status</span> === <span class="variable constant_">PENDING</span></span><br><span class="line">    <span class="title function_">executor</span>(<span class="variable language_">this</span>.<span class="property">resolve</span>, <span class="variable language_">this</span>.<span class="property">reject</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">resolve</span>(<span class="params">result</span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">status</span> === <span class="variable constant_">PENDING</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">status</span> = <span class="variable constant_">FULFILLED</span>;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">result</span> = result;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;<span class="keyword">catch</span>(e) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">reject</span>(e);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="title function_">reject</span>(<span class="params">error</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">status</span> === <span class="variable constant_">PENDING</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">status</span> = <span class="variable constant_">REJECTED</span>;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">error</span> = error;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">then</span>(<span class="function">(<span class="params">resolved,reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="title function_">queueMicrotask</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="title function_">resolved</span>(<span class="variable language_">this</span>.<span class="property">result</span>)</span><br><span class="line">      &#125;<span class="keyword">catch</span>(e) &#123;</span><br><span class="line">        <span class="title function_">reject</span>(<span class="variable language_">this</span>.#error)</span><br><span class="line">      &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure>

<h4 id="then方法能够进行多次监听"><a href="#then方法能够进行多次监听" class="headerlink" title="then方法能够进行多次监听"></a>then方法能够进行多次监听</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">isFunction</span>(<span class="params">val</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">typeof</span> val === <span class="string">&#x27;function&#x27;</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">PENDING</span> = <span class="string">&#x27;pending&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">FULFILLED</span> = <span class="string">&#x27;fulfilled&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">REJECTED</span> = <span class="string">&#x27;rejected&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyPromise</span> &#123;</span><br><span class="line"> status;</span><br><span class="line"> result;</span><br><span class="line"> error;</span><br><span class="line"> resolevedQueue = [];</span><br><span class="line"> rejectedQueue = [];</span><br><span class="line">  </span><br><span class="line"><span class="title function_">constrouctor</span>(<span class="params">executor</span>)&#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="title function_">isFunction</span>(executor)) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TypeError</span>(<span class="string">`MyPromise resolver <span class="subst">$&#123;<span class="keyword">typeof</span> executor&#125;</span> is not a function</span></span><br><span class="line"><span class="string">    at new MyPromise`</span>);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">resolve</span> = <span class="variable language_">this</span>.<span class="property">resolve</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">reject</span> = <span class="variable language_">this</span>.<span class="property">reject</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">status</span> === <span class="variable constant_">PENDING</span></span><br><span class="line">    <span class="title function_">executor</span>(<span class="variable language_">this</span>.<span class="property">resolve</span>, <span class="variable language_">this</span>.<span class="property">reject</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">resolve</span>(<span class="params">result</span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">status</span> === <span class="variable constant_">PENDING</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">status</span> = <span class="variable constant_">FULFILLED</span>;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">result</span> = result;</span><br><span class="line">      <span class="keyword">while</span>(resolveQueue.<span class="property">length</span>) &#123;</span><br><span class="line">          <span class="keyword">const</span> resolved = <span class="variable language_">this</span>.<span class="property">resolveQueue</span>.<span class="title function_">shift</span>();</span><br><span class="line">          <span class="title function_">resolved</span>(result)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;<span class="keyword">catch</span>(e) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">reject</span>(e);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="title function_">reject</span>(<span class="params">error</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">status</span> === <span class="variable constant_">PENDING</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">status</span> = <span class="variable constant_">REJECTED</span>;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">error</span> = error;</span><br><span class="line">        <span class="keyword">while</span>(rejectedQueue.<span class="property">length</span>) &#123;</span><br><span class="line">          <span class="keyword">const</span> rejected = <span class="variable language_">this</span>.<span class="property">rejectQueue</span>.<span class="title function_">shift</span>();</span><br><span class="line">          <span class="title function_">rejected</span>(error)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">then</span>(<span class="function">(<span class="params">resolved,reject</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">resolvedQueue</span>.<span class="title function_">push</span>(resolved);</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">rejectedQueue</span>.<span class="title function_">push</span>(reject);</span><br><span class="line">    &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure>

<h4 id="只有状态为pending时才会进行注册"><a href="#只有状态为pending时才会进行注册" class="headerlink" title="只有状态为pending时才会进行注册"></a>只有状态为pending时才会进行注册</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">isFunction</span>(<span class="params">val</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">typeof</span> val === <span class="string">&#x27;function&#x27;</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">PENDING</span> = <span class="string">&#x27;pending&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">FULFILLED</span> = <span class="string">&#x27;fulfilled&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">REJECTED</span> = <span class="string">&#x27;rejected&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyPromise</span> &#123;</span><br><span class="line"> status;</span><br><span class="line"> resolevedQueue = [];</span><br><span class="line"> rejectedQueue = [];</span><br><span class="line">  </span><br><span class="line"><span class="title function_">constrouctor</span>(<span class="params">executor</span>)&#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="title function_">isFunction</span>(executor)) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TypeError</span>(<span class="string">`MyPromise resolver <span class="subst">$&#123;<span class="keyword">typeof</span> executor&#125;</span> is not a function</span></span><br><span class="line"><span class="string">    at new MyPromise`</span>);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">resolve</span> = <span class="variable language_">this</span>.<span class="property">resolve</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">reject</span> = <span class="variable language_">this</span>.<span class="property">reject</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">status</span> === <span class="variable constant_">PENDING</span></span><br><span class="line">    <span class="title function_">executor</span>(<span class="variable language_">this</span>.<span class="property">resolve</span>, <span class="variable language_">this</span>.<span class="property">reject</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">resolve</span>(<span class="params">result</span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">status</span> === <span class="variable constant_">PENDING</span>) &#123;</span><br><span class="line">        <span class="keyword">while</span>(resolveQueue.<span class="property">length</span>) &#123;</span><br><span class="line">          <span class="keyword">const</span> resolved = <span class="variable language_">this</span>.<span class="property">resolveQueue</span>.<span class="title function_">shift</span>();</span><br><span class="line">          <span class="title function_">resolved</span>(result)</span><br><span class="line">        &#125;</span><br><span class="line">         <span class="variable language_">this</span>.<span class="property">status</span> = <span class="variable constant_">FULFILLED</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;<span class="keyword">catch</span>(e) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">reject</span>(e);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="title function_">reject</span>(<span class="params">error</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">status</span> === <span class="variable constant_">PENDING</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">status</span> = <span class="variable constant_">REJECTED</span>;</span><br><span class="line">        <span class="keyword">while</span>(rejectedQueue.<span class="property">length</span>) &#123;</span><br><span class="line">          <span class="keyword">const</span> rejected = <span class="variable language_">this</span>.<span class="property">rejectedQueue</span>.<span class="title function_">shift</span>();</span><br><span class="line">          <span class="title function_">rejected</span>(error);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">then</span>(<span class="function">(<span class="params">resolved,reject</span>) =&gt;</span> &#123;</span><br><span class="line">     <span class="keyword">switch</span>(<span class="variable language_">this</span>.<span class="property">status</span>) &#123;</span><br><span class="line">       <span class="keyword">case</span> <span class="attr">PENDING</span>: </span><br><span class="line">         <span class="variable language_">this</span>.<span class="property">resolvedQueue</span>.<span class="title function_">push</span>(resolved);</span><br><span class="line">         <span class="variable language_">this</span>.<span class="property">rejectedQueue</span>.<span class="title function_">push</span>(reject);</span><br><span class="line">         <span class="keyword">break</span>;</span><br><span class="line">       <span class="keyword">case</span> <span class="attr">FULFILLED</span>: <span class="title function_">resolved</span>(<span class="variable language_">this</span>.<span class="property">result</span>);</span><br><span class="line">         <span class="keyword">break</span>;</span><br><span class="line">       <span class="keyword">case</span> <span class="attr">REJECTED</span>: <span class="title function_">reject</span>(<span class="variable language_">this</span>.<span class="property">error</span>);</span><br><span class="line">         <span class="keyword">break</span>;</span><br><span class="line">       <span class="attr">default</span>: <span class="keyword">throw</span> <span class="keyword">new</span> </span><br><span class="line">     &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure>

<h4 id="then返回一个新的promise"><a href="#then返回一个新的promise" class="headerlink" title="then返回一个新的promise"></a>then返回一个新的promise</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">isFunction</span>(<span class="params">val</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">typeof</span> val === <span class="string">&#x27;function&#x27;</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">PENDING</span> = <span class="string">&#x27;pending&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">FULFILLED</span> = <span class="string">&#x27;fulfilled&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">REJECTED</span> = <span class="string">&#x27;rejected&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyPromise</span> &#123;</span><br><span class="line"> status;</span><br><span class="line"> resolevedQueue = [];</span><br><span class="line"> rejectedQueue = [];</span><br><span class="line">  </span><br><span class="line"><span class="title function_">constrouctor</span>(<span class="params">executor</span>)&#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="title function_">isFunction</span>(executor)) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TypeError</span>(<span class="string">`MyPromise resolver <span class="subst">$&#123;<span class="keyword">typeof</span> executor&#125;</span> is not a function</span></span><br><span class="line"><span class="string">    at new MyPromise`</span>);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">resolve</span> = <span class="variable language_">this</span>.<span class="property">resolve</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">reject</span> = <span class="variable language_">this</span>.<span class="property">reject</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">status</span> === <span class="variable constant_">PENDING</span></span><br><span class="line">    <span class="title function_">executor</span>(<span class="variable language_">this</span>.<span class="property">resolve</span>, <span class="variable language_">this</span>.<span class="property">reject</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">resolve</span>(<span class="params">result</span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">status</span> === <span class="variable constant_">PENDING</span>) &#123;</span><br><span class="line">        <span class="keyword">while</span>(resolveQueue.<span class="property">length</span>) &#123;</span><br><span class="line">          <span class="keyword">const</span> resolved = <span class="variable language_">this</span>.<span class="property">resolveQueue</span>.<span class="title function_">shift</span>();</span><br><span class="line">          <span class="title function_">resolved</span>(result)</span><br><span class="line">        &#125;</span><br><span class="line">         <span class="variable language_">this</span>.<span class="property">status</span> = <span class="variable constant_">FULFILLED</span>;</span><br><span class="line">      </span><br><span class="line">      &#125;</span><br><span class="line">    &#125;<span class="keyword">catch</span>(e) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">reject</span>(e);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="title function_">reject</span>(<span class="params">error</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">status</span> === <span class="variable constant_">PENDING</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">status</span> = <span class="variable constant_">REJECTED</span>;</span><br><span class="line">        <span class="keyword">while</span>(rejectedQueue.<span class="property">length</span>) &#123;</span><br><span class="line">          <span class="keyword">const</span> rejected = <span class="variable language_">this</span>.<span class="property">rejectedQueue</span>.<span class="title function_">shift</span>();</span><br><span class="line">          <span class="title function_">rejected</span>(error);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">then</span>(<span class="function">(<span class="params">resolved,reject</span>) =&gt;</span> &#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">MyPromise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">         <span class="keyword">switch</span>(<span class="variable language_">this</span>.<span class="property">status</span>) &#123;</span><br><span class="line">           <span class="keyword">case</span> <span class="attr">PENDING</span>: </span><br><span class="line">             <span class="variable language_">this</span>.<span class="property">resolvedQueue</span>.<span class="title function_">push</span>(resolved);</span><br><span class="line">             <span class="variable language_">this</span>.<span class="property">rejectedQueue</span>.<span class="title function_">push</span>(reject);</span><br><span class="line">             <span class="keyword">break</span>;</span><br><span class="line">           <span class="keyword">case</span> <span class="attr">FULFILLED</span>: <span class="title function_">resolve</span>(<span class="variable language_">this</span>.<span class="property">result</span>);</span><br><span class="line">             <span class="keyword">break</span>;</span><br><span class="line">           <span class="keyword">case</span> <span class="attr">REJECTED</span>: <span class="title function_">reject</span>(<span class="variable language_">this</span>.<span class="property">error</span>);</span><br><span class="line">             <span class="keyword">break</span>;</span><br><span class="line">           <span class="attr">default</span>: <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;状态没有改变&#x27;</span>);</span><br><span class="line">         &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure>

<h4 id="then的第一个参数的执行结果会传入返回的promise中"><a href="#then的第一个参数的执行结果会传入返回的promise中" class="headerlink" title="then的第一个参数的执行结果会传入返回的promise中"></a>then的第一个参数的执行结果会传入返回的promise中</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">isFunction</span>(<span class="params">val</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">typeof</span> val === <span class="string">&#x27;function&#x27;</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">PENDING</span> = <span class="string">&#x27;pending&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">FULFILLED</span> = <span class="string">&#x27;fulfilled&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">REJECTED</span> = <span class="string">&#x27;rejected&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyPromise</span> &#123;</span><br><span class="line"> status;</span><br><span class="line"> resolevedQueue = [];</span><br><span class="line"> rejectedQueue = [];</span><br><span class="line">  </span><br><span class="line"><span class="title function_">constrouctor</span>(<span class="params">executor</span>)&#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="title function_">isFunction</span>(executor)) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TypeError</span>(<span class="string">`MyPromise resolver <span class="subst">$&#123;<span class="keyword">typeof</span> executor&#125;</span> is not a function</span></span><br><span class="line"><span class="string">    at new MyPromise`</span>);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">resolve</span> = <span class="variable language_">this</span>.<span class="property">resolve</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">reject</span> = <span class="variable language_">this</span>.<span class="property">reject</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">status</span> === <span class="variable constant_">PENDING</span></span><br><span class="line">    <span class="title function_">executor</span>(<span class="variable language_">this</span>.<span class="property">resolve</span>, <span class="variable language_">this</span>.<span class="property">reject</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">resolve</span>(<span class="params">result</span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">status</span> === <span class="variable constant_">PENDING</span>) &#123;</span><br><span class="line">      </span><br><span class="line">        <span class="keyword">while</span>(resolveQueue.<span class="property">length</span>) &#123;</span><br><span class="line">          <span class="keyword">const</span> resolved = <span class="variable language_">this</span>.<span class="property">resolveQueue</span>.<span class="title function_">shift</span>();</span><br><span class="line">          <span class="title function_">resolved</span>(result)</span><br><span class="line">        &#125;</span><br><span class="line">         <span class="variable language_">this</span>.<span class="property">status</span> = <span class="variable constant_">FULFILLED</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;<span class="keyword">catch</span>(e) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">reject</span>(e);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="title function_">reject</span>(<span class="params">error</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">status</span> === <span class="variable constant_">PENDING</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">status</span> = <span class="variable constant_">REJECTED</span>;</span><br><span class="line">        <span class="keyword">while</span>(rejectedQueue.<span class="property">length</span>) &#123;</span><br><span class="line">          <span class="keyword">const</span> rejected = <span class="variable language_">this</span>.<span class="property">rejectedQueue</span>.<span class="title function_">shift</span>();</span><br><span class="line">          <span class="title function_">rejected</span>(error);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">then</span>(<span class="function">(<span class="params">resolved,rejected</span>) =&gt;</span> &#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">MyPromise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">           <span class="keyword">switch</span>(<span class="variable language_">this</span>.<span class="property">status</span>) &#123;</span><br><span class="line">             <span class="keyword">case</span> <span class="attr">PENDING</span>: </span><br><span class="line">               <span class="variable language_">this</span>.<span class="property">resolvedQueue</span>.<span class="title function_">push</span>(resolved);</span><br><span class="line">               <span class="variable language_">this</span>.<span class="property">rejectedQueue</span>.<span class="title function_">push</span>(reject);</span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line">             <span class="keyword">case</span> <span class="attr">FULFILLED</span>: </span><br><span class="line">               <span class="keyword">const</span> result = <span class="title function_">resolved</span>(<span class="variable language_">this</span>.<span class="property">result</span>);</span><br><span class="line">               <span class="title function_">resolve</span>(result);</span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line">             <span class="keyword">case</span> <span class="attr">REJECTED</span>:</span><br><span class="line">               <span class="title function_">rejected</span>(<span class="variable language_">this</span>.<span class="property">error</span>);</span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line">             <span class="attr">default</span>: <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;状态没有改变&#x27;</span>);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;<span class="keyword">catch</span>(e) &#123;</span><br><span class="line">          <span class="title function_">reject</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure>

<h4 id="promise的第一个参数的执行结果为带有then的对象时会执行then方法"><a href="#promise的第一个参数的执行结果为带有then的对象时会执行then方法" class="headerlink" title="promise的第一个参数的执行结果为带有then的对象时会执行then方法"></a>promise的第一个参数的执行结果为带有then的对象时会执行then方法</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">isFunction</span>(<span class="params">val</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">typeof</span> val === <span class="string">&#x27;function&#x27;</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">isObject</span>(<span class="params">val</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">typeof</span> val === <span class="string">&#x27;object&#x27;</span> &amp;&amp; val !== <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">PENDING</span> = <span class="string">&#x27;pending&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">FULFILLED</span> = <span class="string">&#x27;fulfilled&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">REJECTED</span> = <span class="string">&#x27;rejected&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyPromise</span> &#123;</span><br><span class="line"> status;</span><br><span class="line"> resolevedQueue = [];</span><br><span class="line"> rejectedQueue = [];</span><br><span class="line">  </span><br><span class="line"><span class="title function_">constrouctor</span>(<span class="params">executor</span>)&#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="title function_">isFunction</span>(executor)) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TypeError</span>(<span class="string">`MyPromise resolver <span class="subst">$&#123;<span class="keyword">typeof</span> executor&#125;</span> is not a function</span></span><br><span class="line"><span class="string">    at new MyPromise`</span>);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">resolve</span> = <span class="variable language_">this</span>.<span class="property">resolve</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">reject</span> = <span class="variable language_">this</span>.<span class="property">reject</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>);</span><br><span class="line">    <span class="title function_">executor</span>(<span class="variable language_">this</span>.<span class="property">resolve</span>, <span class="variable language_">this</span>.<span class="property">reject</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">resolve</span>(<span class="params">result</span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">status</span> === <span class="variable constant_">PENDING</span>) &#123;</span><br><span class="line">      </span><br><span class="line">        <span class="keyword">while</span>(resolveQueue.<span class="property">length</span>) &#123;</span><br><span class="line">          <span class="keyword">const</span> resolved = <span class="variable language_">this</span>.<span class="property">resolveQueue</span>.<span class="title function_">shift</span>();</span><br><span class="line">          <span class="title function_">resolved</span>(result)</span><br><span class="line">        &#125;</span><br><span class="line">         <span class="variable language_">this</span>.<span class="property">status</span> = <span class="variable constant_">FULFILLED</span>;</span><br><span class="line">      &#125;);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;<span class="keyword">catch</span>(e) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">reject</span>(e);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="title function_">reject</span>(<span class="params">error</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">status</span> === <span class="variable constant_">PENDING</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">status</span> = <span class="variable constant_">REJECTED</span>;</span><br><span class="line">     </span><br><span class="line">        <span class="keyword">while</span>(rejectedQueue.<span class="property">length</span>) &#123;</span><br><span class="line">          <span class="keyword">const</span> rejected = <span class="variable language_">this</span>.<span class="property">rejectedQueue</span>.<span class="title function_">shift</span>();</span><br><span class="line">          <span class="title function_">rejected</span>(error);</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">then</span>(<span class="function">(<span class="params">resolved,rejected</span>) =&gt;</span> &#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">MyPromise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> <span class="title function_">resolvePromise</span> = (<span class="params">result, resolve, reject</span>)=&gt; &#123;</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="title function_">isFunction</span>(result) || <span class="title function_">isObject</span>(result)) &#123;</span><br><span class="line">              <span class="keyword">if</span> (<span class="title function_">isFunction</span>(result.<span class="property">then</span>)) &#123;</span><br><span class="line">                result.<span class="title function_">then</span>(<span class="function">(<span class="params">result</span>) =&gt;</span> &#123;</span><br><span class="line">                  <span class="comment">// 确保返回的promise已经初始化完成</span></span><br><span class="line">                  <span class="title function_">queueMicrotask</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">                    <span class="title function_">resolvePromise</span>(result, resolve, reject);</span><br><span class="line">                  &#125;)</span><br><span class="line">                &#125;, <span class="function">(<span class="params">error</span>) =&gt;</span> &#123;</span><br><span class="line">                  <span class="title function_">reject</span>(error);</span><br><span class="line">                &#125;)</span><br><span class="line">              &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="title function_">resolve</span>(result);</span><br><span class="line">              &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">              <span class="title function_">resolve</span>(result)</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;<span class="keyword">catch</span>(e) &#123;</span><br><span class="line">            <span class="title function_">reject</span>(e);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">           <span class="keyword">switch</span>(<span class="variable language_">this</span>.<span class="property">status</span>) &#123;</span><br><span class="line">             <span class="keyword">case</span> <span class="attr">PENDING</span>: </span><br><span class="line">               <span class="variable language_">this</span>.<span class="property">resolvedQueue</span>.<span class="title function_">push</span>(resolved);</span><br><span class="line">               <span class="variable language_">this</span>.<span class="property">rejectedQueue</span>.<span class="title function_">push</span>(reject);</span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line">             <span class="keyword">case</span> <span class="attr">FULFILLED</span>: </span><br><span class="line">               <span class="title function_">queueMicrotask</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">                <span class="keyword">const</span> result = <span class="title function_">resolved</span>(<span class="variable language_">this</span>.<span class="property">result</span>);</span><br><span class="line">                <span class="title function_">resolvePromise</span>(result, resolve, reject);</span><br><span class="line">              &#125;)</span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line">             <span class="keyword">case</span> <span class="attr">REJECTED</span>:</span><br><span class="line">               <span class="title function_">rejected</span>(<span class="variable language_">this</span>.#error);</span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line">             <span class="attr">default</span>: <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;状态没有改变&#x27;</span>);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;<span class="keyword">catch</span>(e) &#123;</span><br><span class="line">          <span class="title function_">reject</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure>

<h4 id="then的第一个参数不为函数时会传递结果"><a href="#then的第一个参数不为函数时会传递结果" class="headerlink" title="then的第一个参数不为函数时会传递结果"></a>then的第一个参数不为函数时会传递结果</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">isFunction</span>(<span class="params">val</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">typeof</span> val === <span class="string">&#x27;function&#x27;</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">isObject</span>(<span class="params">val</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">typeof</span> val === <span class="string">&#x27;object&#x27;</span> &amp;&amp; val !== <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">PENDING</span> = <span class="string">&#x27;pending&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">FULFILLED</span> = <span class="string">&#x27;fulfilled&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">REJECTED</span> = <span class="string">&#x27;rejected&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyPromise</span> &#123;</span><br><span class="line">  status;</span><br><span class="line">  resolveQueue;</span><br><span class="line">  rejectQueue;</span><br><span class="line">  </span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">executor</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="title function_">isFunction</span>(executor)) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TypeError</span>(<span class="string">`MyPromise resolver <span class="subst">$&#123;<span class="keyword">typeof</span> executor&#125;</span> is not a function</span></span><br><span class="line"><span class="string">    at new MyPromise`</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">resolve</span> = <span class="variable language_">this</span>.<span class="property">resolve</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>);</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">reject</span> = <span class="variable language_">this</span>.<span class="property">reject</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>);</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">resolveQueue</span> = [];</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">rejectQueue</span> = [];</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">status</span> = <span class="variable constant_">PENDING</span>;</span><br><span class="line">  <span class="title function_">executor</span>(<span class="variable language_">this</span>.<span class="property">resolve</span>, <span class="variable language_">this</span>.<span class="property">reject</span>);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">resolve</span>(<span class="params">result</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">isObject</span>(result) &amp;&amp; <span class="title function_">isFunction</span>(result.<span class="property">then</span>))&#123;</span><br><span class="line">      result.<span class="title function_">then</span>(<span class="variable language_">this</span>.<span class="property">resolve</span>, <span class="variable language_">this</span>.<span class="property">reject</span>);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">status</span> === <span class="variable constant_">PENDING</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">result</span> = result;</span><br><span class="line">        <span class="keyword">while</span>(<span class="variable language_">this</span>.<span class="property">resolveQueue</span>.<span class="property">length</span>) &#123;</span><br><span class="line">          <span class="keyword">const</span> resolved = <span class="variable language_">this</span>.<span class="property">resolveQueue</span>.<span class="title function_">shift</span>();</span><br><span class="line">          <span class="title function_">resolved</span>(result);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">status</span> = <span class="variable constant_">FULFILLED</span>; </span><br><span class="line">      &#125;</span><br><span class="line">    &#125;<span class="keyword">catch</span>(e) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">reject</span>(e);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="title function_">reject</span>(<span class="params">error</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">isObject</span>(error) &amp;&amp; <span class="title function_">isFunction</span>(error.<span class="property">then</span>))&#123;</span><br><span class="line">      error.<span class="title function_">then</span>(<span class="variable language_">this</span>.<span class="property">resolve</span>, <span class="variable language_">this</span>.<span class="property">reject</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">status</span> === <span class="variable constant_">PENDING</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">status</span> = <span class="variable constant_">REJECTED</span>;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">error</span> = error;</span><br><span class="line">      <span class="keyword">while</span>(<span class="variable language_">this</span>.<span class="property">rejectQueue</span>.<span class="property">length</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> rejected = <span class="variable language_">this</span>.<span class="property">rejectQueue</span>.<span class="title function_">shift</span>();</span><br><span class="line">        <span class="title function_">rejected</span>(error);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">then</span>(<span class="params">resolved,rejected</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="title function_">isFunction</span>(resolved)) &#123;</span><br><span class="line">      resolved = <span class="keyword">function</span> <span class="title function_">resolve</span>(<span class="params">result</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="title function_">isFunction</span>(rejected)) &#123;</span><br><span class="line">    rejected = <span class="keyword">function</span> <span class="title function_">reject</span>(<span class="params">error</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span>  error ;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">MyPromise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> called = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">const</span> <span class="title function_">resolvePromise</span> = (<span class="params">result, resolve, reject</span>)=&gt; &#123;</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="title function_">isFunction</span>(result) || <span class="title function_">isObject</span>(result)) &#123;</span><br><span class="line">              <span class="keyword">if</span> (<span class="title function_">isFunction</span>(result.<span class="property">then</span>)) &#123;</span><br><span class="line">                result.<span class="title function_">then</span>(<span class="function">(<span class="params">result</span>) =&gt;</span> &#123;</span><br><span class="line">                  <span class="keyword">if</span> (called) &#123;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                  &#125;; <span class="comment">// 确保只执行一次</span></span><br><span class="line">                  called = <span class="literal">true</span>;</span><br><span class="line">                  <span class="comment">// 确保返回的promise已经初始化完成</span></span><br><span class="line">                  <span class="title function_">queueMicrotask</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">                    <span class="title function_">resolvePromise</span>(result, resolve, reject);</span><br><span class="line">                  &#125;)</span><br><span class="line">                &#125;, <span class="function">(<span class="params">error</span>) =&gt;</span> &#123;</span><br><span class="line">                  <span class="keyword">if</span> (called) &#123;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                  &#125;; <span class="comment">// 确保只执行一次</span></span><br><span class="line">                  called = <span class="literal">true</span>;</span><br><span class="line">                  <span class="title function_">reject</span>(error);</span><br><span class="line">                &#125;)</span><br><span class="line">              &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="title function_">resolve</span>(result);</span><br><span class="line">              &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">              <span class="title function_">resolve</span>(result)</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;<span class="keyword">catch</span>(e) &#123;</span><br><span class="line">            <span class="title function_">reject</span>(e);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        </span><br><span class="line">          <span class="keyword">switch</span>(<span class="variable language_">this</span>.<span class="property">status</span>) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="attr">PENDING</span>: </span><br><span class="line">              <span class="variable language_">this</span>.<span class="property">resolveQueue</span>.<span class="title function_">push</span>(<span class="function">(<span class="params">result</span>) =&gt;</span> &#123;</span><br><span class="line">                  <span class="title function_">queueMicrotask</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">                    <span class="keyword">const</span> res = <span class="title function_">resolved</span>(result);</span><br><span class="line">                    <span class="title function_">resolvePromise</span>(res, resolve, reject);</span><br><span class="line">                  &#125;)</span><br><span class="line">              &#125;);</span><br><span class="line">              <span class="variable language_">this</span>.<span class="property">rejectQueue</span>.<span class="title function_">push</span>(<span class="function">(<span class="params">result</span>) =&gt;</span> &#123;</span><br><span class="line">                  <span class="title function_">queueMicrotask</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">                    <span class="keyword">const</span> res = <span class="title function_">reject</span>(result);</span><br><span class="line">                    <span class="title function_">resolvePromise</span>(res, resolve, reject);</span><br><span class="line">                  &#125;)</span><br><span class="line">              &#125;);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="attr">FULFILLED</span>:</span><br><span class="line">              <span class="title function_">queueMicrotask</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">                <span class="keyword">const</span> result = <span class="title function_">resolved</span>(<span class="variable language_">this</span>.<span class="property">result</span>);</span><br><span class="line">                <span class="title function_">resolvePromise</span>(result, resolve, reject);</span><br><span class="line">              &#125;)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="attr">REJECTED</span>:</span><br><span class="line">              <span class="title function_">rejected</span>(<span class="variable language_">this</span>.<span class="property">error</span>);</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">            <span class="attr">default</span>: <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;状态没有改变&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;<span class="keyword">catch</span>(e) &#123;</span><br><span class="line">        <span class="title function_">rejected</span>(e);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">resolve</span>(<span class="params">value</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (value <span class="keyword">instanceof</span> <span class="title class_">MyPromise</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> value</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">MyPromise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="title function_">resolve</span>(value);</span><br><span class="line">      &#125;<span class="keyword">catch</span>(e) &#123;</span><br><span class="line">        <span class="title function_">reject</span>(e);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="then返回的是一个对象，then方法有且仅会执行一次"><a href="#then返回的是一个对象，then方法有且仅会执行一次" class="headerlink" title="then返回的是一个对象，then方法有且仅会执行一次"></a>then返回的是一个对象，then方法有且仅会执行一次</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">isFunction</span>(<span class="params">val</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">typeof</span> val === <span class="string">&#x27;function&#x27;</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">isObject</span>(<span class="params">val</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">typeof</span> val === <span class="string">&#x27;object&#x27;</span> &amp;&amp; val !== <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">PENDING</span> = <span class="string">&#x27;pending&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">FULFILLED</span> = <span class="string">&#x27;fulfilled&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">REJECTED</span> = <span class="string">&#x27;rejected&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyPromise</span> &#123;</span><br><span class="line">  status;</span><br><span class="line">  resolveQueue;</span><br><span class="line">  rejectQueue;</span><br><span class="line">  </span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">executor</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="title function_">isFunction</span>(executor)) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TypeError</span>(<span class="string">`MyPromise resolver <span class="subst">$&#123;<span class="keyword">typeof</span> executor&#125;</span> is not a function</span></span><br><span class="line"><span class="string">    at new MyPromise`</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">resolve</span> = <span class="variable language_">this</span>.<span class="property">resolve</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>);</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">reject</span> = <span class="variable language_">this</span>.<span class="property">reject</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>);</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">resolveQueue</span> = [];</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">rejectQueue</span> = [];</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">status</span> = <span class="variable constant_">PENDING</span>;</span><br><span class="line">  <span class="title function_">executor</span>(<span class="variable language_">this</span>.<span class="property">resolve</span>, <span class="variable language_">this</span>.<span class="property">reject</span>);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">resolve</span>(<span class="params">result</span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">status</span> === <span class="variable constant_">PENDING</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">result</span> = result;</span><br><span class="line">        <span class="keyword">while</span>(<span class="variable language_">this</span>.<span class="property">resolveQueue</span>.<span class="property">length</span>) &#123;</span><br><span class="line">          <span class="keyword">const</span> resolved = <span class="variable language_">this</span>.<span class="property">resolveQueue</span>.<span class="title function_">shift</span>();</span><br><span class="line">          <span class="title function_">resolved</span>(result);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">status</span> = <span class="variable constant_">FULFILLED</span>; </span><br><span class="line">      &#125;</span><br><span class="line">    &#125;<span class="keyword">catch</span>(e) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">reject</span>(e);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="title function_">reject</span>(<span class="params">error</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">status</span> === <span class="variable constant_">PENDING</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">status</span> = <span class="variable constant_">REJECTED</span>;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">error</span> = error;</span><br><span class="line">      <span class="keyword">while</span>(<span class="variable language_">this</span>.<span class="property">rejectQueue</span>.<span class="property">length</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> rejected = <span class="variable language_">this</span>.<span class="property">rejectQueue</span>.<span class="title function_">shift</span>();</span><br><span class="line">        <span class="title function_">rejected</span>(error);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">then</span>(<span class="params">resolved,rejected</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="title function_">isFunction</span>(resolved)) &#123;</span><br><span class="line">      resolved = <span class="keyword">function</span> <span class="title function_">resolve</span>(<span class="params">result</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="title function_">isFunction</span>(rejected)) &#123;</span><br><span class="line">    rejected = <span class="keyword">function</span> <span class="title function_">reject</span>(<span class="params">error</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span>  error ;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">MyPromise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> called = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">const</span> <span class="title function_">resolvePromise</span> = (<span class="params">result, resolve, reject</span>)=&gt; &#123;</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="title function_">isFunction</span>(result) || <span class="title function_">isObject</span>(result)) &#123;</span><br><span class="line">              <span class="keyword">if</span> (<span class="title function_">isFunction</span>(result.<span class="property">then</span>)) &#123;</span><br><span class="line">                result.<span class="title function_">then</span>(<span class="function">(<span class="params">result</span>) =&gt;</span> &#123;</span><br><span class="line">                  <span class="keyword">if</span> (called) &#123;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                  &#125;; <span class="comment">// 确保只执行一次</span></span><br><span class="line">                  called = <span class="literal">true</span>;</span><br><span class="line">                  <span class="comment">// 确保返回的promise已经初始化完成</span></span><br><span class="line">                  <span class="title function_">queueMicrotask</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">                    <span class="title function_">resolvePromise</span>(result, resolve, reject);</span><br><span class="line">                  &#125;)</span><br><span class="line">                &#125;, <span class="function">(<span class="params">error</span>) =&gt;</span> &#123;</span><br><span class="line">                  <span class="keyword">if</span> (called) &#123;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                  &#125;; <span class="comment">// 确保只执行一次</span></span><br><span class="line">                  called = <span class="literal">true</span>;</span><br><span class="line">                  <span class="title function_">reject</span>(error);</span><br><span class="line">                &#125;)</span><br><span class="line">              &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="title function_">resolve</span>(result);</span><br><span class="line">              &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">              <span class="title function_">resolve</span>(result)</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;<span class="keyword">catch</span>(e) &#123;</span><br><span class="line">            <span class="title function_">reject</span>(e);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        </span><br><span class="line">          <span class="keyword">switch</span>(<span class="variable language_">this</span>.<span class="property">status</span>) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="attr">PENDING</span>: </span><br><span class="line">              <span class="variable language_">this</span>.<span class="property">resolveQueue</span>.<span class="title function_">push</span>(<span class="function">(<span class="params">result</span>) =&gt;</span> &#123;</span><br><span class="line">                  <span class="title function_">queueMicrotask</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">                    <span class="keyword">const</span> res = <span class="title function_">resolved</span>(result);</span><br><span class="line">                    <span class="title function_">resolvePromise</span>(res, resolve, reject);</span><br><span class="line">                  &#125;)</span><br><span class="line">              &#125;);</span><br><span class="line">              <span class="variable language_">this</span>.<span class="property">rejectQueue</span>.<span class="title function_">push</span>(<span class="function">(<span class="params">result</span>) =&gt;</span> &#123;</span><br><span class="line">                  <span class="title function_">queueMicrotask</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">                    <span class="keyword">const</span> res = <span class="title function_">reject</span>(result);</span><br><span class="line">                    <span class="title function_">resolvePromise</span>(res, resolve, reject);</span><br><span class="line">                  &#125;)</span><br><span class="line">              &#125;);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="attr">FULFILLED</span>:</span><br><span class="line">              <span class="title function_">queueMicrotask</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">                <span class="keyword">const</span> result = <span class="title function_">resolved</span>(<span class="variable language_">this</span>.<span class="property">result</span>);</span><br><span class="line">                <span class="title function_">resolvePromise</span>(result, resolve, reject);</span><br><span class="line">              &#125;)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="attr">REJECTED</span>:</span><br><span class="line">              <span class="title function_">rejected</span>(<span class="variable language_">this</span>.<span class="property">error</span>);</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">            <span class="attr">default</span>: <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;状态没有改变&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;<span class="keyword">catch</span>(e) &#123;</span><br><span class="line">        <span class="title function_">rejected</span>(e);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">resolve</span>(<span class="params">value</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (value <span class="keyword">instanceof</span> <span class="title class_">MyPromise</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> value</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">MyPromise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="title function_">resolve</span>(value);</span><br><span class="line">      &#125;<span class="keyword">catch</span>(e) &#123;</span><br><span class="line">        <span class="title function_">reject</span>(e);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="title class_">MyPromise</span>.<span class="title function_">resolve</span>().<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">0</span>); <span class="comment">// 一个微任务</span></span><br><span class="line">  <span class="keyword">return</span> <span class="title class_">MyPromise</span>.<span class="title function_">resolve</span>(<span class="number">4</span>); <span class="comment">// 2个微任务 [微任务0， 微任务1， 微任务01, 微任务11, 微任务111, 微任务12]</span></span><br><span class="line">&#125;).<span class="title function_">then</span>(<span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(res)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="title class_">MyPromise</span>.<span class="title function_">resolve</span>().<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">1</span>); <span class="comment">// 一个微任务</span></span><br><span class="line">&#125;).<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">2</span>); <span class="comment">// 一个微任务</span></span><br><span class="line">&#125;).<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">3</span>); <span class="comment">// 一个微任务</span></span><br><span class="line">&#125;).<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">5</span>); <span class="comment">// 一个微任务</span></span><br><span class="line">&#125;).<span class="title function_">then</span>(<span class="function">() =&gt;</span>&#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">6</span>); <span class="comment">// 一个微任务</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 0 1 2 3 4 5 6</span></span><br><span class="line"><span class="comment">// 0 1 4 2 3 5 6</span></span><br></pre></td></tr></table></figure>

<h4 id="传入resolve的为一个带有then的对象时会执行"><a href="#传入resolve的为一个带有then的对象时会执行" class="headerlink" title="传入resolve的为一个带有then的对象时会执行"></a>传入resolve的为一个带有then的对象时会执行</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">isFunction</span>(<span class="params">val</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">typeof</span> val === <span class="string">&#x27;function&#x27;</span>;</span><br><span class="line">&#125;;</span><br><span class="line">​</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">isObject</span>(<span class="params">val</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">typeof</span> val === <span class="string">&#x27;object&#x27;</span> &amp;&amp; val !== <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line">​</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">PENDING</span> = <span class="string">&#x27;pending&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">FULFILLED</span> = <span class="string">&#x27;fulfilled&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">REJECTED</span> = <span class="string">&#x27;rejected&#x27;</span>;</span><br><span class="line">​</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyPromise</span> &#123;</span><br><span class="line">  status;</span><br><span class="line">  resolveQueue;</span><br><span class="line">  rejectQueue;</span><br><span class="line">  </span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">executor</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="title function_">isFunction</span>(executor)) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TypeError</span>(<span class="string">`MyPromise resolver <span class="subst">$&#123;<span class="keyword">typeof</span> executor&#125;</span> is not a function</span></span><br><span class="line"><span class="string">    at new MyPromise`</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">resolve</span> = <span class="variable language_">this</span>.<span class="property">resolve</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>);</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">reject</span> = <span class="variable language_">this</span>.<span class="property">reject</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>);</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">resolveQueue</span> = [];</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">rejectQueue</span> = [];</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">status</span> = <span class="variable constant_">PENDING</span>;</span><br><span class="line">  <span class="title function_">executor</span>(<span class="variable language_">this</span>.<span class="property">resolve</span>, <span class="variable language_">this</span>.<span class="property">reject</span>);</span><br><span class="line">&#125;;</span><br><span class="line">​</span><br><span class="line">  <span class="title function_">resolve</span>(<span class="params">result</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">isObject</span>(result) &amp;&amp; <span class="title function_">isFunction</span>(result.<span class="property">then</span>))&#123;</span><br><span class="line">      result.<span class="title function_">then</span>(<span class="variable language_">this</span>.<span class="property">resolve</span>, <span class="variable language_">this</span>.<span class="property">reject</span>);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">status</span> === <span class="variable constant_">PENDING</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">result</span> = result;</span><br><span class="line">        <span class="keyword">while</span>(<span class="variable language_">this</span>.<span class="property">resolveQueue</span>.<span class="property">length</span>) &#123;</span><br><span class="line">          <span class="keyword">const</span> resolved = <span class="variable language_">this</span>.<span class="property">resolveQueue</span>.<span class="title function_">shift</span>();</span><br><span class="line">          <span class="title function_">resolved</span>(result);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">status</span> = <span class="variable constant_">FULFILLED</span>; </span><br><span class="line">      &#125;</span><br><span class="line">    &#125;<span class="keyword">catch</span>(e) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">reject</span>(e);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="title function_">reject</span>(<span class="params">error</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">isObject</span>(error) &amp;&amp; <span class="title function_">isFunction</span>(error.<span class="property">then</span>))&#123;</span><br><span class="line">      error.<span class="title function_">then</span>(<span class="variable language_">this</span>.<span class="property">resolve</span>, <span class="variable language_">this</span>.<span class="property">reject</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">status</span> === <span class="variable constant_">PENDING</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">status</span> = <span class="variable constant_">REJECTED</span>;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">error</span> = error;</span><br><span class="line">      <span class="keyword">while</span>(<span class="variable language_">this</span>.<span class="property">rejectQueue</span>.<span class="property">length</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> rejected = <span class="variable language_">this</span>.<span class="property">rejectQueue</span>.<span class="title function_">shift</span>();</span><br><span class="line">        <span class="title function_">rejected</span>(error);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">​</span><br><span class="line">  <span class="title function_">then</span>(<span class="params">resolved,rejected</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="title function_">isFunction</span>(resolved)) &#123;</span><br><span class="line">      resolved = <span class="keyword">function</span> <span class="title function_">resolve</span>(<span class="params">result</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">​</span><br><span class="line">    <span class="keyword">if</span> (!<span class="title function_">isFunction</span>(rejected)) &#123;</span><br><span class="line">    rejected = <span class="keyword">function</span> <span class="title function_">reject</span>(<span class="params">error</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span>  error ;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">MyPromise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> called = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">const</span> <span class="title function_">resolvePromise</span> = (<span class="params">result, resolve, reject</span>)=&gt; &#123;</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="title function_">isFunction</span>(result) || <span class="title function_">isObject</span>(result)) &#123;</span><br><span class="line">              <span class="keyword">if</span> (<span class="title function_">isFunction</span>(result.<span class="property">then</span>)) &#123;</span><br><span class="line">                result.<span class="title function_">then</span>(<span class="function">(<span class="params">result</span>) =&gt;</span> &#123;</span><br><span class="line">                  <span class="keyword">if</span> (called) &#123;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                  &#125;; <span class="comment">// 确保只执行一次</span></span><br><span class="line">                  called = <span class="literal">true</span>;</span><br><span class="line">                  <span class="comment">// 确保返回的promise已经初始化完成</span></span><br><span class="line">                  <span class="title function_">queueMicrotask</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">                    <span class="title function_">resolvePromise</span>(result, resolve, reject);</span><br><span class="line">                  &#125;)</span><br><span class="line">                &#125;, <span class="function">(<span class="params">error</span>) =&gt;</span> &#123;</span><br><span class="line">                  <span class="keyword">if</span> (called) &#123;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                  &#125;; <span class="comment">// 确保只执行一次</span></span><br><span class="line">                  called = <span class="literal">true</span>;</span><br><span class="line">                  <span class="title function_">reject</span>(error);</span><br><span class="line">                &#125;)</span><br><span class="line">              &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="title function_">resolve</span>(result);</span><br><span class="line">              &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">              <span class="title function_">resolve</span>(result)</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;<span class="keyword">catch</span>(e) &#123;</span><br><span class="line">            <span class="title function_">reject</span>(e);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">​</span><br><span class="line">​</span><br><span class="line">        </span><br><span class="line">          <span class="keyword">switch</span>(<span class="variable language_">this</span>.<span class="property">status</span>) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="attr">PENDING</span>: </span><br><span class="line">              <span class="variable language_">this</span>.<span class="property">resolveQueue</span>.<span class="title function_">push</span>(<span class="function">(<span class="params">result</span>) =&gt;</span> &#123;</span><br><span class="line">                  <span class="title function_">queueMicrotask</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">                    <span class="keyword">const</span> res = <span class="title function_">resolved</span>(result);</span><br><span class="line">                    <span class="title function_">resolvePromise</span>(res, resolve, reject);</span><br><span class="line">                  &#125;)</span><br><span class="line">              &#125;);</span><br><span class="line">              <span class="variable language_">this</span>.<span class="property">rejectQueue</span>.<span class="title function_">push</span>(<span class="function">(<span class="params">result</span>) =&gt;</span> &#123;</span><br><span class="line">                  <span class="title function_">queueMicrotask</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">                    <span class="keyword">const</span> res = <span class="title function_">reject</span>(result);</span><br><span class="line">                    <span class="title function_">resolvePromise</span>(res, resolve, reject);</span><br><span class="line">                  &#125;)</span><br><span class="line">              &#125;);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="attr">FULFILLED</span>:</span><br><span class="line">              <span class="title function_">queueMicrotask</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">                <span class="keyword">const</span> result = <span class="title function_">resolved</span>(<span class="variable language_">this</span>.<span class="property">result</span>);</span><br><span class="line">                <span class="title function_">resolvePromise</span>(result, resolve, reject);</span><br><span class="line">              &#125;)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="attr">REJECTED</span>:</span><br><span class="line">              <span class="title function_">rejected</span>(<span class="variable language_">this</span>.<span class="property">error</span>);</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">            <span class="attr">default</span>: <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;状态没有改变&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;<span class="keyword">catch</span>(e) &#123;</span><br><span class="line">        <span class="title function_">rejected</span>(e);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">​</span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">resolve</span>(<span class="params">value</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (value <span class="keyword">instanceof</span> <span class="title class_">MyPromise</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> value</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">MyPromise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="title function_">resolve</span>(value);</span><br><span class="line">      &#125;<span class="keyword">catch</span>(e) &#123;</span><br><span class="line">        <span class="title function_">reject</span>(e);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line">​</span><br><span class="line">​</span><br><span class="line">​</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://imperial-long.github.io/blog/2022/03/01/%E5%9F%BA%E6%9C%AC%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="朱广龙">
      <meta itemprop="description" content="定期会更新前端技术栈 不限于vue，react，node以及部分后端的知识">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="朱广龙的个人博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2022/03/01/%E5%9F%BA%E6%9C%AC%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B/" class="post-title-link" itemprop="url">基本数据类型</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-03-01 20:39:00" itemprop="dateCreated datePublished" datetime="2022-03-01T20:39:00+08:00">2022-03-01</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-10-10 13:13:35" itemprop="dateModified" datetime="2024-10-10T13:13:35+08:00">2024-10-10</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="最近面试，JS-基本数据类型这块被完虐了……"><a href="#最近面试，JS-基本数据类型这块被完虐了……" class="headerlink" title="最近面试，JS 基本数据类型这块被完虐了……"></a>最近面试，JS 基本数据类型这块被完虐了……</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>最近去面试了几个公司，发现自己被面试官在js基本数据类型这块知识完虐，发现自己js基础不扎实<br>包括自己作为面试官去面试别人，发现一个很大的问题，能力是很不错的，但是js基础扎实不够扎实<br>很多人可能认为能力比基础更重要答案是否定的,引用网上比较流行的话</p>
<blockquote>
<p>基础很重要，只有基础好才会很少出<code>bug</code>，大多数的都是<strong>基础不扎实造成的</strong></p>
</blockquote>
<p>这里给出几个问题，要是如果都能回答对并且知道为什么（本文章可以选择忽略）</p>
<ul>
<li><strong>基本数据类型和引用数据类型有什么区别</strong></li>
<li><strong>字符串长度为什么确定了就不能再修改</strong></li>
<li><strong>0b1, 0x1 为什么表示的是数字，不是字符串</strong></li>
<li><strong>为什么基本数据类型是存储在栈中，引用数据类型是存储在堆中的</strong></li>
<li><strong>什么时候使用<code>null</code>，什么时候使用<code>undefined</code></strong></li>
<li><strong>给基本数据类型定义了方法和属性不生效？</strong></li>
<li><strong>假值对象是什么</strong></li>
<li><strong><code>typeof</code>是根据什么原理区分数据类型的</strong></li>
<li><strong>0.1 + 0.2 为什么不等于0.3</strong></li>
<li><strong>对象数据类型什么时候<code>valueOf</code>优先于<code>toString</code></strong></li>
<li><strong>对象类型什么时候<code>toString</code>优先于<code>valueOf</code></strong></li>
<li><strong>obj + 1 如何才能等于2</strong></li>
</ul>
<hr>
<p>在开始之前，在这里强调一下处于某个块中的知识点以及红色字体标记是非常重要的知识点在面试过程中高频出现以及容易出错的地方,在阅读过程一定要自己亲自尝试加深记忆而不是只看不敲代码</p>
<hr>
<h2 id="数据类型"><a href="#数据类型" class="headerlink" title="数据类型"></a>数据类型</h2><p>在js中根据<strong>赋值操作</strong>是赋值的是值还是内存地址，可以分为<strong>基本数据类型</strong>和<strong>对象数据类型</strong>(引用数据类型) </font></p>
<blockquote>
<p>数据类型在数据结构中的定义是<font color='red'>一组性质相同的值的集合以及定义在这个值集合上的一组操作</font>的总称</p>
</blockquote>
<p>基础数据类型和对象数据类型的区别如图所示<br><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/38e906d5254340c4abefa6cd4a955f6b~tplv-k3u1fbpfcp-watermark.image" alt="类型对比图.jpg"></p>
<h3 id="基本类型"><a href="#基本类型" class="headerlink" title="基本类型"></a>基本类型</h3><p>js中基本数据类型主要包括<code>Number</code>，<code>String</code>，<code>Boolean</code>，<code>Undefinde</code>，<code>Null</code>，<code>Symbol</code>, <code>BigInt</code></p>
<h4 id="Number"><a href="#Number" class="headerlink" title="Number"></a>Number</h4><p>该类型包括整数和小数。数字类型用于存储数值，是不可变类型，如果改变数字类型的值，将重新分配内存空间。<br>number用<font>二进制(0b)，八进制(0o)，十进制，十六进制(0x)</font>来表示， 由于受内存限制,最小值为5e-324,最大值为1.7976931348623157e+308,如果超过了最大值会显示为Infinity, 超过了最小值会显示为—Infinity,表示的最大整数为<code>2^53 - 1</code></p>
<blockquote>
<ul>
<li>number类型EE754格式来表示其整数和浮点数值, 浮点数的精度最大为17位，大于17位会发生精度丢失，这也是导致 0.1 + 0.2不严格等于0.3的原因</li>
<li>如果该数大于进制，有些浏览器会将表示进制的前导符忽略默认十进制，但是有些浏览器会报错，chrome浏览器会报错</li>
<li>可以通过<code>Number.MAX\_VALUE</code>访问最大值和<code>Number.MIN\_VALUE</code>访问最小值</li>
</ul>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> num1 = <span class="number">0123</span> <span class="comment">// 十进制</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> num2 = <span class="number">0b1011</span> <span class="comment">// 二进制</span></span><br><span class="line"><span class="keyword">var</span> num3 = 0b112011 <span class="comment">// 二进制最高为1，会报错: Invalid or unexpected token</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> num4 = <span class="number">0o12376</span> <span class="comment">// 八进制</span></span><br><span class="line"><span class="keyword">var</span> num5 = 0o7899222 <span class="comment">// 八进制最高为7，会报错: Invalid or unexpected token</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> num6 = <span class="number">0x2177</span> <span class="comment">// 十六进制</span></span><br><span class="line"><span class="keyword">var</span> num7 = 0xEFR <span class="comment">//  十六进制最高为F，会报错: Invalid or unexpected token</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> num8 = <span class="number">.5</span> <span class="comment">// 浮点数，可以省略前面的0</span></span><br><span class="line"><span class="keyword">var</span> num9 = <span class="number">0.5</span> <span class="comment">//浮点数</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>NaN</code>即非数值，是一个特殊的数值，这个数值用于表示一个本来要返回数值的操作数未返回数值的情况</p>
</blockquote>
<blockquote>
<p>NaN有2个特殊的特点</p>
<ul>
<li>涉及到NaN的操作都会返回NaN</li>
<li>NaN和任何值都不相等，通过&#96;isNaN函数来判断是不是NaN</li>
</ul>
</blockquote>
<h4 id="String"><a href="#String" class="headerlink" title="String"></a>String</h4><p>该类型用于表示由零或多个16位Unicode字符组成的字符序列，即字符串。字符串可以由双引号（“）或单引号（‘）表示，因此这两种字符串的写法都是有效的</p>
<blockquote>
<p>string 类型比较特殊是存储在常量池中的， 常量池也算栈的一块内存空间，&#x2F;&#x2F;todo 想要深入了解常量池到可以参考<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/455421872">JS 的字符串如何分配内存</a>这篇文章</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> str = <span class="string">&#x27;test&#x27;</span> <span class="comment">// 单引号字符串</span></span><br><span class="line"><span class="keyword">var</span> str1 = <span class="string">&quot;test&quot;</span> <span class="comment">// 双引号字符串</span></span><br><span class="line"><span class="keyword">var</span> str2 = <span class="string">&#x27;test&quot; // 非合法字符串</span></span><br></pre></td></tr></table></figure>

<h4 id="Boolean"><a href="#Boolean" class="headerlink" title="Boolean"></a>Boolean</h4><p>该类型的字面值只有<code>true</code>和<code>false</code>是区分大小写的。也就是说.True和False(以及其他的混合大小写形式)都不是Boolean值，只是标识符</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> isSame = <span class="literal">true</span> <span class="comment">// 布尔值为true</span></span><br><span class="line"><span class="keyword">var</span> isValidate = <span class="literal">false</span> <span class="comment">// 布尔值为 false</span></span><br><span class="line"><span class="keyword">var</span> isNotBoolean = <span class="title class_">True</span> <span class="comment">// 不是布尔值，这是一个变量</span></span><br></pre></td></tr></table></figure>

<h4 id="Null"><a href="#Null" class="headerlink" title="Null"></a>Null</h4><p>该类型的字面量只有一个值，即null, 从逻辑上来讲null值表示一个空对象指针，<strong>这也正是使用<a href="#%E5%88%A4%E6%96%AD%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B">typeof</a> 操作符检测null时会返回</strong><code>object</code>的原因</p>
<blockquote>
<ul>
<li>通常在声明某个变量为对象类型时。默认初始化该值为null</li>
<li>null &#x3D;&#x3D; undefined为 true, null &#x3D;&#x3D;&#x3D; undefined 为 false</li>
</ul>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> obj = <span class="literal">null</span> <span class="comment">// Null的字面量为null</span></span><br></pre></td></tr></table></figure>

<h4 id="Undefined"><a href="#Undefined" class="headerlink" title="Undefined"></a>Undefined</h4><p>该类型只有一个值，即特殊的<code>undefined</code>, 在使用<code>let</code>,<code>var</code>关键词声明变量并为初始化时，这个变量的值就是undefined</p>
<blockquote>
<p>由于<code>undefined</code>作为<code>window</code>的全局属性，老版本浏览器可以进行修改，因此未获取正确的undefined时通常长长使用 <code>void 0</code>, 不知道为什么void 0 可以获取安全的undefined,可以参考<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_45709829/article/details/123795909">js冷知识void 0是什么？为什么比undefined好用？</a>这篇文章</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a <span class="comment">// undefined</span></span><br><span class="line"><span class="keyword">var</span> b = <span class="literal">undefined</span> <span class="comment">// Undefined的字面量为undefined</span></span><br></pre></td></tr></table></figure>

<h4 id="Bigint"><a href="#Bigint" class="headerlink" title="Bigint"></a>Bigint</h4><p>它提供了一种方法来表示大于 2^53 - 1 的整数。这原本是 Javascript 中可以用 Number 表示的最大数字。BigInt 可以表示任意大的整数, 通过数字后导n来进行创建,在实际开发中应用场景也比较少，就不详细介绍了，感兴趣的可以参考<a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/BigInt">MDN</a></p>
<blockquote>
<p>目前没有完美的兼容库来支持那些不能原生支持的浏览器， 兼容性比较差，实际应用场景也比较少</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> bigInter = <span class="number">1n</span> <span class="comment">// 创建了一个BigInt类型的字面量</span></span><br></pre></td></tr></table></figure>

<h3 id="引用数据类型-object-类型"><a href="#引用数据类型-object-类型" class="headerlink" title="引用数据类型 (object 类型)"></a>引用数据类型 (object 类型)</h3><p>对象类型其实就是一组数据和功能的集合，对象可以通过执行<code>new</code>操作符来创建<code>Object</code>类型的实例并为其添加属性或者方法，实际开发中我们比较常用通过字面量的形式来创建对象,<strong>对象的属性名只能是<code>字符串类型或symobl类型</code>，如果不是字符串类型或者symbol类型，那么会隐性转为字符串类型</strong></p>
<blockquote>
<p>对象中比较重要的考点，任何对象类型都会有这3个方法</p>
<ul>
<li><p>toString: 用来返回对象的字符串表示</p>
</li>
<li><p>valueOf: 用来返回对象的数值类型表示，通常情况下和toString()的返回值相同</p>
</li>
<li><p>constructor: 保存着用于创建当前对象的函数</p>
</li>
<li><p>这3个方法一定要记住，在类型转换中以及在面试中都是比较高频的考点</p>
</li>
</ul>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> obj = <span class="keyword">new</span> <span class="title class_">Object</span>() <span class="comment">// 通过new操作来创建对象</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 给对象添加方法</span></span><br><span class="line">obj.<span class="property">getAge</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line"> <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 给对象添加属性</span></span><br><span class="line">obj.<span class="property">age</span> = <span class="number">1</span></span><br><span class="line"></span><br><span class="line"> obj[<span class="title class_">Symbol</span>(<span class="string">&#x27;a&#x27;</span>)] = <span class="number">2</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="Symbol"><a href="#Symbol" class="headerlink" title="Symbol"></a>Symbol</h3><p>由于对象的属性或者方法存在可覆盖性，这就容易造成因为命名冲突而导致的覆盖，<code>symbol</code>能够保证每个属性或者方法的名字是独一无二的</p>
<blockquote>
<p>在Es6之前，无论对象的属性还是方法都是字符串类型进行保存，因此很容易引起命名冲突<br>symbol 本质上是一个特殊的对象类型，也是不能使用new操作符来进行创建的唯一对象</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">var</span> = <span class="title class_">Symbol</span>(<span class="string">&#x27;a&#x27;</span>)  <span class="comment">// 创建一个symbol的数据类型</span></span><br><span class="line"> <span class="comment">//</span></span><br><span class="line"><span class="keyword">var</span> b = <span class="keyword">new</span> <span class="title class_">Symbol</span>(<span class="string">&#x27;b&#x27;</span>) <span class="comment">// Symbol is not a constructor at new Symbol</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> obj = &#123;&#125;</span><br><span class="line"></span><br><span class="line">obj[<span class="title class_">Symbol</span>(<span class="string">&#x27;a&#x27;</span>)] = <span class="number">1</span></span><br><span class="line">obj[<span class="title class_">Symbol</span>(<span class="string">&#x27;a&#x27;</span>)] = <span class="number">2</span>  <span class="comment">// 对象的属性不会被覆盖</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id="判断数据类型"><a href="#判断数据类型" class="headerlink" title="判断数据类型"></a>判断数据类型</h3><p>上面我们对js常见的数据类型也做了简单理解，本节我们将学习如何使用<code>typeof</code>关键词来进行类型判断以及<code>typeof</code>能够进行类型判断的原理</p>
<blockquote>
<p>js是一门弱语言(变量可以随时持有任何类型的值)，它在声明变量时无需确定变量的类型，js在运行时会自动判断, 想要了解js运行时以及运行的环境可以参考<a target="_blank" rel="noopener" href="https://juejin.cn/post/7069408407626711048">JS runtime environment)</a></p>
</blockquote>
<p>typeof 作用于各种数据类型的返回值，如图所示</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c9b1d8af7d0c44c3a16d112a55b960b4~tplv-k3u1fbpfcp-watermark.image" alt="typeof返回值.jpg"></p>
<h4 id="typeof-底层原理"><a href="#typeof-底层原理" class="headerlink" title="typeof 底层原理"></a>typeof 底层原理</h4><p>不同的对象在底层都表示为二进制，在Javascript中二进制前（低）三位存储其类型信息。具体存储信息如图所示</p>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b5c618d5b27a4b8e9490a1e2f24a4c8d~tplv-k3u1fbpfcp-watermark.image" alt="js底层前三位存储标识.jpg"></p>
<p><strong>观察上面的表格我们可以获取很多有用的信息比如为什么typeof null 返回的是object，因为object类型是通过000进行存储</strong></p>
<blockquote>
<p>Symbol和BigInt的底层存储</p>
<ul>
<li>Symbol是使用c++实现的特殊对象，正常来讲的话应该也是000，具体的前三位存储信息的看源代码，有兴趣的话可以看一下源码<a target="_blank" rel="noopener" href="https://github.com/v8/v8">chrome V8源码</a></li>
<li>BigInt其实是比较特殊的整数，因此bigInt的前三位也是100,但是typeof如何去区分的话，有兴趣的可以看一下源码<a target="_blank" rel="noopener" href="https://github.com/search?q=repo:v8/v8%20typeof&type=code">chrome V8 typeof具体实现逻辑</a></li>
</ul>
</blockquote>
<h4 id="判断对象数据类型"><a href="#判断对象数据类型" class="headerlink" title="判断对象数据类型"></a>判断对象数据类型</h4><p>在实际使用过程中可能存在对对象数据类型的判断，我们可以使用<code>constructor</code>以及<code>instanceof</code>以及<code>Object.prototype.toString.call</code>,由于篇幅有限就不具体展开有兴趣的可以去参考[对象类型判读]这篇文章</p>
<h3 id="数据类型之间转换"><a href="#数据类型之间转换" class="headerlink" title="数据类型之间转换"></a>数据类型之间转换</h3><p>数据类型之间的转换不管在面试过程中还是实际开发过程使用的频率还是比较高的，因此这一块知识还是相当比较重要的</p>
<h4 id="Number类型与其他类型之间的转换"><a href="#Number类型与其他类型之间的转换" class="headerlink" title="Number类型与其他类型之间的转换"></a>Number类型与其他类型之间的转换</h4><p>在js中有三个函数可以把非数值类型转换为数值分为别为<code>parseInt()</code>、<code>parseFloat()</code>、<code>Number()</code>,前面2个转换规则比较简单，这里主要讲一下<code>Number</code>的转换规则</p>
<ul>
<li>Boolean类型，true转换为1，false转换为0</li>
<li>Undefined类型，转换为NaN</li>
<li>Null类型转换为0</li>
<li>如果是字符串的话有以下规则<ul>
<li>如果字符串中只包含数字那么将其转换为对应的字面量</li>
<li>字符串如果是空字符串那么转换为0</li>
<li>不符合以上规则的转换为NaN</li>
</ul>
</li>
<li>Object类型<ul>
<li>首先调用<code>valueOf</code>方法，如果返回的是基本数据类型，那么再使用以上基本数据类型的转换规则</li>
<li>如果valueOf方法返回的不是基本数据类型，那么会调用toString方法，如果返回的是基本数据类型，那么再使用以上基本数据类型的转换规则</li>
<li>如果<code>toString</code>方法返回的不是基本数据类型,那么会报错</li>
</ul>
</li>
<li>Symbol无法转换为number类型</li>
<li>BinInt会忽略后面的n</li>
</ul>
<blockquote>
<p>字符串中有前导0，那么会忽略前导0<br>Object转换为Number类型，本质上调的是<code>Symbol.toPrimitive</code>方法，我们可以重写该方法从而实现自己转换规则<br>实际开发过程中我们比较喜欢使用+隐性转换将其他类型转换为Number类型</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> num1 = <span class="title class_">Number</span>(<span class="string">&#x27;1223&#x27;</span>) <span class="comment">// 123</span></span><br><span class="line"><span class="keyword">var</span> num2 = <span class="title class_">Number</span>(<span class="string">&#x27;123aqq&#x27;</span>) <span class="comment">// NaN</span></span><br><span class="line"><span class="keyword">var</span> num3 = <span class="title class_">Number</span>(<span class="string">&#x27;&#x27;</span>) <span class="comment">// 0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> num4 = <span class="title class_">Number</span>(<span class="literal">true</span>) <span class="comment">// 1</span></span><br><span class="line"><span class="keyword">var</span> num5 = <span class="title class_">Number</span>(<span class="literal">false</span>) <span class="comment">// 0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> num6 = <span class="title class_">Number</span>(<span class="literal">null</span>) <span class="comment">// 0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> num7 = <span class="title class_">Number</span>(<span class="literal">undefined</span>) <span class="comment">// NaN</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> num8 = <span class="title class_">Number</span>(<span class="title class_">Symbol</span>(<span class="string">&#x27;a&#x27;</span>)) <span class="comment">// Cannot convert a Symbol value to a number at Number</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> num9 = <span class="title class_">Number</span>(<span class="number">2n</span>) <span class="comment">// 2</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> obj = &#123;&#125;</span><br><span class="line"><span class="keyword">var</span> num10 = <span class="title class_">Number</span>(obj) <span class="comment">// NaN</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 重写valueOf方法</span></span><br><span class="line">obj.<span class="property">valueOf</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">3</span></span><br><span class="line">&#125;</span><br><span class="line"> <span class="keyword">var</span> num11 = <span class="title class_">Number</span>(obj) <span class="comment">// 3</span></span><br><span class="line"></span><br><span class="line">obj.<span class="property">toString</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">2</span></span><br><span class="line">&#125;</span><br><span class="line"> <span class="keyword">var</span> num12 = <span class="title class_">Number</span>(obj) <span class="comment">// 2</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 重新改写toString</span></span><br><span class="line">obj.<span class="property">toString</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> num12 = <span class="title class_">Number</span>(obj) <span class="comment">//  Cannot convert object to primitive value at Number</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="String类型与其他类型之间的转换"><a href="#String类型与其他类型之间的转换" class="headerlink" title="String类型与其他类型之间的转换"></a>String类型与其他类型之间的转换</h4><p>在js中主要使用<code>toString()</code>、<code>String()</code>来进行将其他类型转为String类型, 两者转换规则相同</p>
<ul>
<li>Number类型直接转为对应的数字前面和后面分别加上引号</li>
<li>Boolean类型转换为对应的布尔值前面和后面加上引号</li>
<li>Undefined类型转换为对应的undefined前面和后面加上引号</li>
<li>Null类型转换为对应的undefined前面和后面加上引号</li>
<li>Object类型<ul>
<li>首先调用<code>toString</code>方法，如果返回的是基本数据类型，那么再使用以上基本数据类型的转换规则</li>
<li>如果toString方法返回的不是基本数据类型，那么会调用valueOf方法，如果返回的是基本数据类型，那么再使用以上基本数据类型的转换规则</li>
<li>如果<code>valueOf</code>方法返回的不是基本数据类型,那么会报错</li>
</ul>
</li>
<li>Symbol类型转换为对应symbol(‘xx’)前面和后面加上引号</li>
<li>BigInt转换时会忽略末尾的n，前面和后面加上引号</li>
</ul>
<blockquote>
<p>在转换为数字类型时优先调用好的是valueOf，而在这里优先调用的是toString，千万别记混了<br>一般来说更多的是String()方法因为可以兼容null和undefined<br>数字的toString方法能够支持传入一个参数，表示将数字转换为什么进制</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> str1 = <span class="title class_">String</span>(<span class="number">222</span>) <span class="comment">// &#x27;222&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> str2 = <span class="title class_">String</span>(<span class="literal">true</span>) <span class="comment">// &#x27;true&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> str3 = <span class="title class_">String</span>(<span class="literal">undefined</span>) <span class="comment">// &#x27;undefined&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> str4 = <span class="title class_">String</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> str5 = <span class="title class_">String</span>(<span class="title class_">Symbol</span>(<span class="string">&#x27;a&#x27;</span>)) <span class="comment">// &#x27;Symbol(&#x27;a&#x27;)&#x27;</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> str6 = <span class="title class_">Number</span>(<span class="number">2n</span>) <span class="comment">// &#x27;2&#x27;</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> obj = &#123;&#125;</span><br><span class="line">  <span class="keyword">var</span> str7 = <span class="title class_">String</span>(obj) <span class="comment">// NaN</span></span><br><span class="line"></span><br><span class="line">   <span class="comment">// 重新改写toString</span></span><br><span class="line">    obj.<span class="property">toString</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;2222&#x27;</span></span><br><span class="line">  &#125;</span><br><span class="line">   <span class="keyword">var</span> str8 = <span class="title class_">Number</span>(obj) <span class="comment">// &#x27;2222&#x27;</span></span><br><span class="line"></span><br><span class="line">obj.<span class="property">toString</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 重写valueOf方法</span></span><br><span class="line">  obj.<span class="property">valueOf</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;wwwr&#x27;</span></span><br><span class="line">  &#125;</span><br><span class="line">   <span class="keyword">var</span> str9 = <span class="title class_">String</span>(obj) <span class="comment">// wwwr</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 重新改写toString</span></span><br><span class="line">  obj.<span class="property">toString</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="keyword">var</span> num12 = <span class="title class_">String</span>(obj) <span class="comment">//  Cannot convert object to primitive value at String</span></span><br></pre></td></tr></table></figure>

<h4 id="Boolean类型与其他类型之间的转换"><a href="#Boolean类型与其他类型之间的转换" class="headerlink" title="Boolean类型与其他类型之间的转换"></a>Boolean类型与其他类型之间的转换</h4><p>在js中主要使用<code>Boolean()</code>来进行将其他类型转为<code>String</code>类型, 两者转换规则相同</p>
<ul>
<li>Number类型<ul>
<li>值为0转换为false</li>
<li>值为NaN转换为false</li>
<li>其他任何值转换为true</li>
</ul>
</li>
<li>String类型<ul>
<li>字符串长度为0转换false</li>
<li>字符串只要长度不为0转换为true</li>
</ul>
</li>
<li>Null类型转换为false</li>
<li>Undefined转换为false</li>
<li>Object类型转换为true</li>
<li>Symbol转换为true</li>
<li>BigInt类型<ul>
<li>0n转换为false</li>
<li>其他任何值为true</li>
</ul>
</li>
</ul>
<blockquote>
<p>其他类型转换为Boolean类型本质上是执行的内部的<code>toBoolean</code>方法，该方法不可见</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> boolean1 = <span class="title class_">Boolean</span>(<span class="number">0</span>) <span class="comment">// false</span></span><br><span class="line"><span class="keyword">var</span> boolean2 = <span class="title class_">Boolean</span>(<span class="number">1</span>) <span class="comment">// true</span></span><br><span class="line"><span class="keyword">var</span> boolean3 = <span class="title class_">Boolean</span>(<span class="title class_">NaN</span>) <span class="comment">// false</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> boolean4 = <span class="title class_">Boolean</span>(<span class="string">&#x27;&#x27;</span>) <span class="comment">// false</span></span><br><span class="line"><span class="keyword">var</span> boolean5 = <span class="title class_">Boolean</span>(<span class="string">&#x27;boolean&#x27;</span>) <span class="comment">// true</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> boolean6 = <span class="title class_">Boolean</span>(<span class="literal">undefined</span>) <span class="comment">// false</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> boolean7 = <span class="title class_">Boolean</span>(<span class="literal">null</span>) <span class="comment">// false</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> obj = &#123;&#125;</span><br><span class="line"><span class="keyword">var</span> boolean8 = <span class="title class_">Boolean</span>(obj) <span class="comment">// true</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> boolean9 = <span class="title class_">Boolean</span>(<span class="title class_">Symbol</span>(<span class="string">&#x27;a&#x27;</span>)) <span class="comment">// true</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> boolean10 = <span class="title class_">Boolean</span>(<span class="number">0n</span>) <span class="comment">// false</span></span><br><span class="line"><span class="keyword">var</span> boolean11 = <span class="title class_">Boolean</span>(<span class="number">1n</span>) <span class="comment">// true</span></span><br></pre></td></tr></table></figure>

<h4 id="对象类型和其他类型之间的转换"><a href="#对象类型和其他类型之间的转换" class="headerlink" title="对象类型和其他类型之间的转换"></a>对象类型和其他类型之间的转换</h4><p>其他数据类型可以通过new操作符加上首字母大写的构造函数来创建对象，除<code>null</code>和<code>undefined</code>以外或者使用 <code>new + Object()</code>来创建对象</p>
<ul>
<li><p>Number类型: new + Number(xxx)</p>
</li>
<li><p>String类型 new + String(xxx)</p>
</li>
<li><p>Boolean类型 new + Boolean(false | true)</p>
</li>
<li><p>Undefined没有对应的构造函数,可以采用 new Object(undefined)</p>
</li>
<li><p>Null类型没有对应的构造函数, 可以采用 new Object(undefined)</p>
</li>
<li><p>Symbol类型 没有对应的构造函数，可以采用 new Object(Symbol(xx))</p>
</li>
<li><p>BigInt类型 new + BigInt(xxx)</p>
<blockquote>
<p>以上首字母大写的构造函数也叫做某某类型的包装类型，重写了Object对应的ValueOf和toString方法,返回值为传入构造函数对应的值<br>在js中也存在一些假值对象,当然本身这是不合理的比如<code>document.all</code>对象，为什么这么是因为ie存在使用一些注释来判断ie环境</p>
</blockquote>
</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> obj1 = <span class="keyword">new</span> <span class="title class_">Number</span>(<span class="number">222</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> obj2 = <span class="keyword">new</span> <span class="title class_">String</span>(<span class="string">&#x27;str&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> obj3 = <span class="keyword">new</span> <span class="title class_">Boolean</span>(<span class="literal">true</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> obj4 = <span class="keyword">new</span> <span class="title class_">Object</span>(<span class="literal">undefined</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> obj5 = <span class="keyword">new</span> <span class="title class_">Object</span>(<span class="literal">null</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> obj6 = <span class="keyword">new</span> <span class="title class_">Object</span>(<span class="title class_">Symbol</span>(<span class="string">&#x27;a&#x27;</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> obj7 = <span class="keyword">new</span> <span class="title class_">BigInt</span>(<span class="number">2n</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<hr>
<h3 id="回答开篇"><a href="#回答开篇" class="headerlink" title="回答开篇"></a>回答开篇</h3><p>在看本节时经过自己前面的学习看看自己现在是否能够进行回答开篇问题</p>
<hr>
<ul>
<li>基本数据类型和引用数据类型有什么区别</br> <strong>根据赋值操作是否赋值为地址值还是真正的值</strong></li>
<li>字符串长度为什么确定了就不能再修改</br> <strong>字符串是基础数据类型，数据类型在声明的时候就确定了内存大小</strong></li>
<li><code>0b1</code>, <code>0x1</code> 为什么表示的是数字，不是字符串</br> <strong>js数字类型二进制，八进制的字面量表示方法</strong></li>
<li>为什么基本数据类型是存储在栈中，引用数据类型是存储在堆中的</br> <strong>基本数据类型大小确定，引用数据类型大小不确定</strong></li>
<li>什么时候使用null，什么时候使用undefined <strong>某个对象将被赋值为对象类型时，将该变量进行初始化为<code>null</code>，<code>undefined</code>不需要赋初始值，只声明，默认为<code>undefined</code></strong></li>
<li>给基本数据类型定义了方法和属性不生效？</br><strong>基本数据类型在使用属性或者方法时会先转换为对应的包装类型，但很快该对象就别销毁了，下一次访问某个属性本质上是又重新重新创建了一个新的对象</strong></li>
<li>假值对象是什么</bar><strong>IE浏览器自己作妖，为了做一些特殊操作，遗留下来的问题</strong></li>
<li>typeof是根据什么原理区分数据类型的 </br><strong><code>typeof</code>根据底层存储二进制前三位来区分类型</strong></li>
<li>0.1 + 0.2 为什么不等于0.3 </br><strong>数字采用<code>EE754</code>来存储，导致在存储的过程中精度丢失</strong></li>
<li>对象数据类型什么时候<code>valueOf</code>优先于<code>toString</code> </br><strong>在转换为数字类型或者在进行数学运算时</strong></li>
<li>对象类型什么时候<code>toString</code>优先于<code>valueOf</code></br><strong>在转换为字符串类型或者在进行字符串拼接时</strong></li>
<li>obj + 1 如何才能等于2 </br><strong>改写该对象的valueOf方法使其返回值为1或者改写</strong><code>Symbol.toPrimitive</code></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://imperial-long.github.io/blog/2022/03/01/%E6%A8%A1%E5%9D%97%E5%8C%96%E8%BF%9B%E9%98%B6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="朱广龙">
      <meta itemprop="description" content="定期会更新前端技术栈 不限于vue，react，node以及部分后端的知识">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="朱广龙的个人博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2022/03/01/%E6%A8%A1%E5%9D%97%E5%8C%96%E8%BF%9B%E9%98%B6/" class="post-title-link" itemprop="url">模块化进阶</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-03-01 20:39:00" itemprop="dateCreated datePublished" datetime="2022-03-01T20:39:00+08:00">2022-03-01</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-10-10 12:33:50" itemprop="dateModified" datetime="2024-10-10T12:33:50+08:00">2024-10-10</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="js-模块化进阶"><a href="#js-模块化进阶" class="headerlink" title="js 模块化进阶"></a>js 模块化进阶</h1><p>对编译原理不熟悉的建议可以将探秘esmoudle放在熟悉编译相关知识以后再来看探秘esmoudle</p>
<h2 id="js-模块发展历程"><a href="#js-模块发展历程" class="headerlink" title="js 模块发展历程"></a>js 模块发展历程</h2><h3 id="浏览器加载script"><a href="#浏览器加载script" class="headerlink" title="浏览器加载script"></a>浏览器加载script</h3><p>在浏览器发展早期通过srcpit标签进行加载外部嵌入的script以及html页面内部书写js</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 页面内嵌的脚本 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;application/javascript&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 外部脚本 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;application/javascript&quot;</span> <span class="attr">src</span>=<span class="string">&quot;./zgl.js&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>  浏览器是同步加载 JavaScript 脚本,边下script脚本的内容边解析,即渲染引擎遇到标签就会停下来，等到执行完脚本，再继续向下渲染。如果是外部脚本，还必须加入脚本下载的时间</p>
<p>  如果脚本体积很大，下载和执行的时间就会很长，如果script标签中存在比较耗时的任务，</p>
<p>  因此造成浏览器堵塞，就会导致白屏时间变长甚至会页面崩溃，用户会感觉到浏览器“卡死”了</p>
<p> 我们是否能够延迟script标签的解析时间或者等待html解析完毕以后再去解析script标签呢？答案是可以的.</p>
<p>浏览器提供了script标签异步加载方案</p>
<h3 id="async"><a href="#async" class="headerlink" title="async"></a>async</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;./zgl.js&quot;</span> <span class="attr">async</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>上面代码中如果浏览器解析script标签的时候遇到了async,那么渲染引擎会忽略当前script标签的解析，但是并不会暂停对当前script脚本的下载，直到当前脚本下载完毕以后会停止对html的解析，然后去解析已经下载完毕的script标签的内容，等待script内容解析完再继续去解析html</p>
<h3 id="defer"><a href="#defer" class="headerlink" title="defer"></a>defer</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;./zgl.js&quot;</span> <span class="attr">defer</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>​      上面代码中如果浏览器解析script的时候遇到了defer，那么渲染引擎会忽略当前script标签的解析，但是并不会暂停对当前script脚本的下载，直到都没解析完毕以后，然后按照下载脚本书写的顺序去解析已经下载完毕的脚本</p>
<h3 id="动态加载script脚本信息"><a href="#动态加载script脚本信息" class="headerlink" title="动态加载script脚本信息"></a>动态加载script脚本信息</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">const script = document.createElement(&#x27;script&#x27;);</span><br><span class="line"></span><br><span class="line">window.onload = function () &#123;</span><br><span class="line">  script.src = &#x27;./zgl/js&#x27;;</span><br><span class="line">  document.body.appendChild(script)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面代码中等待浏览器解析html完成以后，然后再去执行脚本的下载以及解析</p>
<h3 id="IIFE"><a href="#IIFE" class="headerlink" title="IIFE"></a>IIFE</h3><p>由于script脚本在加载过程中可能会存在多个不一样的脚本中命名会发生覆盖的问题,就会产生命名冲突，我们是否有一种方式能够解决当前模块只能访问当前模块的变量，不能让其他模块中变量进行对当前模块的变量进行覆盖呢?答案是有的，我们可以利用js执行上下所产生的闭包来解决模块命名问题</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> moduleA = (<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;zgl&#x27;</span>，</span><br><span class="line">    <span class="attr">age</span>: <span class="number">26</span>，</span><br><span class="line">    <span class="title function_">getName</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">name</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)();</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> moduleB = (<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;zgl&#x27;</span>，</span><br><span class="line">    <span class="attr">age</span>: <span class="number">26</span>，</span><br><span class="line">    <span class="title function_">getName</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">name</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 由于js闭包的关系，模块只能访问模块内部的变量</span></span><br></pre></td></tr></table></figure>

<p>上面代码利用js的执行上下文规则有效的解决变量覆盖以及变量冲突带来的一些问题</p>
<h2 id="探秘现代模块化"><a href="#探秘现代模块化" class="headerlink" title="探秘现代模块化"></a>探秘现代模块化</h2><p>模块进行加载的方案主要科研归为编译时加载和运行时加载，</p>
<p>大部分语言都选择了运行加载接下来我们分析一下为什么选择会编译时</p>
<h5 id="编译时加载的优点"><a href="#编译时加载的优点" class="headerlink" title="编译时加载的优点"></a>编译时加载的优点</h5><ul>
<li>编译时加载能够提早发现一些错误，而不用等到运行时，比如引用的时候能够及时发现当前引用的路径是否正确以及引用的名称是否正确等。</li>
<li>编译时能够删除某些没有使用的模块，比如某些模块引用了但是实际并没有使用到当前模块可以进行删除。</li>
<li>编译时能够对引用的模块进行优化, 比如A模块中暴露了a,b2个变量，而实际引用的时候，其实只引用了a变量，那么b变量相关的代码可以被优化掉</li>
<li>编译时能够提前给模块分配内存，而不用等到运行时分配内存，内存分配不够的问题也能在编译中提前解决</li>
<li>能够提前发现模块之间的依赖关系以及是否存在循环问题</li>
</ul>
<h5 id="运行时加载的优点"><a href="#运行时加载的优点" class="headerlink" title="运行时加载的优点"></a>运行时加载的优点</h5><ul>
<li>能够在任何地方(比如函数中)进行模块的引用，使用方式比较灵活没有任何约束</li>
</ul>
<h2 id="探秘commonjs"><a href="#探秘commonjs" class="headerlink" title="探秘commonjs"></a>探秘commonjs</h2><p>伴随着nodejs的兴起，模块化越来越成为一个亟待解决的问题，到底应该怎么去解决呢?	</p>
<p>接下来我们一起去探索一下commonjs是怎么实现的以及为什么这么去实现</p>
<ul>
<li>难点—:  加载方式是同步的还是异步的？</li>
<li>难点二:  加载时机是运行时还是编译时(ps: 不懂的可以去问度娘)</li>
<li>难点三:  如何解决模块与模块之间的循环问题</li>
<li>难点四: 如何定义模块的暴露方式以及引用方式</li>
</ul>
<p>由于nodejs主要是<code>I/O密集型</code>的，也就是说主要是用来读取文件，操作文件等，并不涉及到页面的渲染，以及服务器提供的资源相较于浏览器是比较充分的，因此为了降低实现难度选择了<code>同步的加载方式</code></p>
<h5 id="加载时机是由语法决定的"><a href="#加载时机是由语法决定的" class="headerlink" title="加载时机是由语法决定的"></a>加载时机是由语法决定的</h5><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 第一种语法</span></span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> fileContent = fs.<span class="title function_">readFileSync</span>(<span class="string">&#x27;./a.js&#x27;</span>, &#123; <span class="attr">encoding</span>: <span class="string">&#x27;utf-8&#x27;</span>&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 第二种语法</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">readFile</span>(<span class="params">filePath</span>) &#123;</span><br><span class="line">  cons fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>);</span><br><span class="line">  <span class="keyword">const</span> fileContent = fs.<span class="title function_">readFileSync</span>(<span class="string">&#x27;./a.js&#x27;</span>, &#123; <span class="attr">encoding</span>: <span class="string">&#x27;utf-8&#x27;</span> &#125;);</span><br><span class="line">  <span class="keyword">return</span> fileContent;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="node模块的加载时机"><a href="#node模块的加载时机" class="headerlink" title="node模块的加载时机"></a>node模块的加载时机</h5><p>上述罗列了编译进行加载的优点，那么nodejs为什么放弃编译时而选择运行时呢？</p>
<p>nodejs需要提供像第二段代码这样的使用方式，是编译时做不到的。编译时并不能提前去加载某个函数中引用了某个模块,因此只能选择运行时</p>
<h5 id="模块与模块的循环引用问题"><a href="#模块与模块的循环引用问题" class="headerlink" title="模块与模块的循环引用问题"></a>模块与模块的循环引用问题</h5><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// a.js</span></span><br><span class="line"> <span class="keyword">const</span> b = <span class="built_in">require</span>(<span class="string">&quot;./b.js&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// b.js</span></span><br><span class="line"><span class="keyword">const</span> a = <span class="built_in">require</span>(<span class="string">&#x27;./a.js&#x27;</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>循环加载:  2个模块或者多个模块之间存在强耦合关系，相互之间引用，可能会导致递归加载依赖，使程序崩溃</p>
<p>循环引用带来的危害是比较大的，那么我们如何去避免加载循环引用呢</p>
<p>我们先来看一段代码</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//创建一个存在循环引用的对象</span></span><br><span class="line"><span class="keyword">const</span> moduleA = &#123;</span><br><span class="line">  <span class="attr">b</span>: <span class="string">&#x27;zgl&#x27;</span></span><br><span class="line">&#125;;</span><br><span class="line">moduleA.<span class="property">b</span> = moduleA;</span><br><span class="line"></span><br><span class="line"><span class="title class_">JSON</span>.<span class="title function_">stringify</span>(moduleA) <span class="comment">// TypeError: Converting circular structure to JSON</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 那么我们应该如何去解决在json序列化过程中产生的循环引用问题呢</span></span><br><span class="line"><span class="comment">// 其实我们只要去比对当前对象是否已经被遍历过，如果当前对象被遍历过，我们就应该停止对当前的对象</span></span><br><span class="line"><span class="comment">// 可以使用一个数组去缓存已经被遍历的引用数据类型，下一次遍历的时候先判断缓存中是否存在，如果存在说明已经被遍历过，停止对引用数据类型的遍历</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>上述代码注释向我们阐述了如何解决在json序列化的过程中存在循环引用问题，那么我们能否借鉴到模块循环引用的问题上呢</p>
<p>当然是可以的</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 缓存模块</span></span><br><span class="line"><span class="keyword">const</span> modules = [ ];</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">require</span>(<span class="params"><span class="variable language_">module</span></span>) &#123;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">const</span> index = modules.<span class="title function_">indexOf</span>(<span class="variable language_">module</span>);</span><br><span class="line">  <span class="keyword">if</span> (index &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    modules.<span class="title function_">push</span>(<span class="variable language_">module</span>);</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">return</span> modules[index];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>&#x2F;&#x2F; 我们来分析一下上面的这段代码存在什么问题呢</p>
<p>第一个问题: 判断当前模块是否在缓存中的时间复杂度为n</p>
<p>第二个问题: 无法判断当前模块是否加载阶段还是其他阶段</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> modules = &#123;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">require</span>(<span class="params"><span class="variable language_">module</span></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; id &#125; = <span class="variable language_">module</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 增加loaded属性用于判断模块是否被加载过</span></span><br><span class="line">  <span class="keyword">if</span> (!<span class="variable language_">module</span>.<span class="property">loaded</span>) &#123;</span><br><span class="line">    <span class="variable language_">module</span>.<span class="property">loaded</span> = <span class="literal">true</span>;</span><br><span class="line">    modules[id] = <span class="variable language_">module</span>;</span><br><span class="line">  &#125;;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 降低当前模块在缓存中查找的时间复杂度，从O(n)降低为O(1);</span></span><br><span class="line">  <span class="keyword">if</span> (id <span class="keyword">in</span> <span class="variable language_">module</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> modules[id]</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="variable language_">module</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>为了解决第二个问题我们引入了一个变量用来判断当前模块是否被加载过以及改变使用对象进行缓存降低查找的复杂度</p>
<p>我们从上面这段代码能够分析出来模块对象必须拥有一个属性用来表示是否被加载过以及模块的唯一的标识</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 模块对象</span></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">Module</span>  &#123;</span><br><span class="line">  <span class="attr">loaded</span>: <span class="built_in">boolean</span>;</span><br><span class="line">  <span class="attr">id</span>: <span class="built_in">string</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过上述手段我们已经成功的解决了模块循环的问题，简单的概括为如果当前模块第一次加载那么就会被缓存，下次读取的时候就会从缓存中进行读取，而不会第二次继续加载当前模块</p>
<h5 id="如何暴露模块和引用模块"><a href="#如何暴露模块和引用模块" class="headerlink" title="如何暴露模块和引用模块"></a>如何暴露模块和引用模块</h5><p>其实这也是一个最好解决的问题，就是通过定制一套规范,比如nodejs定义了通过module.export进行暴露，以及require进行引用</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// a.js</span></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;zgl&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> name = <span class="built_in">require</span>(<span class="string">&#x27;./a.js&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>但是这种书写格式太死板了并不符合node能够灵活书写的方式，因此又想出了一个巧妙的方法</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">exports</span>.<span class="property">name</span> = <span class="string">&#x27;zgl&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> name = <span class="built_in">require</span>(<span class="string">&#x27;./a.js&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>上述存在一个问题，由于一开始就定义了require引用的数据是来自module.exports，那么这样是不是违背了初衷,如果exports和module.exports存在不同数据，那么引用的是谁的数据的呢,得想办法解决</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="built_in">exports</span></span><br></pre></td></tr></table></figure>

<p>通过简单的复制就解决了这个问题</p>
<p>那么我们现在还剩一个require没有进行实现了, 接下来需要去实现require, require的逻辑其实很简单</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">require</span>(<span class="params"><span class="variable language_">module</span>, <span class="built_in">exports</span></span>) &#123;&#125;;</span><br></pre></td></tr></table></figure>

<p>我们目前已经实现了模块的导入以及模块导出的逻辑</p>
<p>还有一个很关键的问题如何解决模块与模块之间的隔离问题，答案其实也很简单就是使用一个函数</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(<span class="keyword">function</span> (<span class="params"><span class="variable language_">module</span>,<span class="built_in">exports</span>, <span class="built_in">require</span></span>))(<span class="variable language_">module</span>,<span class="built_in">exports</span>, <span class="built_in">require</span>)；</span><br></pre></td></tr></table></figure>

<h5 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h5><p>至此我们已经完全解析完了commonjs的具体实现，简单回顾一下: 首先确定加载时机和如何暴露模块以及如何引用模块，模块之间的数据隔离</p>
<h2 id="探秘esmodule"><a href="#探秘esmodule" class="headerlink" title="探秘esmodule"></a>探秘esmodule</h2><p>我们来思考一个问题，我们能不能直接在浏览器中使用commomjs呢</p>
<p>答案是否定的，理由如下</p>
<ul>
<li>js脚本会阻塞浏览器渲染进程解析html</li>
<li>浏览器提供给js使用的资源比较少</li>
<li>js文件不能过大</li>
<li>报错信息需要在编译时确定</li>
</ul>
<p>我们发现commojs如果需要在浏览器中使用，必须解决的问题</p>
<ul>
<li>模块需要支持异步加载</li>
<li>需要充分利用模块中导出的数据</li>
<li>模块相关的报错信息不能出现在运行时</li>
</ul>
<p>我们反过来去思考如果需要对commonjs进行改造的成本是比较大的,但是我们发现要解决的问题如果将编译时机进行提前到编译时是不是也就解决了这些问题，因此决定浏览器的模块加载方式决定采用编译时</p>
<h3 id="如何将代码进行编译"><a href="#如何将代码进行编译" class="headerlink" title="如何将代码进行编译"></a>如何将代码进行编译</h3><p>我们可以采用业界比较通用的手段将可执行代码进行编译成抽象语法树</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; parse &#125; <span class="keyword">from</span> <span class="string">&#x27;@babel/parser&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> hasParsers = <span class="title function_">parse</span>(str, &#123;<span class="attr">sourceType</span>: <span class="string">&#x27;module&#x27;</span>&#125;);</span><br></pre></td></tr></table></figure>

<p>我们上面借助于babel提供的插件进行将可执行代码转为了抽象语法树</p>
<h3 id="模块的加载时机是什么时候"><a href="#模块的加载时机是什么时候" class="headerlink" title="模块的加载时机是什么时候"></a>模块的加载时机是什么时候</h3><p>如果我们从一开始通过深度优先遍历的时候就将模块进行缓存其实是不合理的一件事，缓存是需要一定的内存消耗的，但是浏览器提供我们的内存开销非常有限，也就是我们只能选择运行时才去解析模块的内容</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span>  traverse <span class="keyword">from</span> <span class="string">&#x27;@babel/traverse&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> getPeopleName <span class="keyword">from</span> <span class="string">&#x27;./a.js&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> t = traverse.<span class="property">default</span>;</span><br><span class="line"></span><br><span class="line"><span class="title function_">t</span>(hasParsers, &#123;</span><br><span class="line">  <span class="title function_">enter</span>(<span class="params">path</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (path.<span class="title function_">isFunctionDeclaration</span>(getPeopleName)) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(path.<span class="property">node</span>, <span class="string">&#x27;222222&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>​	我们上面借助于babel实现了需要时才去解析对应的模块</p>
<h3 id="模块与模块的循环问题"><a href="#模块与模块的循环问题" class="headerlink" title="模块与模块的循环问题"></a>模块与模块的循环问题</h3><p>其实由于时运行是才去解析的模块其实产生模块循环的概率其实是微乎其微的，可解决或者不解决，现代模块化规范中是没有进行解决的</p>
<h3 id="如何暴露模块和引用模块-1"><a href="#如何暴露模块和引用模块-1" class="headerlink" title="如何暴露模块和引用模块"></a>如何暴露模块和引用模块</h3><p>参考现有比较成熟的java语言的模块化导入关键词,采用import进行模块化的引用</p>
<p>参考node的模块化导出模式采用 export default 和export进行模块的导出</p>
<h3 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h3><p>esmodule主要采用在代码编译阶段时初始化每个模块之间的依赖关系，在代码执行时再进行依赖的寻找</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/blog/page/2/">2</a><a class="extend next" rel="next" href="/blog/page/2/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">朱广龙</p>
  <div class="site-description" itemprop="description">定期会更新前端技术栈 不限于vue，react，node以及部分后端的知识</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/blog/archives/">
        
          <span class="site-state-item-count">11</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">8</span>
        <span class="site-state-item-name">tags</span>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">朱广龙</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/blog/lib/anime.min.js"></script>
  <script src="/blog/lib/velocity/velocity.min.js"></script>
  <script src="/blog/lib/velocity/velocity.ui.min.js"></script>

<script src="/blog/js/utils.js"></script>

<script src="/blog/js/motion.js"></script>


<script src="/blog/js/schemes/muse.js"></script>


<script src="/blog/js/next-boot.js"></script>




  















  

  

</body>
</html>
